<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)] | ğŸ”ï¸ MLOps Journey</title>
<meta name=keywords content><meta name=description content="í•«ìŠ¤ì™‘ ê³ ë„í™”: /reload ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™

ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,
ì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€
ê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” /reloadë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,
í•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
ì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ğŸ¯ í•µì‹¬ ìš”ì•½

ë³´ì•ˆ 3ì¢…: x-token(SealedSecret) + Ingress IP whitelist + TLS
ìë™í™”: Airflow Train â†’ Register â†’ Sensor(READY) â†’ Reload ì „ì²´ ì‹œí€€ìŠ¤
ì¼ê´€ì„±: MLflow Alias(@A/@B) ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘
ê´€ì œ: ëª¨ë“  ë‹¨ê³„ ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨ Slack ì•Œë¦¼


í™˜ê²½ ë¶„ë¦¬: dev(.local) / prod(.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod"><meta name=author content><link rel=canonical href=https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/02/><link crossorigin=anonymous href=/mlops-journey/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://keonhoban.github.io/mlops-journey/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://keonhoban.github.io/mlops-journey/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://keonhoban.github.io/mlops-journey/favicon-32x32.png><link rel=apple-touch-icon href=https://keonhoban.github.io/mlops-journey/apple-touch-icon.png><link rel=mask-icon href=https://keonhoban.github.io/mlops-journey/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/02/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/02/"><meta property="og:site_name" content="ğŸ”ï¸  MLOps Journey"><meta property="og:title" content="[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)]"><meta property="og:description" content="í•«ìŠ¤ì™‘ ê³ ë„í™”: /reload ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™ ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,
ì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€
ê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” /reloadë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,
í•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
ì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ğŸ¯ í•µì‹¬ ìš”ì•½ ë³´ì•ˆ 3ì¢…: x-token(SealedSecret) + Ingress IP whitelist + TLS ìë™í™”: Airflow Train â†’ Register â†’ Sensor(READY) â†’ Reload ì „ì²´ ì‹œí€€ìŠ¤ ì¼ê´€ì„±: MLflow Alias(@A/@B) ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘ ê´€ì œ: ëª¨ë“  ë‹¨ê³„ ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨ Slack ì•Œë¦¼ í™˜ê²½ ë¶„ë¦¬: dev(.local) / prod(.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod"><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-22T12:10:21+09:00"><meta property="article:modified_time" content="2025-07-22T12:10:21+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)]"><meta name=twitter:description content="í•«ìŠ¤ì™‘ ê³ ë„í™”: /reload ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™

ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,
ì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€
ê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” /reloadë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,
í•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
ì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ğŸ¯ í•µì‹¬ ìš”ì•½

ë³´ì•ˆ 3ì¢…: x-token(SealedSecret) + Ingress IP whitelist + TLS
ìë™í™”: Airflow Train â†’ Register â†’ Sensor(READY) â†’ Reload ì „ì²´ ì‹œí€€ìŠ¤
ì¼ê´€ì„±: MLflow Alias(@A/@B) ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘
ê´€ì œ: ëª¨ë“  ë‹¨ê³„ ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨ Slack ì•Œë¦¼


í™˜ê²½ ë¶„ë¦¬: dev(.local) / prod(.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://keonhoban.github.io/mlops-journey/posts/"},{"@type":"ListItem","position":2,"name":"[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)]","item":"https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/02/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)]","name":"[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (\/reload ë³´ì•ˆÂ·DAG ìë™í™”)]","description":"í•«ìŠ¤ì™‘ ê³ ë„í™”: /reload ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™ ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,\nì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€\nê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” /reloadë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,\ní•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.\nì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\nğŸ¯ í•µì‹¬ ìš”ì•½ ë³´ì•ˆ 3ì¢…: x-token(SealedSecret) + Ingress IP whitelist + TLS ìë™í™”: Airflow Train â†’ Register â†’ Sensor(READY) â†’ Reload ì „ì²´ ì‹œí€€ìŠ¤ ì¼ê´€ì„±: MLflow Alias(@A/@B) ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘ ê´€ì œ: ëª¨ë“  ë‹¨ê³„ ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨ Slack ì•Œë¦¼ í™˜ê²½ ë¶„ë¦¬: dev(.local) / prod(.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod\n","keywords":[],"articleBody":"í•«ìŠ¤ì™‘ ê³ ë„í™”: /reload ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™ ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,\nì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€\nê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” /reloadë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,\ní•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.\nì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\nğŸ¯ í•µì‹¬ ìš”ì•½ ë³´ì•ˆ 3ì¢…: x-token(SealedSecret) + Ingress IP whitelist + TLS ìë™í™”: Airflow Train â†’ Register â†’ Sensor(READY) â†’ Reload ì „ì²´ ì‹œí€€ìŠ¤ ì¼ê´€ì„±: MLflow Alias(@A/@B) ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘ ê´€ì œ: ëª¨ë“  ë‹¨ê³„ ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨ Slack ì•Œë¦¼ í™˜ê²½ ë¶„ë¦¬: dev(.local) / prod(.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod\n1ï¸âƒ£ ì•„í‚¤í…ì²˜ í”Œë¡œìš° sequenceDiagram autonumber participant AF as Airflow DAG participant TM as train_model (í•™ìŠµ) participant RG as register_model (ë“±ë¡/alias ì§€ì •) participant SN as check_model_ready (READY Sensor) participant RL as trigger_reload (FastAPI í˜¸ì¶œ) participant IG as Ingress (TLS + IP whitelist) participant FA as FastAPI (/variant/{alias}/reload) participant MF as MLflow Registry (Alias) participant SL as Slack AF-\u003e\u003eTM: train_model(acc, run_id) AF-\u003e\u003eAF: check_result(threshold ë¶„ê¸°) AF-\u003e\u003eRG: register_model(run_id, alias) AF-\u003e\u003eSN: check_model_ready(model_name, version) AF-\u003e\u003eRL: trigger_reload(alias, x-token) RL-\u003e\u003eIG: POST https://fastapi.{env}/variant/{alias}/reload IG-\u003e\u003eFA: routes/reload.py (x-token ê²€ì¦) FA-\u003e\u003eMF: Alias(@A/@B) ê¸°ì¤€ ë¡œë”© FA--\u003e\u003eRL: {\"status\":\"success\", version, run_id} AF--\u003e\u003eSL: ë‹¨ê³„ë³„ Slack FA--\u003e\u003eSL: í•«ìŠ¤ì™‘ ì„±ê³µ/ì‹¤íŒ¨ 2ï¸âƒ£ FastAPI /reload ë³´ì•ˆ ë¼ìš°íŠ¸ # charts/fastapi/app/routes/reload.py import secrets from fastapi import APIRouter, HTTPException, Header, Request from core.config import settings from services.model_loader import load_model_by_alias from utils.slack_alerts import send_slack_alert router = APIRouter() @router.post(\"/variant/{alias}/reload\") def reload_model(request: Request, alias: str, x_token: str = Header(...)): expected = settings.reload_secret_token if not expected: raise HTTPException(status_code=500, detail=\"ì„œë²„ ì„¤ì • ì˜¤ë¥˜: ì¸ì¦ í† í° ë¯¸ì„¤ì •\") if not secrets.compare_digest(x_token, expected): raise HTTPException(status_code=403, detail=\"Access denied\") loaded = load_model_by_alias(alias) if not loaded: raise HTTPException(status_code=500, detail=\"ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨\") request.app.state.models[alias] = loaded info = loaded[\"info\"] send_slack_alert( f\"ğŸ” [FastAPI] ëª¨ë¸ {alias} í•«ìŠ¤ì™‘ ì™„ë£Œ: v{info['version']}, run_id={info['run_id']}\" ) return {\"status\": \"success\", \"variant\": alias, \"version\": info[\"version\"], \"run_id\": info[\"run_id\"]} 3ï¸âƒ£ Airflow DAG (Train â†’ Register â†’ Sensor â†’ Reload) # dags/dag_ml_train_register_reload.py from airflow import DAG from airflow.operators.python import PythonOperator, BranchPythonOperator from airflow.sensors.python import PythonSensor from airflow.utils.trigger_rule import TriggerRule from airflow.exceptions import AirflowSkipException from airflow.models import Variable from datetime import datetime, timedelta from pendulum import timezone from ml_code.train_model import train_model from ml_code.register_model import register_model from ml_code.rollback_model import rollback_model from ml_code.trigger_reload import trigger_reload from ml_code.sensor_model_ready import check_model_ready from utils.slack_alerts import send_slack_alert, alert_slack from mlflow.tracking import MlflowClient kst = timezone(\"Asia/Seoul\") default_args = {\"start_date\": datetime(2025, 1, 1, tzinfo=kst), \"retries\": 1, \"retry_delay\": timedelta(minutes=2)} def get_param(key, default, cast, validate=None): try: val = cast(Variable.get(key, default=str(default))) if validate and not validate(val): raise ValueError(\"Validation failed\") return val except Exception as e: send_slack_alert(f\"[Param] {key} ë¡œë”© ì‹¤íŒ¨: {e} â†’ ê¸°ë³¸ {default} ì‚¬ìš©\") return default def get_version_by_alias(model_name, alias): try: return MlflowClient().get_model_version_by_alias(model_name, alias).version except Exception: return None def train_and_evaluate(ti, **_): C = get_param(\"logreg_C\", 1.0, float, lambda x: 0.001 \u003c= x \u003c= 10.0) max_iter = get_param(\"logreg_max_iter\", 200, int, lambda x: x \u003e 50) threshold = get_param(\"accuracy_threshold\", 0.9, float, lambda x: 0.5 \u003c= x \u003c= 0.99) model_name = Variable.get(\"model_name\") alias = Variable.get(\"mlflow_alias\") if not (model_name and alias): raise ValueError(\"í•„ìˆ˜ Variable ëˆ„ë½: model_name ë˜ëŠ” mlflow_alias\") acc, run_id = train_model(C=C, max_iter=max_iter) if not run_id: raise ValueError(\"run_id ì—†ìŒ â†’ í•™ìŠµ ì‹¤íŒ¨\") for k, v in {\"run_id\": run_id, \"model_name\": model_name, \"alias\": alias, \"acc\": acc, \"threshold\": threshold}.items(): ti.xcom_push(key=k, value=v) def check_result(ti, **_): acc = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"acc\") thr = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"threshold\") if acc is None or thr is None: send_slack_alert(\"âŒ check_result â†’ XCom ëˆ„ë½\") raise AirflowSkipException() return \"register_model\" if acc \u003e= thr else \"notify_failure\" def register_model_task(ti, **_): run_id = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"run_id\") model_name = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"model_name\") alias = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"alias\") prev = get_version_by_alias(model_name, alias) try: version = register_model(run_id, model_name, alias) ti.xcom_push(key=\"version\", value=version) send_slack_alert(f\"âœ… ë“±ë¡ ì™„ë£Œ: {model_name} v{version} â†’ @{alias} (run_id={run_id})\") except Exception as e: msg = f\"âŒ ë“±ë¡ ì‹¤íŒ¨: {e}\" if prev: rollback_model(model_name, prev, alias) msg += f\" â†’ ë¡¤ë°± v{prev}\" else: msg += \" â†’ ë¡¤ë°± ìƒëµ\" send_slack_alert(msg) raise def sensor_ready_func(ti, **_): model_name = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"model_name\") version = ti.xcom_pull(task_ids=\"register_model\", key=\"version\") return check_model_ready(model_name, version) def trigger_reload_task(ti, **_): alias = ti.xcom_pull(task_ids=\"train_and_evaluate\", key=\"alias\") try: resp = trigger_reload(alias) # {\"status\":\"success\", ...} ê¸°ëŒ€ send_slack_alert(f\"ğŸ” í•«ìŠ¤ì™‘ ì™„ë£Œ: @{alias} â†’ {resp}\") except Exception as e: send_slack_alert(f\"âŒ í•«ìŠ¤ì™‘ ì‹¤íŒ¨: {e}\") raise def notify_failure(): send_slack_alert(\"âš ï¸ ê¸°ì¤€ ë¯¸ë‹¬ â†’ ë“±ë¡/í•«ìŠ¤ì™‘ ìƒëµ\") with DAG( dag_id=\"ml_train_register_and_reload\", default_args=default_args, schedule=None, catchup=False, tags=[\"mlops\", \"train\", \"sensor\", \"reload\"], on_failure_callback=alert_slack, ) as dag: train = PythonOperator(task_id=\"train_and_evaluate\", python_callable=train_and_evaluate) branch = BranchPythonOperator(task_id=\"check_result\", python_callable=check_result) register = PythonOperator(task_id=\"register_model\", python_callable=register_model_task) sensor = PythonSensor(task_id=\"check_model_ready\", python_callable=sensor_ready_func, poke_interval=10, timeout=180, mode=\"reschedule\") reload = PythonOperator(task_id=\"trigger_reload\", python_callable=trigger_reload_task, trigger_rule=TriggerRule.ALL_SUCCESS) failure = PythonOperator(task_id=\"notify_failure\", python_callable=notify_failure, trigger_rule=TriggerRule.NONE_FAILED_MIN_ONE_SUCCESS) train \u003e\u003e branch branch \u003e\u003e [register, failure] register \u003e\u003e sensor \u003e\u003e reload 4ï¸âƒ£ Airflow â†’ FastAPI í˜¸ì¶œ (Ingress ê²½ìœ ) # ml_code/trigger_reload.py import os, requests from airflow.models import Variable def trigger_reload(alias: str): base = ( os.getenv(\"FASTAPI_RELOAD_URL\") or os.getenv(\"FASTAPI_BASE_URL\") or Variable.get(\"FASTAPI_RELOAD_URL\", default_var=None) or Variable.get(\"FASTAPI_BASE_URL\") ) token = os.getenv(\"RELOAD_SECRET_TOKEN\") or Variable.get(\"RELOAD_SECRET_TOKEN\") url = f\"{base}/variant/{alias}/reload\" # self-signed í™˜ê²½ì´ë©´ ì‹ ë¢° ë£¨íŠ¸ êµ¬ì„± ë˜ëŠ” verify=False verify = not url.startswith(\"https://\") or os.getenv(\"ALLOW_SELF_SIGNED\") != \"true\" r = requests.post(url, headers={\"x-token\": token}, timeout=10, verify=verify) r.raise_for_status() data = r.json() if data.get(\"status\") != \"success\": raise RuntimeError(f\"Reload failed: {data}\") return {\"alias\": alias, \"version\": data.get(\"version\"), \"run_id\": data.get(\"run_id\")} 5ï¸âƒ£ Helm/ê°’ ìš”ì•½ (dev/prod) â–¶ FastAPI (env) MLFLOW_TRACKING_URI: dev: http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000 prod: http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000 MODEL_NAME=best_model ALIAS_SELECTION_MODE / DEFAULT_ALIAS / CANARY_PERCENT envFrom: aws-credentials-secret, fastapi-token-*-secret, slack-webhook-*-secret â–¶ Airflow (env/variables) FASTAPI_RELOAD_URL\ndev: https://fastapi.local prod: https://fastapi.prod AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL\ndev: http://airflow.local prod: http://airflow.prod MLFLOW_TRACKING_URI\ndev: http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000 prod: http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000 Airflow Variables:\nmodel_name, mlflow_alias, logreg_C, logreg_max_iter, accuracy_threshold\n6ï¸âƒ£ Slack ì•Œë¦¼ í‘œì¤€ êµ¬ë¶„ ë°œìƒ ì‹œì  ë©”ì‹œì§€ í•„ë“œ(ì˜ˆì‹œ) í•™ìŠµ ê¸°ì¤€ ë¯¸ë‹¬ notify_failure acc, threshold ë“±ë¡ ì„±ê³µ/ì‹¤íŒ¨ register_model_task model, version, @alias, run_id, (ì‹¤íŒ¨ ì‹œ ë¡¤ë°±) ì„¼ì„œ check_model_ready status (READY/FAILED_REGISTRATION) í•«ìŠ¤ì™‘ trigger_reload \u0026 FastAPI alias, version, run_id ì „ì—­ ì‹¤íŒ¨ on_failure_callback dag_id, task_id, log_url 7ï¸âƒ£ ê²€ì¦ ëª…ë ¹ # Ingress(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸/TLS/host) kubectl -n fastapi-dev get ing -o yaml | egrep 'ingressClassName|whitelist-source-range|host:' # Airflow â†’ FastAPI í˜¸ì¶œ í™˜ê²½ NS=airflow-dev POD=$(kubectl -n $NS get po -l component=scheduler -o name | head -1) kubectl -n $NS exec $POD -- printenv | egrep 'FASTAPI_RELOAD_URL|RELOAD_SECRET_TOKEN|AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL' # í•«ìŠ¤ì™‘ í˜¸ì¶œ curl -sk -X POST https://fastapi.local/variant/B/reload -H \"x-token: \" ğŸ ì •ë¦¬ /reload ë³´ì•ˆ 3ì¢… + DAG ìë™í™”ê°€ í•˜ë‚˜ì˜ í‘œì¤€ í”Œë¡œìš°ë¡œ ì •ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.\nMLflow Aliasë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë“±ë¡Â·ê°ì‹œÂ·í•«ìŠ¤ì™‘ì´ ì¼ê´€ë˜ê²Œ ì´ì–´ì§€ë©°, Slackìœ¼ë¡œ ì „ ê³¼ì •ì´ ê°€ì‹œí™”ë©ë‹ˆë‹¤.\n","wordCount":"959","inLanguage":"en","datePublished":"2025-07-22T12:10:21+09:00","dateModified":"2025-07-22T12:10:21+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/02/"},"publisher":{"@type":"Organization","name":"ğŸ”ï¸  MLOps Journey","logo":{"@type":"ImageObject","url":"https://keonhoban.github.io/mlops-journey/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://keonhoban.github.io/mlops-journey/ accesskey=h title="ğŸ”ï¸  MLOps Journey (Alt + H)">ğŸ”ï¸ MLOps Journey</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://keonhoban.github.io/mlops-journey/ title="ğŸ  Home"><span>ğŸ  Home</span></a></li><li><a href=https://keonhoban.github.io/mlops-journey/projects/ title="ğŸ“‚ Projects"><span>ğŸ“‚ Projects</span></a></li><li><a href=https://keonhoban.github.io/mlops-journey/posts/ title="ğŸ“ Blog"><span>ğŸ“ Blog</span></a></li><li><a href=https://keonhoban.github.io/mlops-journey/about/ title="ğŸ§— About"><span>ğŸ§— About</span></a></li><li><a href=https://keonhoban.github.io/mlops-journey/categories/ title="ğŸ“– Categories"><span>ğŸ“– Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://keonhoban.github.io/mlops-journey/>Home</a>&nbsp;Â»&nbsp;<a href=https://keonhoban.github.io/mlops-journey/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[MLOps ìš´ì˜ ê³ ë„í™” - 1ë‹¨ê³„: í•«ìŠ¤ì™‘ ê³ ë„í™” (/reload ë³´ì•ˆÂ·DAG ìë™í™”)]</h1><div class=post-meta><span title='2025-07-22 12:10:21 +0900 +0900'>July 22, 2025</span>&nbsp;Â·&nbsp;5 min</div></header><div class=post-content><h2 id=í•«ìŠ¤ì™‘-ê³ ë„í™”-reload-ë³´ì•ˆ-ê°•í™”--dag-ìë™í™”-ì—°ë™>í•«ìŠ¤ì™‘ ê³ ë„í™”: <code>/reload</code> ë³´ì•ˆ ê°•í™” + DAG ìë™í™” ì—°ë™<a hidden class=anchor aria-hidden=true href=#í•«ìŠ¤ì™‘-ê³ ë„í™”-reload-ë³´ì•ˆ-ê°•í™”--dag-ìë™í™”-ì—°ë™>#</a></h2><hr><h2 id=-ì‹œë‚˜ë¦¬ì˜¤-ì„¤ëª…>ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…<a hidden class=anchor aria-hidden=true href=#-ì‹œë‚˜ë¦¬ì˜¤-ì„¤ëª…>#</a></h2><blockquote><p>â€œëª¨ë¸ì„ ì˜ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ì§€ë§Œ,</p><p>ì˜ëª»ëœ ëª¨ë¸ì´ ì‹¤ìˆ˜ë¡œ í•«ìŠ¤ì™‘ë˜ëŠ” ìˆœê°„ì´ ë” ì¹˜ëª…ì ì…ë‹ˆë‹¤.â€</p><p>ê·¸ë˜ì„œ 1ë‹¨ê³„ì—ì„œëŠ” <code>/reload</code>ë¥¼ í™•ì‹¤í•˜ê²Œ ì ê·¸ê³ ,</p><p><strong>í•™ìŠµ â†’ ë“±ë¡ â†’ ê°ì‹œ â†’ í•«ìŠ¤ì™‘</strong>ê¹Œì§€ê°€ Airflowì—ì„œ ìë™ìœ¼ë¡œ í˜ëŸ¬ê°€ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.</p><p>ì´ ë‹¨ê³„ê°€ ì™„ì„±ë¼ì•¼ ì´í›„ ë‹¨ê³„ì—ì„œ **ì•ˆì „í•œ ìë™ ìš´ì˜(MLOps)**ì„ êµ¬í˜„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p></blockquote><hr><h2 id=-í•µì‹¬-ìš”ì•½>ğŸ¯ í•µì‹¬ ìš”ì•½<a hidden class=anchor aria-hidden=true href=#-í•µì‹¬-ìš”ì•½>#</a></h2><ul><li><strong>ë³´ì•ˆ 3ì¢…</strong>: <code>x-token</code>(SealedSecret) + Ingress <strong>IP whitelist</strong> + <strong>TLS</strong></li><li><strong>ìë™í™”</strong>: Airflow <strong>Train â†’ Register â†’ Sensor(READY) â†’ Reload</strong> ì „ì²´ ì‹œí€€ìŠ¤</li><li><strong>ì¼ê´€ì„±</strong>: MLflow <strong>Alias(@A/@B)</strong> ê¸°ë°˜ ë“±ë¡Â·ì¡°íšŒÂ·í•«ìŠ¤ì™‘</li><li><strong>ê´€ì œ</strong>: ëª¨ë“  ë‹¨ê³„ <strong>ì„±ê³µ/ìŠ¤í‚µ/ì‹¤íŒ¨</strong> Slack ì•Œë¦¼</li></ul><blockquote><p>í™˜ê²½ ë¶„ë¦¬: dev(<em>.local) / prod(</em>.prod) â€” ì˜ˆ: fastapi.local, fastapi.prod</p></blockquote><hr><h2 id=1-ì•„í‚¤í…ì²˜-í”Œë¡œìš°>1ï¸âƒ£ ì•„í‚¤í…ì²˜ í”Œë¡œìš°<a hidden class=anchor aria-hidden=true href=#1-ì•„í‚¤í…ì²˜-í”Œë¡œìš°>#</a></h2><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    autonumber
    participant AF as Airflow DAG
    participant TM as train_model (í•™ìŠµ)
    participant RG as register_model (ë“±ë¡/alias ì§€ì •)
    participant SN as check_model_ready (READY Sensor)
    participant RL as trigger_reload (FastAPI í˜¸ì¶œ)
    participant IG as Ingress (TLS + IP whitelist)
    participant FA as FastAPI (/variant/{alias}/reload)
    participant MF as MLflow Registry (Alias)
    participant SL as Slack

    AF-&gt;&gt;TM: train_model(acc, run_id)
    AF-&gt;&gt;AF: check_result(threshold ë¶„ê¸°)
    AF-&gt;&gt;RG: register_model(run_id, alias)
    AF-&gt;&gt;SN: check_model_ready(model_name, version)
    AF-&gt;&gt;RL: trigger_reload(alias, x-token)
    RL-&gt;&gt;IG: POST https://fastapi.{env}/variant/{alias}/reload
    IG-&gt;&gt;FA: routes/reload.py (x-token ê²€ì¦)
    FA-&gt;&gt;MF: Alias(@A/@B) ê¸°ì¤€ ë¡œë”©
    FA--&gt;&gt;RL: {&#34;status&#34;:&#34;success&#34;, version, run_id}
    AF--&gt;&gt;SL: ë‹¨ê³„ë³„ Slack
    FA--&gt;&gt;SL: í•«ìŠ¤ì™‘ ì„±ê³µ/ì‹¤íŒ¨
</code></pre><hr><h2 id=2-fastapi-reload-ë³´ì•ˆ-ë¼ìš°íŠ¸>2ï¸âƒ£ FastAPI <code>/reload</code> ë³´ì•ˆ ë¼ìš°íŠ¸<a hidden class=anchor aria-hidden=true href=#2-fastapi-reload-ë³´ì•ˆ-ë¼ìš°íŠ¸>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># charts/fastapi/app/routes/reload.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> secrets
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> APIRouter, HTTPException, Header, Request
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> core.config <span style=color:#f92672>import</span> settings
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> services.model_loader <span style=color:#f92672>import</span> load_model_by_alias
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> utils.slack_alerts <span style=color:#f92672>import</span> send_slack_alert
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>router <span style=color:#f92672>=</span> APIRouter()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.post</span>(<span style=color:#e6db74>&#34;/variant/</span><span style=color:#e6db74>{alias}</span><span style=color:#e6db74>/reload&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reload_model</span>(request: Request, alias: str, x_token: str <span style=color:#f92672>=</span> Header(<span style=color:#f92672>...</span>)):
</span></span><span style=display:flex><span>    expected <span style=color:#f92672>=</span> settings<span style=color:#f92672>.</span>reload_secret_token
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> expected:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ì„œë²„ ì„¤ì • ì˜¤ë¥˜: ì¸ì¦ í† í° ë¯¸ì„¤ì •&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> secrets<span style=color:#f92672>.</span>compare_digest(x_token, expected):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>403</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Access denied&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    loaded <span style=color:#f92672>=</span> load_model_by_alias(alias)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> loaded:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    request<span style=color:#f92672>.</span>app<span style=color:#f92672>.</span>state<span style=color:#f92672>.</span>models[alias] <span style=color:#f92672>=</span> loaded
</span></span><span style=display:flex><span>    info <span style=color:#f92672>=</span> loaded[<span style=color:#e6db74>&#34;info&#34;</span>]
</span></span><span style=display:flex><span>    send_slack_alert(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ğŸ” [FastAPI] ëª¨ë¸ </span><span style=color:#e6db74>{</span>alias<span style=color:#e6db74>}</span><span style=color:#e6db74> í•«ìŠ¤ì™‘ ì™„ë£Œ: v</span><span style=color:#e6db74>{</span>info[<span style=color:#e6db74>&#39;version&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>, run_id=</span><span style=color:#e6db74>{</span>info[<span style=color:#e6db74>&#39;run_id&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;success&#34;</span>, <span style=color:#e6db74>&#34;variant&#34;</span>: alias, <span style=color:#e6db74>&#34;version&#34;</span>: info[<span style=color:#e6db74>&#34;version&#34;</span>], <span style=color:#e6db74>&#34;run_id&#34;</span>: info[<span style=color:#e6db74>&#34;run_id&#34;</span>]}
</span></span></code></pre></div><hr><h2 id=3-airflow-dag-train--register--sensor--reload>3ï¸âƒ£ Airflow DAG (Train â†’ Register â†’ Sensor â†’ Reload)<a hidden class=anchor aria-hidden=true href=#3-airflow-dag-train--register--sensor--reload>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># dags/dag_ml_train_register_reload.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow <span style=color:#f92672>import</span> DAG
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.operators.python <span style=color:#f92672>import</span> PythonOperator, BranchPythonOperator
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.sensors.python <span style=color:#f92672>import</span> PythonSensor
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.utils.trigger_rule <span style=color:#f92672>import</span> TriggerRule
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.exceptions <span style=color:#f92672>import</span> AirflowSkipException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.models <span style=color:#f92672>import</span> Variable
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, timedelta
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pendulum <span style=color:#f92672>import</span> timezone
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ml_code.train_model <span style=color:#f92672>import</span> train_model
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ml_code.register_model <span style=color:#f92672>import</span> register_model
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ml_code.rollback_model <span style=color:#f92672>import</span> rollback_model
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ml_code.trigger_reload <span style=color:#f92672>import</span> trigger_reload
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ml_code.sensor_model_ready <span style=color:#f92672>import</span> check_model_ready
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> utils.slack_alerts <span style=color:#f92672>import</span> send_slack_alert, alert_slack
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> mlflow.tracking <span style=color:#f92672>import</span> MlflowClient
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kst <span style=color:#f92672>=</span> timezone(<span style=color:#e6db74>&#34;Asia/Seoul&#34;</span>)
</span></span><span style=display:flex><span>default_args <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;start_date&#34;</span>: datetime(<span style=color:#ae81ff>2025</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, tzinfo<span style=color:#f92672>=</span>kst), <span style=color:#e6db74>&#34;retries&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;retry_delay&#34;</span>: timedelta(minutes<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_param</span>(key, default, cast, validate<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> cast(Variable<span style=color:#f92672>.</span>get(key, default<span style=color:#f92672>=</span>str(default)))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> validate <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> validate(val):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Validation failed&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> val
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        send_slack_alert(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[Param] </span><span style=color:#e6db74>{</span>key<span style=color:#e6db74>}</span><span style=color:#e6db74> ë¡œë”© ì‹¤íŒ¨: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74> â†’ ê¸°ë³¸ </span><span style=color:#e6db74>{</span>default<span style=color:#e6db74>}</span><span style=color:#e6db74> ì‚¬ìš©&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_version_by_alias</span>(model_name, alias):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> MlflowClient()<span style=color:#f92672>.</span>get_model_version_by_alias(model_name, alias)<span style=color:#f92672>.</span>version
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>train_and_evaluate</span>(ti, <span style=color:#f92672>**</span>_):
</span></span><span style=display:flex><span>    C <span style=color:#f92672>=</span> get_param(<span style=color:#e6db74>&#34;logreg_C&#34;</span>, <span style=color:#ae81ff>1.0</span>, float, <span style=color:#66d9ef>lambda</span> x: <span style=color:#ae81ff>0.001</span> <span style=color:#f92672>&lt;=</span> x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10.0</span>)
</span></span><span style=display:flex><span>    max_iter <span style=color:#f92672>=</span> get_param(<span style=color:#e6db74>&#34;logreg_max_iter&#34;</span>, <span style=color:#ae81ff>200</span>, int, <span style=color:#66d9ef>lambda</span> x: x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span>    threshold <span style=color:#f92672>=</span> get_param(<span style=color:#e6db74>&#34;accuracy_threshold&#34;</span>, <span style=color:#ae81ff>0.9</span>, float, <span style=color:#66d9ef>lambda</span> x: <span style=color:#ae81ff>0.5</span> <span style=color:#f92672>&lt;=</span> x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0.99</span>)
</span></span><span style=display:flex><span>    model_name <span style=color:#f92672>=</span> Variable<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;model_name&#34;</span>)
</span></span><span style=display:flex><span>    alias <span style=color:#f92672>=</span> Variable<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;mlflow_alias&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> (model_name <span style=color:#f92672>and</span> alias):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;í•„ìˆ˜ Variable ëˆ„ë½: model_name ë˜ëŠ” mlflow_alias&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    acc, run_id <span style=color:#f92672>=</span> train_model(C<span style=color:#f92672>=</span>C, max_iter<span style=color:#f92672>=</span>max_iter)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> run_id:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;run_id ì—†ìŒ â†’ í•™ìŠµ ì‹¤íŒ¨&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> k, v <span style=color:#f92672>in</span> {<span style=color:#e6db74>&#34;run_id&#34;</span>: run_id, <span style=color:#e6db74>&#34;model_name&#34;</span>: model_name, <span style=color:#e6db74>&#34;alias&#34;</span>: alias, <span style=color:#e6db74>&#34;acc&#34;</span>: acc, <span style=color:#e6db74>&#34;threshold&#34;</span>: threshold}<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        ti<span style=color:#f92672>.</span>xcom_push(key<span style=color:#f92672>=</span>k, value<span style=color:#f92672>=</span>v)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_result</span>(ti, <span style=color:#f92672>**</span>_):
</span></span><span style=display:flex><span>    acc <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;acc&#34;</span>)
</span></span><span style=display:flex><span>    thr <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;threshold&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> acc <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>or</span> thr <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        send_slack_alert(<span style=color:#e6db74>&#34;âŒ check_result â†’ XCom ëˆ„ë½&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> AirflowSkipException()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;register_model&#34;</span> <span style=color:#66d9ef>if</span> acc <span style=color:#f92672>&gt;=</span> thr <span style=color:#66d9ef>else</span> <span style=color:#e6db74>&#34;notify_failure&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_model_task</span>(ti, <span style=color:#f92672>**</span>_):
</span></span><span style=display:flex><span>    run_id <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;run_id&#34;</span>)
</span></span><span style=display:flex><span>    model_name <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;model_name&#34;</span>)
</span></span><span style=display:flex><span>    alias <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;alias&#34;</span>)
</span></span><span style=display:flex><span>    prev <span style=color:#f92672>=</span> get_version_by_alias(model_name, alias)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        version <span style=color:#f92672>=</span> register_model(run_id, model_name, alias)
</span></span><span style=display:flex><span>        ti<span style=color:#f92672>.</span>xcom_push(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;version&#34;</span>, value<span style=color:#f92672>=</span>version)
</span></span><span style=display:flex><span>        send_slack_alert(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;âœ… ë“±ë¡ ì™„ë£Œ: </span><span style=color:#e6db74>{</span>model_name<span style=color:#e6db74>}</span><span style=color:#e6db74> v</span><span style=color:#e6db74>{</span>version<span style=color:#e6db74>}</span><span style=color:#e6db74> â†’ @</span><span style=color:#e6db74>{</span>alias<span style=color:#e6db74>}</span><span style=color:#e6db74> (run_id=</span><span style=color:#e6db74>{</span>run_id<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;âŒ ë“±ë¡ ì‹¤íŒ¨: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> prev:
</span></span><span style=display:flex><span>            rollback_model(model_name, prev, alias)
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; â†’ ë¡¤ë°± v</span><span style=color:#e6db74>{</span>prev<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34; â†’ ë¡¤ë°± ìƒëµ&#34;</span>
</span></span><span style=display:flex><span>        send_slack_alert(msg)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sensor_ready_func</span>(ti, <span style=color:#f92672>**</span>_):
</span></span><span style=display:flex><span>    model_name <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;model_name&#34;</span>)
</span></span><span style=display:flex><span>    version <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;register_model&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;version&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> check_model_ready(model_name, version)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>trigger_reload_task</span>(ti, <span style=color:#f92672>**</span>_):
</span></span><span style=display:flex><span>    alias <span style=color:#f92672>=</span> ti<span style=color:#f92672>.</span>xcom_pull(task_ids<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;alias&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> trigger_reload(alias)  <span style=color:#75715e># {&#34;status&#34;:&#34;success&#34;, ...} ê¸°ëŒ€</span>
</span></span><span style=display:flex><span>        send_slack_alert(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ğŸ” í•«ìŠ¤ì™‘ ì™„ë£Œ: @</span><span style=color:#e6db74>{</span>alias<span style=color:#e6db74>}</span><span style=color:#e6db74> â†’ </span><span style=color:#e6db74>{</span>resp<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        send_slack_alert(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;âŒ í•«ìŠ¤ì™‘ ì‹¤íŒ¨: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>notify_failure</span>():
</span></span><span style=display:flex><span>    send_slack_alert(<span style=color:#e6db74>&#34;âš ï¸ ê¸°ì¤€ ë¯¸ë‹¬ â†’ ë“±ë¡/í•«ìŠ¤ì™‘ ìƒëµ&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> DAG(
</span></span><span style=display:flex><span>    dag_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ml_train_register_and_reload&#34;</span>,
</span></span><span style=display:flex><span>    default_args<span style=color:#f92672>=</span>default_args,
</span></span><span style=display:flex><span>    schedule<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    catchup<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>    tags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;mlops&#34;</span>, <span style=color:#e6db74>&#34;train&#34;</span>, <span style=color:#e6db74>&#34;sensor&#34;</span>, <span style=color:#e6db74>&#34;reload&#34;</span>],
</span></span><span style=display:flex><span>    on_failure_callback<span style=color:#f92672>=</span>alert_slack,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>as</span> dag:
</span></span><span style=display:flex><span>    train <span style=color:#f92672>=</span> PythonOperator(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;train_and_evaluate&#34;</span>, python_callable<span style=color:#f92672>=</span>train_and_evaluate)
</span></span><span style=display:flex><span>    branch <span style=color:#f92672>=</span> BranchPythonOperator(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;check_result&#34;</span>, python_callable<span style=color:#f92672>=</span>check_result)
</span></span><span style=display:flex><span>    register <span style=color:#f92672>=</span> PythonOperator(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;register_model&#34;</span>, python_callable<span style=color:#f92672>=</span>register_model_task)
</span></span><span style=display:flex><span>    sensor <span style=color:#f92672>=</span> PythonSensor(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;check_model_ready&#34;</span>, python_callable<span style=color:#f92672>=</span>sensor_ready_func, poke_interval<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>180</span>, mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;reschedule&#34;</span>)
</span></span><span style=display:flex><span>    reload <span style=color:#f92672>=</span> PythonOperator(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;trigger_reload&#34;</span>, python_callable<span style=color:#f92672>=</span>trigger_reload_task, trigger_rule<span style=color:#f92672>=</span>TriggerRule<span style=color:#f92672>.</span>ALL_SUCCESS)
</span></span><span style=display:flex><span>    failure <span style=color:#f92672>=</span> PythonOperator(task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;notify_failure&#34;</span>, python_callable<span style=color:#f92672>=</span>notify_failure, trigger_rule<span style=color:#f92672>=</span>TriggerRule<span style=color:#f92672>.</span>NONE_FAILED_MIN_ONE_SUCCESS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    train <span style=color:#f92672>&gt;&gt;</span> branch
</span></span><span style=display:flex><span>    branch <span style=color:#f92672>&gt;&gt;</span> [register, failure]
</span></span><span style=display:flex><span>    register <span style=color:#f92672>&gt;&gt;</span> sensor <span style=color:#f92672>&gt;&gt;</span> reload
</span></span></code></pre></div><hr><h2 id=4-airflow--fastapi-í˜¸ì¶œ-ingress-ê²½ìœ >4ï¸âƒ£ Airflow â†’ FastAPI í˜¸ì¶œ (Ingress ê²½ìœ )<a hidden class=anchor aria-hidden=true href=#4-airflow--fastapi-í˜¸ì¶œ-ingress-ê²½ìœ >#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># ml_code/trigger_reload.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> airflow.models <span style=color:#f92672>import</span> Variable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>trigger_reload</span>(alias: str):
</span></span><span style=display:flex><span>    base <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;FASTAPI_RELOAD_URL&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>or</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;FASTAPI_BASE_URL&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>or</span> Variable<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;FASTAPI_RELOAD_URL&#34;</span>, default_var<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>or</span> Variable<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;FASTAPI_BASE_URL&#34;</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;RELOAD_SECRET_TOKEN&#34;</span>) <span style=color:#f92672>or</span> Variable<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;RELOAD_SECRET_TOKEN&#34;</span>)
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>base<span style=color:#e6db74>}</span><span style=color:#e6db74>/variant/</span><span style=color:#e6db74>{</span>alias<span style=color:#e6db74>}</span><span style=color:#e6db74>/reload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># self-signed í™˜ê²½ì´ë©´ ì‹ ë¢° ë£¨íŠ¸ êµ¬ì„± ë˜ëŠ” verify=False</span>
</span></span><span style=display:flex><span>    verify <span style=color:#f92672>=</span> <span style=color:#f92672>not</span> url<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;https://&#34;</span>) <span style=color:#f92672>or</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;ALLOW_SELF_SIGNED&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url, headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;x-token&#34;</span>: token}, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, verify<span style=color:#f92672>=</span>verify)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>raise_for_status()
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;status&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;success&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Reload failed: </span><span style=color:#e6db74>{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;alias&#34;</span>: alias, <span style=color:#e6db74>&#34;version&#34;</span>: data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;version&#34;</span>), <span style=color:#e6db74>&#34;run_id&#34;</span>: data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;run_id&#34;</span>)}
</span></span></code></pre></div><hr><h2 id=5-helmê°’-ìš”ì•½-devprod>5ï¸âƒ£ Helm/ê°’ ìš”ì•½ (dev/prod)<a hidden class=anchor aria-hidden=true href=#5-helmê°’-ìš”ì•½-devprod>#</a></h2><h3 id=-fastapi-env>â–¶ FastAPI (env)<a hidden class=anchor aria-hidden=true href=#-fastapi-env>#</a></h3><ul><li><code>MLFLOW_TRACKING_URI</code>:<ul><li>dev: <code>http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000</code></li><li>prod: <code>http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000</code></li></ul></li><li><code>MODEL_NAME=best_model</code></li><li><code>ALIAS_SELECTION_MODE</code> / <code>DEFAULT_ALIAS</code> / <code>CANARY_PERCENT</code></li><li><code>envFrom</code>: <code>aws-credentials-secret</code>, <code>fastapi-token-*-secret</code>, <code>slack-webhook-*-secret</code></li></ul><h3 id=-airflow-envvariables>â–¶ Airflow (env/variables)<a hidden class=anchor aria-hidden=true href=#-airflow-envvariables>#</a></h3><ul><li><p><code>FASTAPI_RELOAD_URL</code></p><ul><li>dev: <code>https://fastapi.local</code></li><li>prod: <code>https://fastapi.prod</code></li></ul></li><li><p><code>AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL</code></p><ul><li>dev: <code>http://airflow.local</code></li><li>prod: <code>http://airflow.prod</code></li></ul></li><li><p><code>MLFLOW_TRACKING_URI</code></p><ul><li>dev: <code>http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000</code></li><li>prod: <code>http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000</code></li></ul></li><li><p>Airflow Variables:</p><p><code>model_name</code>, <code>mlflow_alias</code>, <code>logreg_C</code>, <code>logreg_max_iter</code>, <code>accuracy_threshold</code></p></li></ul><hr><h2 id=6-slack-ì•Œë¦¼-í‘œì¤€>6ï¸âƒ£ Slack ì•Œë¦¼ í‘œì¤€<a hidden class=anchor aria-hidden=true href=#6-slack-ì•Œë¦¼-í‘œì¤€>#</a></h2><table><thead><tr><th>êµ¬ë¶„</th><th>ë°œìƒ ì‹œì </th><th>ë©”ì‹œì§€ í•„ë“œ(ì˜ˆì‹œ)</th></tr></thead><tbody><tr><td>í•™ìŠµ ê¸°ì¤€ ë¯¸ë‹¬</td><td><code>notify_failure</code></td><td><code>acc</code>, <code>threshold</code></td></tr><tr><td>ë“±ë¡ ì„±ê³µ/ì‹¤íŒ¨</td><td><code>register_model_task</code></td><td><code>model</code>, <code>version</code>, <code>@alias</code>, <code>run_id</code>, (ì‹¤íŒ¨ ì‹œ ë¡¤ë°±)</td></tr><tr><td>ì„¼ì„œ</td><td><code>check_model_ready</code></td><td><code>status</code> (READY/FAILED_REGISTRATION)</td></tr><tr><td>í•«ìŠ¤ì™‘</td><td><code>trigger_reload</code> & FastAPI</td><td><code>alias</code>, <code>version</code>, <code>run_id</code></td></tr><tr><td>ì „ì—­ ì‹¤íŒ¨</td><td><code>on_failure_callback</code></td><td><code>dag_id</code>, <code>task_id</code>, <code>log_url</code></td></tr></tbody></table><hr><h2 id=7-ê²€ì¦-ëª…ë ¹>7ï¸âƒ£ ê²€ì¦ ëª…ë ¹<a hidden class=anchor aria-hidden=true href=#7-ê²€ì¦-ëª…ë ¹>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Ingress(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸/TLS/host)</span>
</span></span><span style=display:flex><span>kubectl -n fastapi-dev get ing -o yaml | egrep <span style=color:#e6db74>&#39;ingressClassName|whitelist-source-range|host:&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Airflow â†’ FastAPI í˜¸ì¶œ í™˜ê²½</span>
</span></span><span style=display:flex><span>NS<span style=color:#f92672>=</span>airflow-dev
</span></span><span style=display:flex><span>POD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl -n $NS get po -l component<span style=color:#f92672>=</span>scheduler -o name | head -1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>kubectl -n $NS exec $POD -- printenv | egrep <span style=color:#e6db74>&#39;FASTAPI_RELOAD_URL|RELOAD_SECRET_TOKEN|AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># í•«ìŠ¤ì™‘ í˜¸ì¶œ</span>
</span></span><span style=display:flex><span>curl -sk -X POST https://fastapi.local/variant/B/reload -H <span style=color:#e6db74>&#34;x-token: &lt;RELOAD_SECRET_TOKEN&gt;&#34;</span>
</span></span></code></pre></div><hr><h2 id=-ì •ë¦¬>ğŸ ì •ë¦¬<a hidden class=anchor aria-hidden=true href=#-ì •ë¦¬>#</a></h2><blockquote><p>/reload ë³´ì•ˆ 3ì¢… + DAG ìë™í™”ê°€ í•˜ë‚˜ì˜ í‘œì¤€ í”Œë¡œìš°ë¡œ ì •ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.</p><p>MLflow <strong>Alias</strong>ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë“±ë¡Â·ê°ì‹œÂ·í•«ìŠ¤ì™‘ì´ ì¼ê´€ë˜ê²Œ ì´ì–´ì§€ë©°, Slackìœ¼ë¡œ ì „ ê³¼ì •ì´ ê°€ì‹œí™”ë©ë‹ˆë‹¤.</p></blockquote></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/03/><span class=title>Â« Prev</span><br><span>[MLOps ìš´ì˜ ê³ ë„í™” - 2ë‹¨ê³„: Slack Alert í†µí•© (FastAPIÂ·Airflow ê³µìš©)]</span>
</a><a class=next href=https://keonhoban.github.io/mlops-journey/posts/mlops-platform-gitops/01/><span class=title>Next Â»</span><br><span>[MLOps ìš´ì˜ ê³ ë„í™” - 0ë‹¨ê³„: FastAPI A/BÂ·CanaryÂ·Blue-Green ì„œë¹™ ë² ì´ìŠ¤]</span></a></nav></footer></article></main><footer class=footer><p style=margin-top:1rem>Â© 2025 Keonho Ban | <a href=https://github.com/keonhoban target=_blank>GitHub</a> | <a href=mailto:keonho0510@naver.com>Email</a></p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>