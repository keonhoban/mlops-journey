+++
date = '2025-06-10T19:49:29+09:00'
draft = false
title = '[Airflow - 5ë‹¨ê³„: PythonOperator + MLflow Tracking ì—°ë™]'
categories = 'Airflow'
+++

> ëª©í‘œ
> 
> 
> PythonOperatorë¥¼ ì‚¬ìš©í•˜ì—¬ MLflowë¡œ ì‹¤í—˜(ëª¨ë¸ í•™ìŠµ)ì„ ìë™í™”í•˜ê³ , íŒŒë¼ë¯¸í„°, ë©”íŠ¸ë¦­, ëª¨ë¸ì„ ê¸°ë¡í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.
> 

ğŸ‘‰ ì‹¤ìŠµ ì½”ë“œëŠ” [ğŸ”— GitHub (Mlflow - Tracking + FastAPI)](https://github.com/keonhoban/mlops-infra-labs/tree/main/airflow/05_Airflow_and_MLflow)

---

## ğŸ§­ ì‹¤ìŠµ ì „ì²´ íë¦„ ìš”ì•½

```
[1ë‹¨ê³„] MLflow ì‹¤í—˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
[2ë‹¨ê³„] Airflow DAG êµ¬ì„±
[3ë‹¨ê³„] DAG ì‹¤í–‰ ë° íŒŒë¼ë¯¸í„°/ë©”íŠ¸ë¦­ í™•ì¸
[4ë‹¨ê³„] ëª¨ë¸ ì €ì¥ ë° ë¡œê¹… ìƒíƒœ ì ê²€
```

---

## ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
airflow/
â”œâ”€â”€ dags/
â”‚   â”œâ”€â”€ train_with_mlflow.py        â† DAG íŒŒì¼
â”œâ”€â”€ ml_code/
â”‚   â”œâ”€â”€ train_mlflow.py             â† MLflow ì—°ë™ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ mlruns/                         â† MLflow ë¡œê¹… ê²°ê³¼ ì €ì¥ í´ë” (ìë™ ìƒì„±)
```

---

## ğŸ§ª 1ë‹¨ê³„: MLflow í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

```python
# airflow/ml_code/train_mlflow.py

import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score

def run_experiment():
    mlflow.set_tracking_uri("file:/opt/airflow/mlruns")
    mlflow.set_experiment("airflow_mlflow_example")

    with mlflow.start_run():
        # ë°ì´í„° ë¡œë”©
        data = load_iris()
        X, y = data.data, data.target

        # ëª¨ë¸ ì •ì˜
        model = RandomForestClassifier(n_estimators=50, max_depth=3)
        model.fit(X, y)
        preds = model.predict(X)

        acc = accuracy_score(y, preds)

        # MLflow ê¸°ë¡
        mlflow.log_param("n_estimators", 50)
        mlflow.log_param("max_depth", 3)
        mlflow.log_metric("accuracy", acc)

        mlflow.sklearn.log_model(model, "model")
```

---

## ğŸ§ª 2ë‹¨ê³„: Airflow DAG ì‘ì„±

```python
# airflow/dags/train_with_mlflow.py

from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime
import sys
sys.path.append("/opt/airflow/ml_code")

from train_mlflow import run_experiment

with DAG(
    dag_id='mlflow_tracking_dag',
    start_date=datetime(2023, 1, 1),
    schedule_interval=None,
    catchup=False,
) as dag:

    run_mlflow = PythonOperator(
        task_id='run_mlflow_training',
        python_callable=run_experiment,
    )
```

---

## âœ… ì‹¤í–‰ ì ˆì°¨

1. `train_mlflow.py` ì‘ì„±
2. `train_with_mlflow.py` DAG ë“±ë¡
3. Airflow UIì—ì„œ DAG ì‹¤í–‰
4. Task ë¡œê·¸ì—ì„œ íŒŒë¼ë¯¸í„°/ë©”íŠ¸ë¦­/ëª¨ë¸ ê¸°ë¡ í™•ì¸

---

## â“ëª¨ë“ˆ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´?

1. `docker-compose.yaml`ì—ì„œ `volumes:` í•­ëª© í™•ì¸
    
    ```yaml
    volumes:
      - ./ml_code:/opt/airflow/ml_code
    ```
    
2. `docker-compose restart`ë¡œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘

---

## ğŸ”§ `requirements.txt` ì¶”ê°€ ë° Docker ì¬ë¹Œë“œ

1. `requirements.txt` íŒŒì¼ì— MLflow ì¶”ê°€:
    
    ```
    mlflow
    ```
    
2. `docker-compose.yaml`ì—ì„œ ì„œë¹„ìŠ¤ì— `build` ì„¤ì • ì¶”ê°€:
    
    ```yaml
    services:
      airflow-webserver:
        build:
          context: .
          dockerfile: Dockerfile
    ```
    
3. Dockerfile ì‘ì„±:
    
    ```
    FROM apache/airflow:2.8.2
    COPY requirements.txt /requirements.txt
    RUN pip install -r /requirements.txt
    ```
    
4. Docker ì¬ë¹Œë“œ:
    
    ```bash
    docker-compose down
    docker-compose build
    docker-compose up -d
    ```
    

---

## ğŸ” í™•ì¸ í¬ì¸íŠ¸

| í•­ëª© | í™•ì¸ ë°©ë²• |
| --- | --- |
| MLflow ë¡œê·¸ | `/opt/airflow/mlruns/` ê²½ë¡œì—ì„œ í™•ì¸ |
| ì •í™•ë„ ë¡œê·¸ | DAG ë¡œê·¸ì—ì„œ `acc = ...` í™•ì¸ |
| DAG ì´ë¦„ | `mlflow_tracking_dag` |
| Experiment ì´ë¦„ | `airflow_mlflow_example` |

---

## ğŸ§© ì‹¤ë¬´ íŒ

| í•­ëª© | ì„¤ëª… |
| --- | --- |
| mlruns ë””ë ‰í† ë¦¬ | MLflow ì‹¤í—˜ ê²°ê³¼ ìë™ ê¸°ë¡ |
| ì‹¤ë¬´ í™•ì¥ | `train.py`, `predict.py`, `evaluate.py` ë“±ì„ ëª¨ë“ˆí™”í•˜ì—¬ DAG ì—°ê³„ ê°€ëŠ¥ |
| MLflow Registry | ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ëª¨ë¸ ë“±ë¡ í›„ ë°°í¬ íŒŒì´í”„ë¼ì¸ êµ¬ì„± |

---

## ğŸ”§ MLOps ì‹¤ì „ ì—°ê²°

- AirflowëŠ” MLflow/Kubeflowì™€ í•¨ê»˜ **ì›Œí¬í”Œë¡œìš° ìë™í™”**ì˜ í•µì‹¬ ë„êµ¬
- ML ë°ì´í„° ì „ì²˜ë¦¬ â†’ ëª¨ë¸ í•™ìŠµ â†’ í‰ê°€/ë°°í¬ë¥¼ DAGë¡œ ì„¤ê³„ ê°€ëŠ¥
- ì´í›„, Airflow + ML ëª¨ë¸ í•™ìŠµ/ì„œë¹™ íŒŒì´í”„ë¼ì¸ êµ¬ì„± ì˜ˆì •
