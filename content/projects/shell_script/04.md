+++
date = '2025-04-25T11:08:02+09:00'
draft = false
title = '[ì…¸ ìŠ¤í¬ë¦½íŠ¸] 04. Monitoring'
categories = 'Linux'
+++

# âœ… ë””ìŠ¤í¬ ì‚¬ìš©ë¥  ì´ˆê³¼ ì‹œ ìžë™ ë¡œê·¸ ì •ë¦¬

> ìš´ì˜ ì¤‘ ë””ìŠ¤í¬ ìš©ëŸ‰ ì´ˆê³¼ë¡œ ìž¥ì• ê°€ ë°œìƒí•˜ê¸° ì „ì—,
ì„œë²„ê°€ ìŠ¤ìŠ¤ë¡œ ë¡œê·¸ë¥¼ ì •ë¦¬í•˜ë„ë¡ ë§Œë“œëŠ” ìžë™í™” ìŠ¤í¬ë¦½íŠ¸ìž…ë‹ˆë‹¤.
> 

---

## 1. ðŸŽ¯ ëª©í‘œ

- âœ… ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ ì¼ì • ê¸°ì¤€ì„ ì´ˆê³¼í•˜ë©´,
- âœ… ì§€ì •ëœ ê²½ë¡œì—ì„œ **ì˜¤ëž˜ëœ ë¡œê·¸ íŒŒì¼ì„ ìžë™ìœ¼ë¡œ ì‚­ì œ**
- âœ… ì‚­ì œëœ íŒŒì¼ì€ ë¡œê·¸ë¡œ ê¸°ë¡

ì´ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë¡œ **ë””ìŠ¤í¬ ê°ì‹œ + ìžë™ ì‚­ì œ + ìš´ì˜ ê¸°ë¡ ë³´ê´€**ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## 2. ðŸ§  ì „ì²´ êµ¬ì¡° íë¦„

```
df â†’ ê° ë””ìŠ¤í¬ ì‚¬ìš©ë¥  í™•ì¸
â†“
ì‚¬ìš©ë¥ ì´ THRESHOLD ì´ìƒì´ë©´
â†“
ì§€ì • ê²½ë¡œì—ì„œ mtime ê¸°ë°˜ ì˜¤ëž˜ëœ ë¡œê·¸ íƒìƒ‰
â†“
ì‚­ì œ + ë¡œê·¸ ê¸°ë¡
```

> ì˜ˆì‹œ ì‹¤í–‰ íë¦„:
> 

```
/ â†’ ì‚¬ìš©ë¥  85% â†’ /var/log ì•ˆì˜ 5ì¼ ì´ˆê³¼ íŒŒì¼ ì‚­ì œ
/home â†’ ì‚¬ìš©ë¥  42% â†’ ì¡°ê±´ ë¯¸ì¶©ì¡± â†’ ìŠ¤í‚µ
```

---

## 3. ðŸ”§ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/usr/bin/env bash
set -euo pipefail

# ì¸ìž ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
LOG_PATH=${1:-"/var/log"}
DELETE_CYCLE_DAYS=${2:-5}
THRESHOLD_USAGE=${3:-80}
LOG_FILE="${LOG_PATH}/$(date '+%F')_delete.log"
TARGET_DISKS=("/" "/mnt/data" "/home")

# ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
log() {
    echo "[$(date '+%F %T')] $1" | tee -a "$LOG_FILE"
}

# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ë¡œê·¸ ì‚­ì œ
log "[START] Disk usage check and cleanup for $LOG_PATH"

df -PTh | awk 'NR > 1 {print $6, $7}' | while read -r usage_percent mount_path; do
    usage=${usage_percent%\%}  # "%" ì œê±°

    for target in "${TARGET_DISKS[@]}"; do
        if [[ "$mount_path" == "$target" && $usage -ge $THRESHOLD_USAGE ]]; then
            log "[INFO] Usage $usage% on $mount_path exceeds threshold ($THRESHOLD_USAGE%). Cleaning logs older than $DELETE_CYCLE_DAYS days..."

            old_files=$(find "$LOG_PATH" -type f -mtime +"$DELETE_CYCLE_DAYS")
            if [[ -z "$old_files" ]]; then
                log "[INFO] No old log files found in $LOG_PATH"
            else
                echo "$old_files" | xargs ls -lh >> "$LOG_FILE"
                echo "$old_files" | xargs rm -f
                log "[DONE] Deleted $(echo "$old_files" | wc -l) files."
            fi
        fi
    done
done

log "[END] Cleanup completed."
```

---

## 4. ðŸ“Œ ì£¼ìš” ì„¤ê³„ í¬ì¸íŠ¸ ìš”ì•½

| ê¸°ëŠ¥ ìš”ì†Œ | ì„¤ëª… |
| --- | --- |
| `df -PTh` + `awk` | ë””ìŠ¤í¬ ì‚¬ìš©ë¥  í™•ì¸ â†’ ì‹¤ì‹œê°„ ê°ì‹œ |
| `${usage%\%}` | ë¬¸ìžì—´ ì²˜ë¦¬ â†’ `%` ì œê±° í›„ ë¹„êµ ê°€ëŠ¥í•˜ê²Œ |
| `"${TARGET_DISKS[@]}"` | ì—¬ëŸ¬ ë§ˆìš´íŠ¸ ê²½ë¡œ ìˆœíšŒ |
| `find + mtime + xargs` | ì¼ì • ê¸°ê°„ ì´ˆê³¼í•œ íŒŒì¼ë§Œ ì •ë¦¬ |
| `log()` í•¨ìˆ˜ | `tee`ë¡œ stdout + íŒŒì¼ ë¡œê·¸ ì´ì¤‘ ê¸°ë¡ |

---

## 5. ðŸ› ï¸ ì‹¤ë¬´ ì ìš© & í™•ìž¥ ì•„ì´ë””ì–´

| í™•ìž¥ ë°©í–¥ | ë°©ë²• |
| --- | --- |
| ðŸ” **cron ìžë™í™”** | `0 1 * * * /home/ubuntu/scripts/log_clean.sh` |
| ðŸ” **íŒŒì¼ í™•ìž¥ìž ì œí•œ** | `find "$LOG_PATH" -name "*.log"` |
| ðŸ”§ **dry-run ì˜µì…˜ ì¶”ê°€** | ì‚­ì œ ì „ íŒŒì¼ ëª©ë¡ë§Œ ì¶œë ¥ |
| â˜ï¸ **S3 ì—…ë¡œë“œ í›„ ì‚­ì œ** | `aws s3 cp && rm` ì—°ë™ |
| ðŸ“© **Slack/ë©”ì¼ ì•Œë¦¼** | ì‚­ì œ í›„ ìŠ¬ëž™ ì „ì†¡ API ì¶”ê°€ |

---

## 6. ðŸ”§ MLOps ì‹¤ì „ ì—°ê²° í¬ì¸íŠ¸

| MLOps íë¦„ | ì ìš© ì˜ˆì‹œ |
| --- | --- |
| ëª¨ë¸ ì„œë¹™ ë¡œê·¸ ì •ë¦¬ | `/opt/ml/logs/` ë””ë ‰í† ë¦¬ ì£¼ê¸°ì  ì²­ì†Œ |
| `mlruns/` ì••ì¶•/ì •ë¦¬ | MLflowì—ì„œ ìƒì„±ë˜ëŠ” run ê²°ê³¼ ì£¼ê¸°ì  ë³´ì¡´ |
| Kubeflow ë¡œê·¸ ëª¨ë‹ˆí„°ë§ | `/var/log/pods/` ê²½ë¡œ ê°ì‹œ ë° ìžë™ ì •ë¦¬ |
| ëª¨ë¸ ì²´í¬í¬ì¸íŠ¸ ê´€ë¦¬ | `/checkpoints/`ì—ì„œ ì˜¤ëž˜ëœ ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ |

---

## 7. âœ… ë§ˆë¬´ë¦¬ ì •ë¦¬

> ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ ë†’ì•„ì§€ë©´ ì„œë²„ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ê³ ,
ì •ë¦¬ ëŒ€ìƒ ë¡œê·¸ë§Œ ì‚­ì œí•˜ê³ , ê·¸ ê¸°ë¡ì„ ë‚¨ê¹ë‹ˆë‹¤.
> 
> 
> ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¨ìˆœí•œ ìžë™í™”ë¥¼ ë„˜ì–´ì„œ,
> 
> **ê´€ë¦¬ìžê°€ ì—†ì–´ë„ ì‹œìŠ¤í…œì´ ìœ ì§€ë˜ëŠ” êµ¬ì¡°**ë¥¼ ëª©í‘œë¡œ í–ˆìŠµë‹ˆë‹¤
> 

---

## ðŸ“Ž GitHub ë§í¬

> ðŸ‘‰ [GitHub: auto_log_cleaner.sh](https://github.com/keonhoban/shell-scripts)
>
