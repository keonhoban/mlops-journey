+++
date = '2025-06-26T17:11:49+09:00'
draft = false
title = '[MLOps í”Œëž«í¼ êµ¬ì¶• - 2ë‹¨ê³„: S3 & PostgreSQL ì—°ë™ì„ ìœ„í•œ ë³´ì•ˆ êµ¬ì„± ë° Secret ê´€ë¦¬ ì „ëžµ]'
categories = ['PostgreSQL', 'AWS', 'Kubernetes']
+++

## âœ¨ TL;DR

- ì™¸ë¶€ ë¦¬ì†ŒìŠ¤(AWS S3, DB ë“±)ì™€ ì—°ê²°í•  ë•Œ, ì¸ì¦ ì •ë³´ë¥¼ ì§ì ‘ ì½”ë“œë‚˜ YAMLì— ë…¸ì¶œí•˜ëŠ” ê±´ ë³´ì•ˆìƒ ìœ„í—˜
- Kubernetesì—ì„œëŠ” `Secret`ê³¼ `ConfigMap`, ê·¸ë¦¬ê³  `envFrom`, `volumeMount` ë°©ì‹ì„ ì¡°í•©í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
- ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” MLflow, Airflow, FastAPIì™€ AWS S3 & PostgreSQLì„ ì—°ë™í•  ë•Œ ì‚¬ìš©í•œ **Secret êµ¬ì„± ì „ëžµ**ê³¼ ë§ˆì£¼ì¹œ ì´ìŠˆ ë° í•´ê²°ì±… ê³µìœ 

---

## ðŸ§± ì•„í‚¤í…ì²˜ êµ¬ì„±ë„

```mermaid
graph TD

subgraph Kubernetes Cluster
  MLflow[MLflow Pod]
  Airflow[Airflow Pod]
  FastAPI[FastAPI Pod]
end

subgraph Kubernetes Secrets
  Secret_AWS[(aws-credentials-secret)]
  Secret_DB_MLFLOW[(mlflow-db-secret)]
  Secret_DB_AIRFLOW[(airflow-db-secret)]
end

subgraph External Systems
  S3[(AWS S3)]
  DB[(PostgreSQL VM)]
end

%% Secret ì£¼ìž…
Secret_AWS --> MLflow
Secret_DB_MLFLOW --> MLflow

Secret_AWS --> FastAPI

Secret_AWS --> Airflow
Secret_DB_AIRFLOW --> Airflow

%% ì™¸ë¶€ ì—°ë™
MLflow --> S3
MLflow --> DB

FastAPI --> S3
FastAPI --> MLflow

Airflow --> S3
Airflow --> DB

```

---

## ðŸ” ì™œ Secret ì²˜ë¦¬ê°€ ì¤‘ìš”í•œê°€?

| í•­ëª© | ì´ìœ  |
| --- | --- |
| AWS Access Key | ë…¸ì¶œ ì‹œ ë°ì´í„° ì‚­ì œ/íƒˆì·¨ ìœ„í—˜ ìžˆìŒ |
| PostgreSQL ì ‘ì† URI | ë‚´ë¶€ë§ DB êµ¬ì¡° ë…¸ì¶œ + Credential ìœ ì¶œ ìœ„í—˜ |
| MLflow Tracking URI | ë‚´ë¶€ ì‹œìŠ¤í…œ êµ¬ì¡° ë…¸ì¶œ ê°€ëŠ¥ |

> âœ… ì‹¤ë¬´ì—ì„  ë°˜ë“œì‹œ ì¸ì¦ì •ë³´ë¥¼ Gitì— ë…¸ì¶œí•˜ì§€ ì•Šê³ , í™˜ê²½ì— ì•ˆì „í•˜ê²Œ ì£¼ìž…í•  ìˆ˜ ìžˆì–´ì•¼ í•¨
> 
- ë¶€ë“ì´í•˜ê²Œ gitì— ì—…ë¡œë“œí•´ì•¼í•  ê²½ìš° SealedSecret ë˜ëŠ” SOPS ì‚¬ìš©í•´ ì•”í˜¸í™” ì²˜ë¦¬í•  ìˆ˜ ìžˆìŒ
    - .gitignore ë“±ìœ¼ë¡œ ì•„ì˜ˆ ì œì™¸í•˜ëŠ” ë°©ë²•ë„ ê°€ëŠ¥

---

## ðŸ“¦ S3 ì¸ì¦ ì •ë³´ ì²˜ë¦¬ ì „ëžµ

### ðŸ”¸ ì‹¤ìŠµ í™˜ê²½ ì¡°ê±´

- MLflow, FastAPI, Airflowì—ì„œ ëª¨ë‘ `boto3`ë¡œ S3ì— ì ‘ê·¼í•´ì•¼ í•¨
- FastAPIëŠ” `env` ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬, AirflowëŠ” `volumeMount` ë°©ì‹ì´ ì•ˆì •ì ìž„

---

### âœ… Secret ìƒì„± (env ë°©ì‹ - MLflow & FastAPI)

```bash
kubectl create secret generic aws-credentials-secret \
  --from-literal=AWS_ACCESS_KEY_ID=your-access-key \
  --from-literal=AWS_SECRET_ACCESS_KEY=your-secret-key \
  --from-literal=MLFLOW_S3_ENDPOINT_URL=https://s3.ap-northeast-2.amazonaws.com \
  -n mlflow
```

> ðŸ” envFrom.secretRefë¡œ ì‚¬ìš©í•˜ë©´ í™˜ê²½ë³€ìˆ˜ë¡œ ë°”ë¡œ ì£¼ìž…ë¨ â†’ boto3ê°€ ìžë™ ì¸ì‹
> 

```yaml
envFrom:
  - secretRef:
      name: aws-credentials-secret
```

---

### âœ… Secret ìƒì„± (volumeMount ë°©ì‹ - Airflow ì „ìš©)

```bash
# .aws/credentials íŒŒì¼ ì˜ˆì‹œ
[default]
aws_access_key_id = your-access-key
aws_secret_access_key = your-secret-key
region = ap-northeast-2
```

```bash
kubectl create secret generic aws-credentials-secret \
  --from-file=credentials=.aws/credentials \
  -n airflow
```

> AirflowëŠ” Taskë§ˆë‹¤ ìƒˆ Podê°€ ëœ¨ê³  mlflow ì™€ S3 ì—°ë™ì‹œ boto3 ì‚¬ìš© 
ë”°ë¼ì„œ, AWS EKSê°€ ì•„ë‹Œ ë¡œì»¬ k8s í™˜ê²½êµ¬ì¡°ìƒ  .aws ê²½ë¡œ ë§ˆìš´íŠ¸ ë°©ì‹ì´ ì•ˆì •ì 
> 

```yaml
extraVolumes:
  - name: aws-credentials
    secret:
      secretName: aws-credentials-secret
extraVolumeMounts:
  - name: aws-credentials
    mountPath: /home/airflow/.aws
    readOnly: true
```

---

## ðŸ—„ PostgreSQL ì ‘ì† ì •ë³´ ê´€ë¦¬ ì „ëžµ

### ðŸ”¸ ëª©í‘œ

- Helm ì°¨íŠ¸ ë‚´ë¶€ì—ì„œ `backend-store-uri` í˜¹ì€ `sql_alchemy_conn` ê°’ì„ ì§ì ‘ ë„£ì§€ ì•ŠìŒ
- ëŒ€ì‹  `Secret`ì´ë‚˜ `ConfigMap`ìœ¼ë¡œ êµ¬ì„± ìš”ì†Œ ë¶„ë¦¬

---

## ðŸ” 1. MLflow ì ‘ì† ì •ë³´ êµ¬ì„± (ðŸ”€ Secret + ConfigMap ë¶„ë¦¬ ë°©ì‹)

> ëª©í‘œ: ì‹¤í—˜ metadata ì €ìž¥ì†Œ(PostgreSQL)ì— ëŒ€í•œ ì•ˆì „í•œ ì—°ê²° ì„¤ì •
> 

### ðŸ§± ì‹œí¬ë¦¿ & ì„¤ì • ë¶„ë¦¬ ë°©ì‹

```bash
# 1-1. Secret: ì¸ì¦ ì •ë³´ (username/password)
kubectl create secret generic mlflow-db-secret \
  --from-literal=username=mlflow_user \
  --from-literal=password=mlflow1234 \
  -n mlflow

# 1-2. ConfigMap: ì¼ë°˜ ì •ë³´ (host/port/dbname)
kubectl create configmap mlflow-db-config \
  --from-literal=host=192.168.18.142 \
  --from-literal=port=5432 \
  --from-literal=dbname=mlflow_db \
  -n mlflow
```

> ðŸ“¦ Helm chartì—ì„œ env.valueFromìœ¼ë¡œ ì¡°í•©í•˜ì—¬ ì£¼ìž… ê°€ëŠ¥
> 

```yaml
- name: DB_USER
  valueFrom:
    secretKeyRef:
      name: mlflow-db-secret
      key: username
- name: DB_PASSWORD
  valueFrom:
    secretKeyRef:
      name: mlflow-db-secret
      key: password
- name: DB_HOST
  valueFrom:
    configMapKeyRef:
      name: mlflow-db-config
      key: host
- name: DB_PORT
  valueFrom:
    configMapKeyRef:
      name: mlflow-db-config
      key: port
- name: DB_NAME
  valueFrom:
    configMapKeyRef:
      name: mlflow-db-config
      key: dbname
```

---

## ðŸ” 2. Airflow ì ‘ì† ì •ë³´ êµ¬ì„± (ðŸ§© í†µí•© URI ë°©ì‹)

> ëª©í‘œ: Airflow ë©”íƒ€ DB(PostgreSQL) URIë¥¼ ë‹¨ì¼ ë¬¸ìžì—´ë¡œ ê´€ë¦¬
> 

```bash
kubectl create secret generic airflow-db-secret \
  --from-literal=connection="postgresql://airflow_user:airflow1234@192.168.18.142:5432/airflow_db" \
  -n airflow
```

> ðŸ“¦ Helm values.yamlì—ì„œ metadataSecretName ìœ¼ë¡œ ì°¸ì¡°
> 

```yaml
data:
  metadataSecretName: airflow-db-secret
```

â†’ ë‚´ë¶€ì ìœ¼ë¡œ `AIRFLOW__DATABASE__SQL_ALCHEMY_CONN` í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •ë¨

---

## ðŸ”„ Secret ë°©ì‹ ì •ë¦¬ ë¹„êµ

| ë°©ì‹ | ëŒ€ìƒ | ìž¥ì  | ë‹¨ì  |
| --- | --- | --- | --- |
| `envFrom.secretRef` | MLflow, FastAPI | ê¹”ë”í•˜ê³  ê°€ë…ì„± ì¢‹ìŒ | Airflowì—ì„œëŠ” ì‹¤íŒ¨ ê°€ëŠ¥ì„± ì¡´ìž¬ |
| `.aws` ë§ˆìš´íŠ¸ | Airflow | Task Podì—ì„œë„ ì•ˆì •ì  | ê²½ë¡œ êµ¬ì¡° ëª…í™•ížˆ ë§žì¶°ì•¼ í•¨ (boto3 ëŒ€ë¹„) |
| base64 `Secret` | DB URI, ë¯¼ê°í•œ í‚¤ | Helmì—ì„œ ê¹”ë”ížˆ ê´€ë¦¬ | Gitì— ì˜¬ë¦¬ë©´ ì•”í˜¸í™” ì—†ì´ ë…¸ì¶œë¨ (ì£¼ì˜) |

---

## ðŸ§© ì‹¤ë¬´ íŒ

- `kubectl create secret` í›„ì—ëŠ” ë°˜ë“œì‹œ `kubectl describe secret` ë˜ëŠ” `env` ëª…ë ¹ì–´ë¡œ ì‹¤ì œ ì£¼ìž… ì—¬ë¶€ë¥¼ í™•ì¸í•  ê²ƒ
- ë¯¼ê°í•œ í‚¤ê°€ ë‹´ê¸´ `.aws/credentials`, `values.yaml` íŒŒì¼ì€ `.gitignore`ì— í¬í•¨í•˜ê³  ìž‘ì—… ì™„ë£Œ í›„ ì‚­ì œ
- ì‹¤ë¬´ì—ì„œëŠ” **SealedSecret**, **SOPS**, **External Secrets Operator** ë“±ì„ ì´ìš©í•œ ì•”í˜¸í™” ì—°ë™ ê³ ë ¤í•´ì•¼ í•¨

---

## ðŸ”§ MLOps ì‹¤ì „ ì—°ê²°

| ì—°ê²° ëŒ€ìƒ | ì‹¤ì „ì—ì„œì˜ ì˜ë¯¸ |
| --- | --- |
| S3 + MLflow | ëª¨ë¸ ì•„í‹°íŒ©íŠ¸ ì €ìž¥ì†Œë¡œ í•„ìˆ˜. ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì‹¤í—˜/ëª¨ë¸ ë¡œê¹… ì „ë¶€ ì‹¤íŒ¨ |
| S3 + Airflow | S3 ë²„í‚·ì—ì„œ Data Load, Export ìž‘ì—… ìˆ˜í–‰ |
| DB URI + MLflow/Airflow | `backend-store-uri` ì„¤ì • ì‹¤íŒ¨ ì‹œ ì „ì²´ ì„œë¹„ìŠ¤ ë¡œë”© ì‹¤íŒ¨ ë°œìƒ |

---

## ðŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì˜ˆì‹œ

### ðŸ”» TS_01: Airflow DAG Taskì—ì„œ `boto3` ì¸ì¦ ì‹¤íŒ¨

| ì¦ìƒ | ì›ì¸ | í•´ê²° |
| --- | --- | --- |
| `botocore.exceptions.NoCredentialsError` | `env` ë°©ì‹ìœ¼ë¡œ ì£¼ìž…í–ˆì§€ë§Œ Task Podì—ëŠ” ì ìš©ë˜ì§€ ì•ŠìŒ | `.aws/credentials` ê²½ë¡œë¡œ ë§ˆìš´íŠ¸ ë°©ì‹ ì‚¬ìš©í•´ì•¼ í•¨ |

---

## ðŸ§­ ë‹¤ìŒ í¬ìŠ¤íŠ¸ ì˜ˆê³ 

> ðŸ“¦ MLflow ì‹¤ì „ ë°°í¬: PostgreSQL + S3 ì—°ë™, Helm êµ¬ì„±, ì»¤ìŠ¤í…€ ì´ë¯¸ì§€, Ingress êµ¬ì„±ê¹Œì§€
> 
> 
> â†’ MLflowë¥¼ Helmìœ¼ë¡œ ì™„ì „í•˜ê²Œ ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ìž‘ì„±í•  ì˜ˆì •ìž…ë‹ˆë‹¤.
>
