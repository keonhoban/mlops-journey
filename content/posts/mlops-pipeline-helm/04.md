+++
date = '2025-07-03T17:11:53+09:00'
draft = false
title = '[MLOps í”Œëž«í¼ êµ¬ì¶• - 4ë‹¨ê³„: Airflow : GitSync + ì™¸ë¶€ PostgreSQL + Secret ì—°ë™]'
categories = ['Airflow' ,'PostgreSQL', 'AWS', 'Kubernetes', 'Helm', 'Git', 'NFS']
+++

## ðŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œì‹¤ë¬´ì—ì„œëŠ” ë°ì´í„° íŒŒì´í”„ë¼ì¸ì´ë‚˜ ëª¨ë¸ í•™ìŠµ ìž‘ì—…ì„ ìˆ˜ì‹œë¡œ ì—…ë°ì´íŠ¸í•˜ê²Œ ë˜ë©°,
> 
> ì´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì§€ ì•Šê³  Git ê¸°ë°˜ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ìž…ë‹ˆë‹¤.
> 
> AirflowëŠ” GitSync ê¸°ëŠ¥ì„ í†µí•´ DAGë¥¼ ìžë™ ë™ê¸°í™”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.â€
> 
- DAG ì½”ë“œê°€ Gitìœ¼ë¡œ ê´€ë¦¬ë˜ì–´ì•¼ ë¦¬ë·°, ížˆìŠ¤í† ë¦¬, í˜‘ì—… ê°€ëŠ¥
- GitSync â†’ DAG ìžë™ ë°°í¬ (CI/CD ê°œë… ì ìš©)
- Secretìœ¼ë¡œ Git ì¸ì¦ â†’ ì¡°ì§ ë‚´ GitOps ë¬¸í™”ì™€ ì—°ê³„

---

## âœ¨ TL;DR

- Helmì„ í†µí•´ Airflowë¥¼ ë°°í¬í•˜ë©´ì„œ DAG ì½”ë“œë¥¼ Git ì €ìž¥ì†Œì—ì„œ ìžë™ìœ¼ë¡œ ë™ê¸°í™”í•˜ëŠ” êµ¬ì¡° ì„¤ê³„
- GitSync, Secret ê¸°ë°˜ SSH ì¸ì¦, ì™¸ë¶€ PostgreSQL, AWS S3 ì—°ë™ê¹Œì§€ í¬í•¨í•´ êµ¬ì„±
- UI ì ‘ê·¼ì€ Ingressë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë©°, ë¡œê·¸ëŠ” PVC ë˜ëŠ” S3ë¡œ ì„¤ì • ê°€ëŠ¥

---

## ðŸ“ ì•„í‚¤í…ì²˜ êµ¬ì„±ë„

![04](/mlops-journey/images/04.png)

---

## ðŸ³ ì»¤ìŠ¤í…€ Airflow ì´ë¯¸ì§€ êµ¬ì„±

GitSync DAGì—ì„œ MLflow ì—°ë™ ë˜ëŠ” AWS SDK ì‚¬ìš©ì„ ìœ„í•œ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ í•„ìš”

### ðŸ”¸ Dockerfile

```
FROM apache/airflow:3.0.2-python3.12

COPY requirements.txt /tmp/requirements.txt
USER airflow
RUN pip install --no-cache-dir -r /tmp/requirements.txt
```

### ðŸ”¸ requirements.txt

```
mlflow==2.13.0
pandas
scikit-learn
boto3
```

### ðŸ”¸ ë¹Œë“œ & í‘¸ì‹œ

```bash
docker build -t hoizz/airflow-custom:v5-mlflow .
docker push hoizz/airflow-custom:v5-mlflow
```

---

## ðŸ›  Helm êµ¬ì„±

### ðŸ”¹ values.yaml

```yaml
# ì‹¤í–‰ ì—”ì§„ ì„¤ì •
executor: KubernetesExecutor

# ì´ë¯¸ì§€ ì„¤ì •
images:
  airflow:
    repository: hoizz/airflow-custom  # ì»¤ìŠ¤í…€ ì´ë¯¸ì§€
    tag: v5-mlflow-20240712           # íƒœê·¸ 
    pullPolicy: IfNotPresent

# ìƒì„±í•œ fernetKey ê³ ì • (helm delete & install ì´í›„ì—ë„ ì´ì „ variables ë“± ë°ì´í„° sync ê°€ëŠ¥)
fernetKeySecretName: my-fernet-secret

# DAG GitSync ì„¤ì • (GitOps ê¸°ë°˜)
dags:
  gitSync:
    enabled: true
    repo: git@github.com:keonhoban/airflow-dags.git
    branch: main
    subPath: dags
    depth: 1
    wait: 10
    rev: HEAD
    sshKeySecret: airflow-git-ssh-secret

# DB ì—°ë™ (ì™¸ë¶€ PostgreSQL ì‚¬ìš©)
postgresql:
  enabled: false  # ë‚´ë¶€ Postgres ë¹„í™œì„±í™”

data:
  metadataSecretName: airflow-db-secret  # Secret ì•ˆì˜ base64ëœ connection ê°’ ì°¸ì¡°

# Airflow í™˜ê²½ ì„¤ì •
config:
  AIRFLOW__CORE__LOAD_EXAMPLES:
    value: "False"
  AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION:
    value: "False"
  AIRFLOW__WEBSERVER__EXPOSE_CONFIG:
    value: "True"

# ë¦¬ì†ŒìŠ¤ ì„¤ì • (ê¶Œìž¥)
scheduler:
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  extraVolumes:
    - name: aws-credentials
      secret:
        secretName: aws-credentials-secret
  extraVolumeMounts:
    - name: aws-credentials
      mountPath: /home/airflow/.aws
      readOnly: true

workers:
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  extraVolumes:
    - name: aws-credentials
      secret:
        secretName: aws-credentials-secret
  extraVolumeMounts:
    - name: aws-credentials
      mountPath: /home/airflow/.aws
      readOnly: true

dagProcessor:
  extraVolumes:
    - name: aws-credentials
      secret:
        secretName: aws-credentials-secret
  extraVolumeMounts:
    - name: aws-credentials
      mountPath: /home/airflow/.aws
      readOnly: true

# Ingress ì„¤ì • (Ingress Controller ê¸°ë°˜ ì ‘ê·¼)
ingress:
  enabled: true

  apiServer:
    enabled: true
    ingressClassName: nginx
    hosts:
      - name: airflow.local
    tls:
      enabled: false  # ì‹¤ë¬´ì—ì„œëŠ” true + cert-manager ì—°ë™ í•„ìš”

# Web UI ì„œë¹„ìŠ¤ íƒ€ìž… ì„¤ì •
apiServer:
  service:
    type: ClusterIP  # ì™¸ë¶€ ì ‘ê·¼ì€ Ingress ê²½ìœ 

# ë¡œê·¸ PVC ì„¤ì •
logs:
  persistence:
    enabled: true
    existingClaim: airflow-logs-pvc

# (ì„ íƒ) remote ë¡œê·¸ ì €ìž¥ì†Œ ì„¤ì • (ì˜ˆ: S3)
# config:
#   AIRFLOW__LOGGING__REMOTE_LOGGING: "True"
#   AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER: "s3://your-bucket-name/airflow-logs"
#   AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID: "aws_default"

```

---

## âœ… `fernet_key` ìƒì„± ë° êµ¬ì„±

- 

```bash
# ìƒì„±
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# secret ì ìš© (íŒŒì¼ ìƒì„± í›„ kubectl apply ê°€ëŠ¥)
# (gitì— í•„ìš”í•œ ê²½ìš° SealedSecret or SOPS or .gitignore)
apiVersion: v1
kind: Secret
metadata:
  name: my-fernet-secret
  namespace: airflow
type: Opaque
stringData:
  fernet-key: "xZ69xLVkiCfJQ23fXa8oubANRIJRHZLrIeANlHhPGmQ="  # ìƒì„±í•œ ê°’ìœ¼ë¡œ ìˆ˜ì •
```

---

## ðŸ” GitSync SSH Key & Secret êµ¬ì„±

```bash
# SSH í‚¤ ìƒì„±
ssh-keygen -t rsa -b 4096 -C "testuser@mlops.com"

# GitHub UIì—ì„œ Deploy Key ë“±ë¡ (ê³µê°œí‚¤)

# K8s Secret ìƒì„± (ë¹„ê³µê°œ í‚¤)
kubectl create secret generic airflow-git-ssh-secret --from-file=gitSshKey=/root/.ssh/id_rsa -n airflow
```

---

## ðŸš€ ë°°í¬ ëª…ë ¹ì–´

```bash
kubectl create namespace airflow

helm install airflow apache-airflow/airflow -n airflow -f values.yaml
```

---

## ðŸŒ ì ‘ì† í™•ì¸

```bash
# /etc/hosts ìˆ˜ì •
{NodeIP} airflow.local

# ë¸Œë¼ìš°ì € ì ‘ì†
http://airflow.local
```

---

## ðŸ§ª í™•ì¸ ì‚¬í•­

| í•­ëª© | í™•ì¸ ë°©ë²• |
| --- | --- |
| Airflow UI ì ‘ê·¼ | `http://airflow.local` |
| DAG GitSync | GitHub push â†’ ìžë™ ë°˜ì˜ ì—¬ë¶€ í™•ì¸ |
| PostgreSQL ì—°ê²° | metadata DBì— ì—°ê²° ë¡œê·¸ í™•ì¸ |
| AWS ì¸ì¦ ì—°ë™ | `boto3.client()` í˜¸ì¶œ ì‹œ ì—ëŸ¬ ì—†ëŠ”ì§€ í™•ì¸ |

---

## ðŸ§© Tip

- GitSyncëŠ” `depth: 1`, `wait`, `rev: HEAD` ì˜µì…˜ ì„¤ì •ìœ¼ë¡œ ìµœì í™” í•„ìš”
- `metadataSecretName`ì—ëŠ” `AIRFLOW__DATABASE__SQL_ALCHEMY_CONN`ì´ base64 ì¸ì½”ë”©ë˜ì–´ ìžˆì–´ì•¼ í•¨
- ê° Pod (`scheduler`, `worker`, `dagProcessor`)ë§ˆë‹¤ AWS credential ë§ˆìš´íŠ¸ í•„ìš”
- Ingress ì ‘ê·¼ì„ ìœ„í•´ì„  hosts íŒŒì¼ì— ìˆ˜ë™ ë“±ë¡ í•„ìš” (ë¡œì»¬ í´ëŸ¬ìŠ¤í„°ì¸ ê²½ìš°)

---

## ðŸ”§ MLOps ì‹¤ì „ ì—°ê²°

| ì—°ê²° í•­ëª© | ì‹¤ë¬´ ì˜ë¯¸ |
| --- | --- |
| DAG GitSync | GitOps ê¸°ë°˜ìœ¼ë¡œ ì‹¤í—˜/ìš´ì˜ ë™ê¸°í™” ìžë™í™” |
| External PostgreSQL | ìš´ì˜ DBì™€ í†µí•©, ë°±ì—…/ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥ |
| boto3 ì—°ë™ | DAG ë‚´ S3 ì ‘ê·¼ ê°€ëŠ¥ (ëª¨ë¸ or raw ë°ì´í„° ì—°ë™) |
| mlflow API ì‚¬ìš© | ì‹¤í—˜ ìžë™í™” ê°€ëŠ¥ (training, promotion í¬í•¨) |

---

## ðŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ðŸ”» GitSync DAG ë¯¸ë°˜ì˜ì‹œ ì²´í¬ ë¦¬ìŠ¤íŠ¸

- `subPath` ê²½ë¡œ ì˜¤ë¥˜
- Secretì— ë“±ë¡ëœ SSH key ê¶Œí•œ ë¬¸ì œ
- GitHub deploy keyì— write ê¶Œí•œ ëˆ„ë½

---

## ðŸ§­ ë‹¤ìŒ í¬ìŠ¤íŠ¸ ì˜ˆê³ 

> âš™ï¸ FastAPI ì„œë¹™ + MLflow ëª¨ë¸ ì—°ë™
> 
> 
> â†’ ëª¨ë¸ í•«ìŠ¤ì™‘, REST API êµ¬ì„±, Stage/Version ìžë™ ì ìš©ê¹Œì§€ ì§„í–‰ ì˜ˆì •ìž…ë‹ˆë‹¤.
>
