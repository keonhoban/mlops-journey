+++
date = '2025-06-30T17:11:51+09:00'
draft = false
title = '[MLOps í”Œëž«í¼ êµ¬ì¶• - 3ë‹¨ê³„: MLflow : PostgreSQL + S3 ì—°ë™ ê¸°ë°˜ Helm êµ¬ì„±]'
categories = ['MLflow' ,'PostgreSQL', 'AWS', 'Kubernetes', 'Helm']
+++

## âœ¨ TL;DR

- MLflowë¥¼ ë„ìž…ì‹œ **PostgreSQL, S3, ì¸ì¦ ì •ë³´ ì£¼ìž…, Helm ë°°í¬, Ingress ì—°ë™ ë“±** ì„¤ê³„
- MLflowë¥¼ Helmìœ¼ë¡œ ë°°í¬í•˜ë©´ì„œ ê³ ë ¤í•œ í•­ëª©(ë³´ì•ˆ, ì•„í‹°íŒ©íŠ¸ ì €ìž¥ì†Œ, UI ì ‘ê·¼ ë“±) êµ¬ì„±
- ì»¤ìŠ¤í…€ Docker ì´ë¯¸ì§€ë¡œ `psycopg2` ì„¤ì¹˜, Helm chart êµ¬ì„±, Secret ì—°ê²°ê¹Œì§€ í¬í•¨

---

## ðŸ“ ì•„í‚¤í…ì²˜ êµ¬ì„±ë„ (with Secret & ì—°ë™ íë¦„)

![03](/mlops-journey/images/03.png)

---

## ðŸ³ ì»¤ìŠ¤í…€ MLflow Docker ì´ë¯¸ì§€ ì œìž‘

ê³µì‹ MLflow ì´ë¯¸ì§€ëŠ” PostgreSQL ë“œë¼ì´ë²„(`psycopg2`)ê°€ í¬í•¨ë˜ì–´ ìžˆì§€ ì•Šì•„ ì˜¤ë¥˜ ë°œìƒ

### ðŸ”¸ Dockerfile ì˜ˆì‹œ

```
FROM ghcr.io/mlflow/mlflow:v2.13.0
RUN pip install psycopg2-binary boto3
```

### ðŸ”¸ ë¹Œë“œ & í‘¸ì‹œ

```bash
docker build -t ghcr.io/your-id/mlflow:with-psycopg2-and-s3 .
docker push ghcr.io/your-id/mlflow:with-psycopg2-and-s3
```

---

## ðŸ›  Helm Chart êµ¬ì„± ìš”ì†Œ

### ðŸ”¹ Chart.yaml

```yaml
apiVersion: v2
name: mlflow
description: A Helm chart for deploying MLflow on Kubernetes
version: 0.1.0
appVersion: "2.13.0"
```

---

### ðŸ”¹ values.yaml ì˜ˆì‹œ

```yaml
image:
  repository: hoizz/mlflow
  tag: with-psycopg2-and-s3
  pullPolicy: IfNotPresent

env:
  defaultArtifactRoot: s3://mlflow-artifacts-keonho

service:
  type: ClusterIP
  port: 5000

ingress:
  enabled: true
  className: nginx  # âœ… ë°˜ë“œì‹œ ëª…ì‹œí•´ì•¼ NGINXê°€ ë¼ìš°íŒ…í•¨
  host: mlflow.local
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/proxy-body-size: 10m
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
```

---

## ðŸ“„ Deployment êµ¬ì„± ì˜ˆì‹œ

```yaml
containers:
  - name: mlflow
    image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
    ports:
      - containerPort: 5000
    command: ["mlflow", "server"]
    args:
      - "--backend-store-uri=postgresql://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)"
      - "--default-artifact-root={{ .Values.env.defaultArtifactRoot }}"
      - "--host=0.0.0.0"
      - "--port=5000"
      - "--serve-artifacts"  # âœ… ì´ê²Œ ìžˆì–´ì•¼ artifacts UI/REST ì§€ì› ê°€ëŠ¥
    env:
      - name: DB_USER
        valueFrom:
          secretKeyRef:
            name: mlflow-db-secret
            key: username
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: mlflow-db-secret
            key: password
      - name: DB_HOST
        valueFrom:
          configMapKeyRef:
            name: mlflow-db-config
            key: host
      - name: DB_PORT
        valueFrom:
          configMapKeyRef:
            name: mlflow-db-config
            key: port
      - name: DB_NAME
        valueFrom:
          configMapKeyRef:
            name: mlflow-db-config
            key: dbname
    envFrom:
      - secretRef:
          name: aws-credentials-secret
```

---

## ðŸŒ Ingress êµ¬ì„± ì˜ˆì‹œ

- ë¡œì»¬ k8sì— êµ¬ì„±í•  ê²½ìš° LB ìž‘ë™í•˜ì§€ ì•ŠìŒ (í¼ë¸”ë¦­ IP ì—†ìŒ)

```bash
# Podê°€ ë…¸ë“œì™€ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©í•˜ë„ë¡ ingress-nginx ì»¤ìŠ¤í…€
helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx --create-namespace \
  --set controller.hostNetwork=true \
  --set controller.dnsPolicy=ClusterFirstWithHostNet \
  --set controller.kind=DaemonSet
```

- MLlflow ingress êµ¬ì„±

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mlflow-ingress
  namespace: mlflow
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: mlflow.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mlflow-service
                port:
                  number: 5000
```

---

## ðŸš€ ë°°í¬ ëª…ë ¹ì–´

```bash
kubectl create namespace mlflow

helm install mlflow mlflow-helm/ -n mlflow
```

---

## ðŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

| í•­ëª© | í™•ì¸ |
| --- | --- |
| MLflow UI | `http://mlflow.local` ì ‘ê·¼ í™•ì¸ |
| ì‹¤í—˜ ë“±ë¡ | `mlflow.log_param`, `mlflow.log_metric`, `log_model()` |
| S3 ì—°ë™ | `.mlruns` í´ë”ê°€ S3ì— ìƒì„±ë˜ëŠ”ì§€ í™•ì¸ |
| PostgreSQL ì—°ë™ | ì‹¤í—˜, run metadataê°€ DBì— ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸ |

---

## ðŸ§© ì‹¤ë¬´ íŒ

- MLflow ë²„ì „ê³¼ PostgreSQL ë“œë¼ì´ë²„ í˜¸í™˜ì„± ì£¼ì˜ (`psycopg2-binary` ì‚¬ìš©)
- ëª¨ë¸ URIëŠ” `"models:/my_model/Production"` í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ì¶”í›„ FastAPIì™€ ì—°ë™ ìš©ì´
- Helm chartì—ì„œ `env` vs `envFrom` í˜¼ìš© ì‹œ ìš°ì„ ìˆœìœ„ ì£¼ì˜

---

## ðŸ”§ MLOps ì‹¤ì „ ì—°ê²°

| ì—°ê²° í•­ëª© | ì‹¤ë¬´ ì˜ë¯¸ |
| --- | --- |
| PostgreSQL | ì‹¤í—˜ metadata ì €ìž¥ì†Œ. ì¶”ì  ê°€ëŠ¥ì„±ê³¼ DB ë°±ì—… ì „ëžµ í•„ìš” |
| S3 ì—°ë™ | ëª¨ë¸/ë¡œê·¸ ì €ìž¥ì†Œ â†’ ì‹¤ì‹œê°„ ì„œë¹™ê¹Œì§€ ì´ì–´ì§ˆ í•µì‹¬ í¬ì¸íŠ¸ |
| Helm êµ¬ì„± | ìš´ì˜ ì‹œ ë°˜ë³µ ë°°í¬, ë²„ì „ ê´€ë¦¬, GitOps ì—°ë™ì˜ í•µì‹¬ ê¸°ë°˜ |
| Ingress | ì¡°ì§ ë‚´/ì™¸ë¶€ì—ì„œ MLflow UI ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•´ì¤Œ |

---

## ðŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ðŸ”» TS_01: `psycopg2` ëª¨ë“ˆ ì—†ìŒ â†’ 500 ì˜¤ë¥˜

```bash
ModuleNotFoundError: No module named 'psycopg2'
```

**í•´ê²°**: ì»¤ìŠ¤í…€ Docker ì´ë¯¸ì§€ì—ì„œ `pip install psycopg2-binary` í¬í•¨

---

### ðŸ”» TS_02: Calico IPIP ë¬¸ì œë¡œ VM(PostgreSQL) í†µì‹  ì‹¤íŒ¨

```bash
# Calicoê°€ IPIP í„°ë„ë§(Protocol 4) ì„ ì‚¬ìš©í•´ Pod â†’ ì™¸ë¶€ë¡œ íŒ¨í‚· ì „ì†¡
tcpdump -i ens33 proto 4

tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), snapshot length 262144 bytes

^C
0 packets captured
0 packets received by filter
0 packets dropped by kernel
4294967281 packets dropped by interface  # PostgreSQLì´ ì„¤ì¹˜ëœ VMì´ IPIP íŒ¨í‚·ì„ Dropí•¨
```

**í•´ê²°1.** : SNAT ê°•ì œ ì ìš© (ë¡œì»¬ í…ŒìŠ¤íŠ¸ í™˜ê²½)

```bash
iptables -t nat -A POSTROUTING -s {pod-network-CIDR} -d {DB_IP} -j MASQUERADE
```

**í•´ê²°2.** : Calico IPIP í„°ë„ ë¹„í™œì„±í™” (VM â†” Pod ì§ì ‘ í†µì‹  í•„ìš”ì‹œ)

```bash
kubectl edit ippool default-ipv4-ippool
spec:
  ipipMode: Never
  natOutgoing: true
  
# ì´í›„ ëª¨ë“  Pod ìž¬ì‹œìž‘ + ë…¸ë“œ ê°„ L3 ë¼ìš°íŒ… í•„ìš”
```

---

## ðŸ§­ ë‹¤ìŒ í¬ìŠ¤íŠ¸ ì˜ˆê³ 

> â˜ï¸ Airflow GitSync + DAG ì—°ë™ ê¸°ë°˜ì˜ ì‹¤ë¬´ í™˜ê²½ êµ¬ì„±
> 
> 
> â†’ GitOps DAG ë°°í¬, AWS ì¸ì¦ ì—°ë™, Secret ë§ˆìš´íŠ¸ê¹Œì§€ êµ¬ì„± íë¦„ì„ ìƒì„¸ížˆ ì •ë¦¬í•©ë‹ˆë‹¤.
>
