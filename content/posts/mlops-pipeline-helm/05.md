+++
date = '2025-07-07T17:11:55+09:00'
draft = false
title = '[MLOps í”Œëž«í¼ êµ¬ì¶• - 5ë‹¨ê³„: FastAPI ì„œë¹™: MLflow ëª¨ë¸ ì—°ë™ ë° í•«ìŠ¤ì™‘ êµ¬ì¡° êµ¬ì¶•]'
categories = ['FastAPI', 'AWS', 'Kubernetes', 'Helm']
+++

## ðŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œ ëª¨ë¸ì„ ìˆ˜ë™ìœ¼ë¡œ ë„£ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
> 
> MLflowì— ë“±ë¡ëœ Staging ëª¨ë¸ì„ ì„œë¹™ APIì—ì„œ **ìžë™ ë¡œë”©**í•˜ëŠ” êµ¬ì¡°ë¥¼ ì§€í–¥í•©ë‹ˆë‹¤.â€
> 
- FastAPIëŠ” ê²½ëŸ‰í™”ëœ ì„œë¹™ ì„œë²„ë¡œì„œ ì í•©
- MLflow `pyfunc.load_model()`ì„ í†µí•´ ìžë™ ë¡œë”© â†’ CI/CD ë° ëª¨ë¸ ìžë™í™” ê°€ëŠ¥
- S3ì™€ ì—°ê²°ë˜ë¯€ë¡œ, â€œë¡œì»¬ ë³µì‚¬ë³¸ ê´€ë¦¬ Xâ€, ìž¬í˜„ì„± ìœ ì§€
- API í˜¸ì¶œì„ í†µí•´ ì‹¤ì œ ì¶”ë¡  ê²°ê³¼ í™•ì¸ ê°€ëŠ¥

---

## âœ¨ TL;DR

- MLflowì—ì„œ ë“±ë¡í•œ ëª¨ë¸ì„ **FastAPI ê¸°ë°˜ REST API**ë¡œ ì„œë¹™í•©ë‹ˆë‹¤.
- `mlflow.pyfunc.load_model()`ì„ í†µí•´ **Stageë³„ ë²„ì „ ê´€ë¦¬**, **í•«ìŠ¤ì™‘**, **ëª¨ë¸ ì •ë³´ ì¡°íšŒ**ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ì¿ ë²„ë„¤í‹°ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ Helm Chart ë°°í¬ + AWS ì¸ì¦ Secret + Ingress ì ‘ê·¼ê¹Œì§€ ì—°ë™í•©ë‹ˆë‹¤.

---

## ðŸ“ ì•„í‚¤í…ì²˜ êµ¬ì„±ë„

![05](/mlops-journey/images/05.png)

---

## ðŸ³ FastAPI ì»¤ìŠ¤í…€ ì´ë¯¸ì§€

### ðŸ“¦ Dockerfile

```
FROM python:3.12

WORKDIR /app
COPY app /app
COPY requirements.txt .

RUN pip install --no-cache-dir -r requirements.txt

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### ðŸ“„ requirements.txt

```
fastapi==0.110.2
uvicorn==0.29.0
mlflow==2.13.0
pandas==2.1.4
scikit-learn==1.6.1
pydantic==2.7.1
boto3==1.34.113
numpy==1.26.4
packaging==24.2
psutil==7.0.0
scipy==1.15.3
setuptools==69.5.1
```

### ðŸš€ ë¹Œë“œ & í‘¸ì‹œ

```bash
docker build -t ghcr.io/hoizz/fastapi-ml:mlflow-model-info .
docker push ghcr.io/hoizz/fastapi-ml:mlflow-model-info
```

---

## ðŸ“„ app/main.py

```python
from fastapi import FastAPI, Request
import mlflow.pyfunc
import mlflow
from mlflow.tracking import MlflowClient
import os

app = FastAPI()
model = None
model_info = {}

def load_model_from_mlflow():
    global model, model_info

    tracking_uri = os.environ.get("MLFLOW_TRACKING_URI")
    model_name = os.environ.get("MODEL_NAME")
    model_stage = os.environ.get("MODEL_STAGE", "Production")

    mlflow.set_tracking_uri(tracking_uri)
    model_uri = f"models:/{model_name}/{model_stage}"

    model = mlflow.pyfunc.load_model(model_uri)

    client = MlflowClient()
    latest = client.get_latest_versions(name=model_name, stages=[model_stage])[0]
    run_id = latest.run_id
    version = latest.version

    print(f"âœ… Reloaded model: name={model_name}, stage={model_stage}, version={version}, run_id={run_id}")
    model_info = {
        "model_name": model_name,
        "stage": model_stage,
        "version": version,
        "run_id": run_id,
        "model_uri": model_uri,
    }

@app.on_event("startup")
def startup_event():
    load_model_from_mlflow()

@app.get("/")
def root():
    return {"message": "FastAPI MLOps is running!"}

@app.get("/model-info")
def get_model_info():
    return model_info

@app.post("/predict")
async def predict(request: Request):
    input_data = await request.json()
    prediction = model.predict(input_data)
    return {"prediction": prediction.tolist()}
```

---

## ðŸ› ï¸ Helm ë°°í¬ êµ¬ì„±

### ðŸ§¾ values.yaml

```yaml
replicaCount: 1

image:
  repository: hoizz/fastapi-ml
  tag: mlflow-model-info
  pullPolicy: IfNotPresent

service:
  name: fastapi-service
  type: ClusterIP
  port: 80

ingress:
  enabled: true
  className: nginx
  host: fastapi.local
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /

env:
  MLFLOW_TRACKING_URI: "http://mlflow-service.mlflow.svc.cluster.local:5000"
  MODEL_NAME: "best_model"
  MODEL_STAGE: "Staging"

envFrom:
  - secretRef:
      name: aws-credentials-secret
```

---

## ðŸ“„ í•µì‹¬ í…œí”Œë¦¿

### fastapi-deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-server
  namespace: fastapi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
        - name: fastapi
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          ports:
            - containerPort: 8000
          env:
            - name: MLFLOW_TRACKING_URI
              value: {{ .Values.env.MLFLOW_TRACKING_URI }}
            - name: MODEL_NAME
              value: {{ .Values.env.MODEL_NAME }}
            - name: MODEL_STAGE
              value: {{ .Values.env.MODEL_STAGE }}
          envFrom:
            - secretRef:
                name: aws-credentials-secret
```

### fastapi-service.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
  namespace: fastapi
spec:
  type: {{ .Values.service.type }}
  selector:
    app: fastapi
  ports:
    - port: {{ .Values.service.port }}
      targetPort: 8000
```

### fastapi-ingress.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fastapi-ingress
  namespace: fastapi
  annotations:
    {{- range $key, $value := .Values.ingress.annotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
spec:
  ingressClassName: {{ .Values.ingress.className }}
  rules:
    - host: {{ .Values.ingress.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: fastapi-service
                port:
                  number: {{ .Values.service.port }}
```

---

## â± ë°°í¬

```bash
kubectl create namespace fastapi
helm install fastapi fastapi-helm -n fastapi

# hosts ìˆ˜ì •
{node_ip} fastapi.local

# ì ‘ê·¼ url
[http://fastapi.local](http://fastapi.local/)
```

---

## ðŸ§© Tip

| í•­ëª© | íŒ |
| --- | --- |
| ëª¨ë¸ í•«ìŠ¤ì™‘ | `/model-info` API ì œê³µ â†’ ìš´ì˜ ì‹œ ë²„ì „ ì¶”ì  í•„ìˆ˜ |
| ëª¨ë¸ ë¯¸ì¡´ìž¬ | load_model ì‹œ `MlflowException` ë°œìƒ â†’ FastAPIê°€ ì£½ì§€ ì•Šë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬ |
| Ingress ì„¤ì • | `/etc/hosts`, className, rewrite-target í•„ìˆ˜ í™•ì¸ |
| ë¦¬ì†ŒìŠ¤ í• ë‹¹ | ë°°í¬ ì‹œ CPU/RAM ì œí•œ ì„¤ì •ìœ¼ë¡œ ì˜ˆì¸¡ ì§€ì—° ë°©ì§€ |

---

## ðŸ”§ MLOps ì‹¤ì „ ì—°ê²°

| í•­ëª© | ì‹¤ì œ ì˜ë¯¸ |
| --- | --- |
| FastAPI REST ì„œë¹™ | ì‹¤ì‹œê°„ ì¶”ë¡  API ìš´ì˜ì— ì í•© |
| mlflow Stage ì‚¬ìš© | ìš´ì˜ê³¼ ì‹¤í—˜ ëª¨ë¸ ë¶„ë¦¬ ë° í•«ìŠ¤ì™‘ ê°€ëŠ¥ |
| boto3 ì—°ë™ | S3 ê°ì²´ ì ‘ê·¼, ë¡œê·¸ ì¶”ì , ë¦¬í¬íŠ¸ ì €ìž¥ ìžë™í™” |
| Helm ê¸°ë°˜ ë°°í¬ | íŒ€ ë‚´ ìž¬ì‚¬ìš© ê°€ëŠ¥í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ íŒ¨í„´ ì™„ì„± |

---

## ðŸ§­ ë‹¤ìŒ í¬ìŠ¤íŠ¸ ì˜ˆê³ 

> ðŸ§  ì‹¤ì‹œê°„ ëª¨ë¸ í•«ìŠ¤ì™‘ êµ¬ì¡° ì‹¤í—˜
> 
> 
> â†’ Airflowì—ì„œ ëª¨ë¸ í•™ìŠµ DAGì„ ì‹¤í–‰í•˜ë©´, 
> MLflowì— ëª¨ë¸ì´ ìžë™ ë“±ë¡ë˜ê³  FastAPI ì„œë²„ë¥¼ ë¦¬ë¡œë“œì‹œ ìƒˆë¡œìš´ ëª¨ë¸ì´ ì ìš©ë˜ë„ë¡ ì§„í–‰ ì˜ˆì •ìž…ë‹ˆë‹¤.
>
