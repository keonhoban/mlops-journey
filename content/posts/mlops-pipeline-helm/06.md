+++
date = '2025-07-10T17:12:00+09:00'
draft = false
title = '[MLOps í”Œë«í¼ êµ¬ì¶• - 6ë‹¨ê³„: ì‹¤ì‹œê°„ ëª¨ë¸ í•«ìŠ¤ì™‘ êµ¬ì¡° ì‹¤í—˜]'
categories = ['MLOps Pipeline', 'Airflow', 'MLflow', 'FastAPI', 'NFS', 'PostgreSQL', 'AWS', 'Kubernetes', 'Helm', 'Git', '']
+++

## âœ… TL;DR

- `Airflow`ì—ì„œ ì„ íƒí•œ ëª¨ë¸ ë²„ì „ì— ë”°ë¼ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ë¥´ê²Œ ì‹¤í–‰
- í•™ìŠµëœ ëª¨ë¸ì„ `MLflow Model Registry`ì— ë“±ë¡ â†’ Production ë‹¨ê³„ë¡œ ìë™ ìŠ¹ê²©
- `FastAPI` ì„œë²„ëŠ” `Production ëª¨ë¸`ì„ ë‹¤ì‹œ ë¡œë“œ â†’ ë³„ë„ ì½”ë“œ ìˆ˜ì • ì—†ì´ í•«ìŠ¤ì™‘ ì™„ë£Œ
- ì‹¤ë¬´ì—ì„œ ëª¨ë¸ ê²€ì¦/ë°°í¬ ì‚¬ì´í´ ìë™í™”ì— ë°”ë¡œ ì‘ìš© ê°€ëŠ¥

---

## ğŸ§  êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨ (í•«ìŠ¤ì™‘ íë¦„)

```mermaid
flowchart TD
  A1[Airflow DAG: ëª¨ë¸ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰] --> B1[MLflow ëª¨ë¸ ë“±ë¡ - ë²„ì „ ì„ íƒ]
  B1 --> C1[ëª¨ë¸ Production ìŠ¹ê²©]
  C1 --> D1[FastAPI ì„œë²„ ì¬ì‹œì‘]
  D1 --> E1[FastAPI â†’ ìµœì‹  ëª¨ë¸ ë¡œë“œ]
  E1 --> F1[ì¶”ë¡  API ì„œë¹™]

  subgraph ì‹¤í—˜ ê´€ë¦¬
    B1
    C1
  end

  subgraph ì¶”ë¡  ì„œë¹„ìŠ¤
    D1
    E1
    F1
  end
```

---

## ğŸ§© í•µì‹¬ êµ¬ì„± ìš”ì†Œ

### 1. Airflow DAG - ëª¨ë¸ ë²„ì „ ì„ íƒ

```python
# dags/train_promote_pipeline_share.py
from airflow import DAG
from airflow.operators.bash import BashOperator
from airflow.models import Variable
from datetime import datetime

default_args = {
    'start_date': datetime(2023, 1, 1),
}

with DAG(
    dag_id='train_promote_pipeline_share',
    default_args=default_args,
    schedule=None,
    catchup=False,
    tags=["ml", "train"]
) as dag:

    # moedel_version ë³€ìˆ˜ default_var ì§€ì •
    model_version = Variable.get("model_version", default_var="v1")

    debug_aws = BashOperator(
    task_id='debug_aws_credentials',
    bash_command='echo $HOME && ls -al $HOME/.aws && cat $HOME/.aws/credentials',
    env={"HOME": "/home/airflow"},
    )

    run_train_script = BashOperator(
        task_id='run_train_script',
        # merdel_version ë³€ìˆ˜í™”
        bash_command=f'python /opt/airflow/dags/repo/ml_code/train_model_{model_version}.py',
        env={"HOME": "/home/airflow"},
    )

    promote_model = BashOperator(
        task_id='promote_model_to_production',
        bash_command='python /opt/airflow/dags/repo/ml_code/promote_model.py',
        env={"HOME": "/home/airflow"},
    )

    debug_aws >> run_train_script >> promote_model

```

â†’ `Airflow UI > Admin > Variables` ì—ì„œ `model_version = v1` ë˜ëŠ” `v2` ì„¤ì • ê°€ëŠ¥

---

### 2. ëª¨ë¸ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ (v1 & v2 ë¹„êµ)

```python
# train_model_v1.py
import mlflow
import mlflow.sklearn
from sklearn.linear_model import LogisticRegression
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split

X, y = load_iris(return_X_y=True)
X_train, X_test, y_train, y_test = train_test_split(X, y)

model = LogisticRegression(max_iter=10, C=0.1)  # underfit ìœ ë„
model.fit(X_train, y_train)

mlflow.set_tracking_uri("http://mlflow-service.mlflow.svc.cluster.local:5000")
mlflow.set_experiment("train_model_to_s3_and_promote_exp")

with mlflow.start_run() as run:
    mlflow.log_param("model_type", "logistic_regression")
    mlflow.log_metric("accuracy", model.score(X_test, y_test))

    mlflow.sklearn.log_model(
        sk_model=model,
        artifact_path="model",
        registered_model_name="my_model"
    )

    print(f"Logged data and model in run {run.info.run_id}")

# train_model_v2.py
import mlflow
from sklearn.datasets import load_iris
from sklearn.linear_model import LogisticRegression
from sklearn.model_selection import train_test_split

mlflow.set_tracking_uri("http://mlflow-service.mlflow.svc.cluster.local:5000")
mlflow.set_experiment("train_model_to_s3_and_promote_exp")

X, y = load_iris(return_X_y=True)
X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=42)

model = LogisticRegression(max_iter=500, C=10.0, solver="liblinear")  # well-trained
model.fit(X_train, y_train)

with mlflow.start_run() as run:
    accuracy = model.score(X_test, y_test)
    mlflow.log_param("model_type", "logistic_regression")
    mlflow.log_metric("accuracy", accuracy)

    mlflow.sklearn.log_model(
        sk_model=model,
        artifact_path="model",
        registered_model_name="my_model"  # ğŸ” ê°™ì€ ëª¨ë¸ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ â†’ v2ë¡œ ì˜¬ë¼ê°
    )

    print(f"âœ… New version logged with accuracy: {accuracy}")
    print(f"ğŸ“¦ Run ID: {run.info.run_id}")

```

â†’ ë‘ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì„±ëŠ¥ ì°¨ì´ê°€ í™•ì‹¤íˆ ë‚˜ë„ë¡ ì„¤ì • (í•«ìŠ¤ì™‘ ê²€ì¦ì„ ìœ„í•œ ì˜ë„ì  ì„¤ê³„)

---

### 3. ëª¨ë¸ ë“±ë¡ ë° ìŠ¹ê²©

```python
mlflow.sklearn.log_model(
    sk_model=model,
    artifact_path="model",
    registered_model_name="my_model"  # ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ â†’ ë²„ì „ë§Œ ì˜¬ë¼ê°
)
```

â†’ ê°™ì€ ëª¨ë¸ ì´ë¦„(`my_model`)ìœ¼ë¡œ ë“±ë¡ë˜ê¸° ë•Œë¬¸ì— ë²„ì „ë§Œ ì˜¬ë¼ê°€ê³ 

â†’ `Stage: Production`ìœ¼ë¡œ ë°”ë¡œ ìŠ¹ê²©ë¨

---

### 4. FastAPI - ëª¨ë¸ ë¡œë”©

```python
# ëª¨ë¸ ì •ë³´ í™•ì¸
curl http://fastapi.local/model-info | jq
```

```json
{
  "model_name": "my_model",
  "stage": "Production",
  "version": "1",
  "run_id": "4e35d28e73474542b01bad641f603b88",
  "model_uri": "models:/my_model/Production"
}
```

â†’ `model_uri = models:/my_model/Production` ì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ìµœì‹  ë²„ì „ì„ ê°€ì ¸ì˜´

---

### 5. FastAPI ì¬ì‹œì‘ë§Œìœ¼ë¡œ í•«ìŠ¤ì™‘ ì ìš©

```bash
kubectl rollout restart deployment/fastapi-server -n fastapi
```

â†’ ì½”ë“œ ìˆ˜ì • ì—†ì´ë„ ìƒˆë¡œìš´ ëª¨ë¸ ë²„ì „ì´ ì ìš©ë¨

---

### ğŸ”„ **ìƒˆë¡œìš´ ëª¨ë¸ ë²„ì „ í™•ì¸**

```bash
curl http://fastapi.local/model-info | jq
```

- **ì¶œë ¥ ì˜ˆì‹œ**:
    
    ```json
    {
      "model_name": "my_model",
      "stage": "Production",
      "version": "2",
      "run_id": "01bf8cf78cd64b759c9f5469c65708a4",
      "model_uri": "models:/my_model/Production"
    }
    ```
    

---

## ğŸ”§ MLOps ì‹¤ì „ ì—°ê²°

| í•­ëª© | ì‹¤ë¬´ í™œìš© í¬ì¸íŠ¸ |
| --- | --- |
| Airflow Variable | íŒŒë¼ë¯¸í„° íŠœë‹ ì‹¤í—˜ ìë™í™” |
| ëª¨ë¸ ë²„ì „ ê´€ë¦¬ | ì‹¤í—˜ ë²„ì „ ê¸°ë¡ + ë¦¬ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ |
| FastAPI ì¬ì‹œì‘ | ë¸”ë£¨ê·¸ë¦° or ë¡¤ë§ ì„œë¹™ ë°©ì‹ ì—°ê³„ ê°€ëŠ¥ |
| MLflow + FastAPI ì—°ê²° | ì½”ë“œ ë³€ê²½ ì—†ì´ë„ ìµœì‹  ëª¨ë¸ ë°˜ì˜ (ëª¨ë¸ URI í™œìš©) |

---

## ğŸ§© Tip

- FastAPIëŠ” `models:/model_name/Production` URIë§Œ ìœ ì§€í›„ ì¬ì‹œì‘ì‹œ ì‹ ê·œ ëª¨ë¸ ë²„ì „ ì ìš©ë¨
- `Airflow Variable`ì„ í†µí•´ ì‹¤ì‹œê°„ ì‹¤í—˜ í™˜ê²½ êµ¬ì„± ê°€ëŠ¥ â†’ ë°°í¬ ì½”ë“œ ì¬ì‘ì„± í•„ìš” ì—†ìŒ
- `train_model_v1.py`, `train_model_v2.py`ë¥¼ í†µí•©í•˜ê³  ì‹¶ë‹¤ë©´ Jinja í…œí”Œë¦¿ or íŒŒë¼ë¯¸í„°í™” ê°€ëŠ¥
- CI/CDì™€ ì—°ê²° ì‹œ `model_version` â†’ Git ì»¤ë°‹ íƒœê·¸ ë“±ìœ¼ë¡œ ì—°ë™í•˜ì—¬ ë²„ì „ ìë™ ì¶”ì  ê°€ëŠ¥

---

## ğŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

| ì´ìŠˆ | í•´ê²° ë°©ë²• |
| --- | --- |
| FastAPIì—ì„œ 500 ì˜¤ë¥˜ | ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ì—¬ë¶€ ë¡œê·¸ í™•ì¸ (`kubectl logs`) |
| ëª¨ë¸ ë²„ì „ì´ ì•ˆ ë°”ë€œ | MLflow ë“±ë¡ í›„ `Production` ìŠ¹ê²© í™•ì¸ í•„ìš” |
| FastAPI ì¬ì‹œì‘ íš¨ê³¼ ì—†ìŒ | `kubectl rollout restart` ëª…ë ¹ìœ¼ë¡œ ê°•ì œ ì ìš© ê¶Œì¥ |
