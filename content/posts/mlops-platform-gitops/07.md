+++
date = '2025-08-27T17:10:21+09:00'
draft = false
title = '[MLOps ìš´ì˜ ê³ ë„í™” - 6ë‹¨ê³„: GitOps ê³ ë„í™” (Argo CDÂ·MetalLBÂ·ApplicationSet)]'
categories = ['MLOps Pipeline', 'Kubernetes', 'Helm', 'Git', 'Network']
+++

## FastAPI ì•± ì „ë©´ ê°œí¸: A/B Â· Canary Â· Blue-Green ì„œë¹™ ë² ì´ìŠ¤

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œìš´ì˜ í™˜ê²½ì—ì„œ ëª¨ë¸ì€ ì–¸ì œë“  êµì²´ë  ìˆ˜ ìˆê³ ,
> 
> 
> ê·¸ ìˆœê°„ì´ ì„œë¹„ìŠ¤ í’ˆì§ˆì´ ê°€ì¥ í¬ê²Œ í”ë“¤ë¦¬ëŠ” ìœ„í—˜ êµ¬ê°„ì…ë‹ˆë‹¤.â€
> 
> â€œê·¸ë˜ì„œ ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” ì´í›„ ëª¨ë“  ìë™í™”(í•™ìŠµÂ·ë“±ë¡Â·í•«ìŠ¤ì™‘Â·ë¡¤ë°±)ì˜ ê¸°ë°˜ì´ ë˜ëŠ”
> 
> **A/B Â· Canary Â· Blue-Green ì „ëµì„ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” FastAPI ì„œë¹™ êµ¬ì¡°**ë¶€í„° ì¡ì•˜ìŠµë‹ˆë‹¤.â€
> 
> â€œì´ ë¼ˆëŒ€ê°€ ì™„ì„±ë¼ì•¼ Airflow, MLflow, ArgoCDì™€ ì—°ê²°ëœ
> 
> **ì§„ì§œ â€˜ìš´ì˜í˜• MLOps íŒŒì´í”„ë¼ì¸â€™**ì„ ë§Œë“¤ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.â€
> 

---

### ğŸ¯ í•µì‹¬ ìš”ì•½

- **ì „í™˜ ê¸°ì¤€ = MLflow Alias(@A/@B)**
    
    (`models:/<name>@<alias>` + `get_model_version_by_alias`)
    
- **MLflow ì„œë¹„ìŠ¤ FQDN**
    - dev: `http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000`
    - prod: `http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000`
- **Ingress ë³´ì•ˆ í‚¤**: `nginx.ingress.kubernetes.io/whitelist-source-range`
- **í—¬ìŠ¤ ì²´í¬**: `ok / degraded / unhealthy` 3ë‹¨ê³„ ìƒíƒœ ì™„ì „ êµ¬í˜„

> ì´í›„ 1~9ë‹¨ê³„ ëª¨ë“  ì‹¤ìŠµì€ ì´ êµ¬ì¡°ë¥¼ ê³µí†µ ë² ì´ìŠ¤ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
> 
> 
> ArgoCD, Airflow, MLflow, FastAPIê°€ ì™„ì „ ë™ê¸°í™”ëœ GitOps ê¸°ë°˜ MLOps ìš´ì˜ êµ¬ì¡°ì…ë‹ˆë‹¤.
> 

---

## 1ï¸âƒ£ ì „ì²´ êµ¬ì¡° ìš”ì•½

```mermaid
flowchart LR
  subgraph FastAPI["ğŸš€ FastAPI App (charts/fastapi/app)"]
    MAIN["main.py"]
    START["core/startup.py (A/B ì´ˆê¸° ë¡œë”©)"]
    CONF["core/config.py (env ì„¤ì •)"]
    ROUTES["routes/* (predict/reload/health/models/root)"]
    SVCS["services/* (model_loader/alias_selector)"]
    UTILS["utils/* (logger/slack_alerts)"]
  end

  subgraph MLPlatform["ğŸ§  ML Platform"]
    MF["MLflow Registry (Alias=A/B)"]
    AF["Airflow DAG (trainâ†’registerâ†’sensorâ†’reload)"]
  end

  MAIN --> START
  MAIN --> ROUTES
  ROUTES --> SVCS
  ROUTES --> UTILS
  SVCS --> MF
  AF -- "POST /variant/{alias}/reload" --> ROUTES

  classDef node fill:#f7f7ff,stroke:#7aa7ff,stroke-width:1px,color:#0b318f;
  classDef sub fill:#eef5ff,stroke:#7aa7ff,stroke-width:1px,color:#0b318f;
  class MAIN,START,CONF,ROUTES,SVCS,UTILS,MF,AF node;
  class FastAPI,MLPlatform sub;

```

---

## 2ï¸âƒ£ ì½”ë“œ íŠ¸ë¦¬

```
charts/fastapi/app/
â”œâ”€ main.py
â”œâ”€ core/
â”‚  â”œâ”€ config.py
â”‚  â””â”€ startup.py
â”œâ”€ routes/
â”‚  â”œâ”€ health.py
â”‚  â”œâ”€ models.py
â”‚  â”œâ”€ predict.py
â”‚  â”œâ”€ reload.py
â”‚  â””â”€ root.py
â”œâ”€ services/
â”‚  â”œâ”€ alias_selector.py
â”‚  â””â”€ model_loader.py
â””â”€ utils/
   â”œâ”€ logger.py
   â””â”€ slack_alerts.py
```

> ì „ì²´ ì½”ë“œëŠ” ë ˆí¬ì— ìˆìŠµë‹ˆë‹¤ (ì—í•„ë¡œê·¸ ì°¸ê³ )
> 

---

## 3ï¸âƒ£ í•µì‹¬ ë³€ê²½ ìš”ì•½

- **ìë™/ìˆ˜ë™ ë¶„ë¦¬**
    
    `/predict` â†’ ìë™ ë¶„ê¸°(A/B/Canary/Blue-Green)
    
    `/variant/{alias}/predict` â†’ ìˆ˜ë™ ì§€ì •(A/B)
    
- **í•«ìŠ¤ì™‘ êµ¬ì¡° í‘œì¤€í™”**
    
    `/variant/{alias}/reload` â†’ `x-token` ì¸ì¦ + Slack + ë¡œê·¸(NFS)
    
- **ê¸°ë™ ì‹œ ìë™ ë¡œë”©**
    
    `A/B` ë™ì‹œ ë¡œë”© â†’ ì¼ë¶€ ì‹¤íŒ¨ `degraded`, ì „ë¶€ ì‹¤íŒ¨ `unhealthy`
    
- **ìƒíƒœ ê´€ë¦¬**
    
    `/health` 3ë‹¨ê³„ + `/models` ë©”íƒ€ì •ë³´ ì œê³µ
    

---

## 4ï¸âƒ£ ì—”ë“œí¬ì¸íŠ¸ ìš”ì•½

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… |
| --- | --- | --- |
| `POST` | `/predict` | `x-client-id` ê¸°ë°˜ ìë™ ë¶„ê¸° |
| `POST` | `/variant/{alias}/predict` | alias ì§€ì • ì˜ˆì¸¡ (A/B) |
| `POST` | `/variant/{alias}/reload` | ëª¨ë¸ í•«ìŠ¤ì™‘ (`x-token` ì¸ì¦ í•„ìš”) |
| `GET` | `/health` | í—¬ìŠ¤ ìƒíƒœ (ok/degraded/unhealthy) |
| `GET` | `/models` | í˜„ì¬ ë¡œë”© ëª¨ë¸ ì •ë³´ |
| `GET` | `/` | ì „ì²´ ì—”ë“œí¬ì¸íŠ¸ ì¸ë±ìŠ¤ |

---

## 5ï¸âƒ£ ë³´ì•ˆ & ë¡œê¹…

- **ë³´ì•ˆ**
    - `/variant/{alias}/reload`: `x-token == RELOAD_SECRET_TOKEN` ì¼ì¹˜ ì‹œì—ë§Œ ìˆ˜í–‰
    - Ingress ë‚´ë¶€ë§ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + TLS ì ìš©
- **ë¡œê¹…**
    - `loguru` ê¸°ë°˜ íŒŒì¼ ë¡œê·¸ â†’ PVC (`/app/logs/fastapi.log`)
- **ì•Œë¦¼**
    - Slack Webhook (ì„±ê³µ/ì‹¤íŒ¨/í—¬ìŠ¤ ìƒíƒœ í…œí”Œë¦¿í™”)

---

## 6ï¸âƒ£ ë™ì‘ ì˜ˆì‹œ

```bash
# âœ… ìˆ˜ë™ ì˜ˆì¸¡ (A)
curl -k -X POST https://fastapi.local/variant/A/predict \
  -H "Content-Type: application/json" \
  -d '{"data": [[5.1,3.5,1.4,0.2]]}'

# âœ… ìë™ ì˜ˆì¸¡ (x-client-id ê¸°ë°˜)
curl -k -X POST https://fastapi.local/predict \
  -H "x-client-id: client_88" \
  -H "Content-Type: application/json" \
  -d '{"data": [[5.1,3.5,1.4,0.2]]}'

# âœ… ëª¨ë¸ í•«ìŠ¤ì™‘ (B)
curl -k -X POST https://fastapi.local/variant/B/reload \
  -H "x-token: <RELOAD_SECRET_TOKEN>"
```

> -k ì˜µì…˜ì€ self-signed ì¸ì¦ì„œìš© í…ŒìŠ¤íŠ¸ í”Œë˜ê·¸ì…ë‹ˆë‹¤.
> 

---

## 7ï¸âƒ£ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ]  `ALIAS_SELECTION_MODE` = `"ab_test" | "canary" | "blue_green"`
- [ ]  `/variant/{alias}/reload` í† í° í™•ì¸ (`RELOAD_SECRET_TOKEN`)
- [ ]  Ingress í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (`nginx.ingress.kubernetes.io/whitelist-source-range`)
- [ ]  Slack Secret (dev/prod ë¶„ë¦¬)
- [ ]  PVC ê¶Œí•œ (`fsGroup`, `runAsUser`)
- [ ]  MLflow Alias(@A/@B) ê¸°ë°˜ ì „í™˜ ë¡œì§

---

## 8ï¸âƒ£ êµì°¨ ê²€ì¦ ê²°ê³¼

- **dev env**
    - `ALIAS_SELECTION_MODE=blue_green`, `DEFAULT_ALIAS=B`, `CANARY_PERCENT=20`
    - `MLFLOW_TRACKING_URI=http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000`
- **ë¶„ë°° ë¡œê·¸**
    - `ab_test_result.log` 500ê±´ ì „ëŸ‰ B â†’ Blue-Green + DEFAULT_ALIAS=B ì •ìƒ ë™ì‘
- **PVC**
    - `fastapi-logs-pvc-dev/prod` ë‘˜ ë‹¤ Bound ìƒíƒœ í™•ì¸

---

## 9ï¸âƒ£ ëŒ€í‘œ ì½”ë“œ ìŠ¤ëƒ…ìƒ·

### (1) `services/alias_selector.py`

```python
import hashlib
from core.config import settings

def get_alias(client_id: str | None) -> str:
    mode = settings.alias_selection_mode

    if mode == "blue_green":
        return settings.default_alias

    if not client_id:
        return settings.default_alias

    hashed = int(hashlib.sha256(client_id.encode()).hexdigest(), 16)
    bucket = hashed % 100

    if mode == "ab_test":
        return "A" if bucket < 90 else "B"
    elif mode == "canary":
        return "B" if bucket < settings.canary_percent else "A"
    else:
        return settings.default_alias
```

### (2) `routes/predict.py`

```python
from fastapi import APIRouter, Header, HTTPException, Request
import pandas as pd
from services.alias_selector import get_alias
from core.config import settings
from utils.logger import logger
from utils.slack_alerts import send_slack_alert

router = APIRouter()

@router.post("/predict")
async def predict(request: Request, input_data: dict, x_client_id: str | None = Header(default=None)):
    models = getattr(request.app.state, "models", {})
    if not models:
        raise HTTPException(status_code=503, detail="ëª¨ë¸ ë¯¸ë¡œë”© ìƒíƒœ")

    alias = get_alias(x_client_id)
    model_entry = models.get(alias)
    if not model_entry:
        raise HTTPException(status_code=503, detail=f"ëª¨ë¸ {alias} ë¯¸ë¡œë”© ìƒíƒœ")

    try:
        df = pd.DataFrame(input_data.get("data", []))
        prediction = model_entry["model"].predict(df)
        logger.info(f"[Predict] alias={alias}, mode={settings.alias_selection_mode}, client_id={x_client_id}")
        return {"variant": alias, "mode": settings.alias_selection_mode, "prediction": prediction.tolist()}
    except Exception as e:
        logger.exception("ì˜ˆì¸¡ ì‹¤íŒ¨")
        send_slack_alert(f"âŒ ì˜ˆì¸¡ ì‹¤íŒ¨ (alias={alias}): {e}")
        raise HTTPException(status_code=500, detail="ì˜ˆì¸¡ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜")
```

### (3) `services/model_loader.py`

```python
import mlflow.pyfunc
from mlflow.tracking import MlflowClient
from utils.slack_alerts import send_slack_alert
from loguru import logger
from core.config import settings

def load_model_by_alias(alias: str):
    try:
        mlflow.set_tracking_uri(settings.mlflow_tracking_uri)
        client = MlflowClient()
        model_uri = f"models:/{settings.model_name}@{alias}"
        model = mlflow.pyfunc.load_model(model_uri)
        version_info = client.get_model_version_by_alias(settings.model_name, alias)

        logger.info(f"âœ… ëª¨ë¸ ë¡œë”© ì„±ê³µ: alias={alias}, version={version_info.version}")
        return {
            "model": model,
            "info": {
                "model_name": settings.model_name,
                "alias": alias,
                "version": version_info.version,
                "run_id": version_info.run_id,
                "model_uri": model_uri,
            }
        }
    except Exception as e:
        logger.error(f"âŒ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨: {e}")
        send_slack_alert(f"âŒ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨: alias={alias}, {e}")
        return None
```

### (4) `routes/health.py`

```python
from fastapi import APIRouter, Request

router = APIRouter()

@router.get("/health")
def health_check(request: Request):
    models = getattr(request.app.state, "models", {})
    if not models:
        return {"status": "unhealthy", "loaded": []}

    missing = [v for v in ["A", "B"] if v not in models]
    if missing:
        return {"status": "degraded", "loaded": list(models.keys()), "missing": missing}

    return {"status": "ok", "loaded": list(models.keys())}
```

---

## ğŸ”Ÿ Helm ì£¼ìš” ê°’

### â–¶ dev

```yaml
env:
  MLFLOW_TRACKING_URI: "http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000"
  MODEL_NAME: "best_model"
  DEFAULT_ALIAS: "B"
  ALIAS_SELECTION_MODE: "blue_green"
  CANARY_PERCENT: "20"
```

### â–¶ prod

```yaml
env:
  MLFLOW_TRACKING_URI: "http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000"
  MODEL_NAME: "best_model"
  DEFAULT_ALIAS: "B"
  ALIAS_SELECTION_MODE: "blue_green"
  CANARY_PERCENT: "10"
```

---

## ğŸ§© íŒ

- ğŸ§© **Secret ì´ë¦„ ì¼ì¹˜ì„±**: `envFrom.secretRef.name` â†” ì‹¤ì œ Secret `metadata.name`
- ğŸ”§ **Blue-Green ëª¨ë“œì—ì„œëŠ” `CANARY_PERCENT` ë¯¸ì‚¬ìš©**
- ğŸ”§ **ê¸°ë™ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ(sys.exit)** â†’ Health ë…¸ì´ì¦ˆ ì°¨ë‹¨

---

## ğŸ§­ ê²€ì¦ ëª…ë ¹ ëª¨ìŒ

```bash
# FastAPI env í™•ì¸
kubectl -n fastapi-dev exec $(kubectl -n fastapi-dev get po -l app=fastapi-dev -o name | head -1) -- \
printenv | egrep 'ALIAS_SELECTION_MODE|DEFAULT_ALIAS|CANARY_PERCENT|MLFLOW_TRACKING_URI|MODEL_NAME'

# MLflow ì„œë¹„ìŠ¤ DNS í™•ì¸
kubectl -n mlflow-dev  get svc mlflow-dev-service  -o wide
kubectl -n mlflow-prod get svc mlflow-prod-service -o wide

# Ingress í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í™•ì¸
kubectl -n fastapi-dev get ing -o yaml | egrep 'ingressClassName|whitelist-source-range|host:'

# í—¬ìŠ¤ ìƒíƒœ í™•ì¸
curl -sk https://fastapi.local/health
```

---

## ğŸ ì •ë¦¬

> FastAPIì˜ A/B/Canary/Blue-Green êµ¬ì¡°ê°€ Helm, MLflow, Slack, PVC, ArgoCDì™€ ì™„ì „ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
> 
> 
> Ingress, Secrets, MLflow Aliasê¹Œì§€ ëª¨ë‘ ì‹¤í™˜ê²½ ê¸°ì¤€ìœ¼ë¡œ ê²€ì¦ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
>
