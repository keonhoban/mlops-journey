+++
date = '2025-09-05T17:10:21+09:00'
draft = false
title = '[MLOps ìš´ì˜ ê³ ë„í™” - 7ë‹¨ê³„: Argo CD Notifications ìë™í™” (Slack ì—°ë™)]'
categories = ['MLOps Pipeline', 'Kubernetes', 'Helm', 'Git', 'Slack']
+++

## Argo CD Notifications â€“ GitOps ëª¨ë‹ˆí„°ë§ ìë™í™” (Slack Webhook & SealedSecret)

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œGitOpsëŠ” ìë™ìœ¼ë¡œ ì˜ ëŒì•„ê°€ë„,
> 
> 
> **ì§€ê¸ˆ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ëª¨ë¥´ë©´ ìš´ì˜ìëŠ” í•­ìƒ ë¶ˆì•ˆí•©ë‹ˆë‹¤.**â€
> 
> â€œê·¸ë˜ì„œ ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” Argo CDì˜ Sync/Health ë³€í™”ë¥¼
> 
> ì¦‰ì‹œ Slackìœ¼ë¡œ ë°›ì•„ë³´ëŠ” **GitOps ëª¨ë‹ˆí„°ë§ ë£¨í”„**ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
> 
> ì»¤ë°‹ ì´í›„ ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ â€˜ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì´ê²Œâ€™ ë§Œë“œëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.â€
> 

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

- **Argo CD Notifications Controller**ë¡œ **Sync/Health** ì´ë²¤íŠ¸ë¥¼ **Slack**ì— ì‹¤ì‹œê°„ ì „ì†¡
- **Webhook URL â†’ SealedSecret â†’ í™˜ê²½ë³€ìˆ˜ ì°¸ì¡°**ë¡œ ì•ˆì „ ê´€ë¦¬(ë ˆí¬ ì»¤ë°‹ OK)
- í…œí”Œë¦¿/íŠ¸ë¦¬ê±°/êµ¬ë…ì„ **ConfigMap í•œ ê³³**ì—ì„œ ì„ ì–¸ì ìœ¼ë¡œ ê´€ë¦¬
- **Git ì»¤ë°‹ â†’ Argo Sync â†’ Slack ì•Œë¦¼**ì˜ ìë™ ë£¨í”„ ì™„ì„±

---

## 1ï¸âƒ£ ì „ì²´ íë¦„ ìš”ì•½

![mermaid-07.png](/mlops-journey/images/mermaid-07.png)

---

## 2ï¸âƒ£ í´ë”/ë¦¬ì†ŒìŠ¤ êµ¬ì¡°(ë ˆí¬ ë°˜ì˜ ìƒíƒœ)

```
mlops-infra/
â”œâ”€ bootstrap/
â”‚  â””â”€ notifications/
â”‚     â”œâ”€ cm.yaml               # í…œí”Œë¦¿/íŠ¸ë¦¬ê±°/êµ¬ë… ì„ ì–¸
â”‚     â”œâ”€ secret-sealed.yaml    # Slack Webhook(SealedSecret)
â”‚     â””â”€ kustomization.yaml    # (ì„ íƒ) ë™ì¼ ë””ë ‰í„°ë¦¬ ë¦¬ì†ŒìŠ¤ ë¬¶ìŒ
â””â”€ apps/
   â”œâ”€ project-notifications.yaml
   â””â”€ notifications.yaml
```

> ì´ë¯¸ ë™ì¼ ê²½ë¡œê°€ ë ˆí¬ì— ì¡´ì¬í•˜ë¯€ë¡œ ì •í•©ì„±ë§Œ í™•ì¸í•˜ë©´ ë©ë‹ˆë‹¤.
> 

---

## 3ï¸âƒ£ Slack Webhook(SealedSecret) â€” ì•ˆì „ ì£¼ì…

```yaml
# bootstrap/notifications/secret-sealed.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: argocd-notifications-secret
  namespace: argocd
spec:
  encryptedData:
    slack-webhook: AgC...==   # kubeseal ê²°ê³¼(í‚¤: slack-webhook)
  template:
    metadata:
      name: argocd-notifications-secret
      namespace: argocd
    type: Opaque
```

### ìƒì„± ì ˆì°¨(ë¡œì»¬ì—ì„œ 1íšŒ)

```bash
# ì›ë¬¸ Secret (íŒŒì¼ë¡œ ì¶œë ¥)
kubectl -n argocd create secret generic argocd-notifications-secret \
  --from-literal=slack-webhook='https://hooks.slack.com/services/T000/B000/XXXX' \
  --dry-run=client -o yaml > /tmp/argocd-noti-secret.yaml

# seal (ì»¨íŠ¸ë¡¤ëŸ¬ ì´ë¦„/ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì‹¤ì œ ì„¤ì¹˜ê°’ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨)
kubeseal --controller-name sealed-secrets \
         --controller-namespace kube-system \
         -o yaml < /tmp/argocd-noti-secret.yaml \
  > bootstrap/notifications/secret-sealed.yaml
```

> ê¸°ì¡´ ë ˆí¬ì˜ ë‹¤ë¥¸ SealedSecretë“¤ê³¼ ë™ì¼í•˜ê²Œ controller-name/namespaceë¥¼ ë§ì¶°ì•¼ ë³µí˜¸í™”ë©ë‹ˆë‹¤.
> 

---

## 4ï¸âƒ£ í…œí”Œë¦¿/íŠ¸ë¦¬ê±°/êµ¬ë…(ConfigMap) â€” **í•œ ê³³ì—ì„œ ì¼ì›í™”**

```yaml
# bootstrap/notifications/cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # UI ë§í¬ ë“± ê³µìš© ì»¨í…ìŠ¤íŠ¸
  context: |
    argocdUrl: https://argocd.local

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì±„ë„(ì›¹í›…) ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  service.webhook.slack_webhook: |
    url: $slack-webhook
    headers:
    - name: Content-Type
      value: application/json

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…œí”Œë¦¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  template.send-slack-status: |
    webhook:
      slack_webhook:
        method: POST
        body: |
          {
            "text": "*[{{.app.metadata.name}}]* Sync *{{.app.status.sync.status}}* â†’ Health *{{.app.status.health.status}}*\nÂ· Rev: `{{.app.status.sync.revision}}`\n<{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>"
          }

  template.send-slack-failed: |
    webhook:
      slack_webhook:
        method: POST
        body: |
          {
            "text": "*[{{.app.metadata.name}}]* âŒ Sync *Failed*\nÂ· Phase: `{{.app.status.operationState.phase}}`\nÂ· Msg: `{{.app.status.operationState.message}}`\n<{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>"
          }

  template.send-slack-degraded: |
    webhook:
      slack_webhook:
        method: POST
        body: |
          {
            "text": "*[{{.app.metadata.name}}]* âš ï¸ Health *Degraded*\nÂ· Health: `{{.app.status.health.status}}`, Sync: `{{.app.status.sync.status}}`\n<{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>"
          }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger.on-sync-status-change: |
    - when: app.status.sync.status in ['Synced', 'OutOfSync']
      send: [send-slack-status]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [send-slack-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [send-slack-degraded]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ êµ¬ë…(ë””í´íŠ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  subscriptions: |
    - recipients:
        - slack_webhook
      triggers:
        - on-sync-status-change
        - on-sync-failed
        - on-health-degraded
```

> í•µì‹¬ í¬ì¸íŠ¸
> 
> - Webhook í‚¤ ì´ë¦„ì€ **`slack-webhook`** (SealedSecretì˜ data í‚¤ì™€ ì¼ì¹˜)
> - ìˆ˜ì‹  ëŒ€ìƒì€ **ì±„ë„ëª… ëŒ€ì‹  `slack_webhook`**(service.webhook ì‹ë³„ì)ìœ¼ë¡œ êµ¬ë…

---

## 5ï¸âƒ£ Argo CD Project & Application (GitOpsë¡œ ê´€ë¦¬)

```yaml
# apps/project-notifications.yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: notifications
  namespace: argocd
spec:
  description: Project for Argo CD Notifications
  sourceRepos:
    - 'https://github.com/keonhoban/mlops-infra-gitops'
  destinations:
    - namespace: argocd
      server: https://kubernetes.default.svc
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'
  orphanedResources:
    warn: true
```

```yaml
# apps/notifications.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: notifications
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: notifications
  source:
    repoURL: https://github.com/keonhoban/mlops-infra-gitops
    targetRevision: main
    path: bootstrap/notifications
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

## 6ï¸âƒ£ ì ìš© & ê²€ì¦ ì‹œí€€ìŠ¤

```bash
# 1) í”„ë¡œì íŠ¸/ì•± ì ìš©
kubectl -n argocd apply -f apps/project-notifications.yaml
kubectl -n argocd apply -f apps/notifications.yaml

# 2) ë™ê¸°í™”/ìƒíƒœ
argocd app sync notifications --grpc-web
argocd app get  notifications

# 3) ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œê·¸(ì´ìƒ ì‹œ)
kubectl -n argocd logs deploy/argocd-notifications-controller
```

**ì •ìƒ ì§€í‘œ**

- `notifications` ì•±ì´ **Synced/Healthy**
- í…œí”Œë¦¿ ë³€ê²½ â†’ ì»¤ë°‹/í‘¸ì‹œ ì‹œ, **Slackì— Sync/Health ë©”ì‹œì§€** ìˆ˜ì‹ 

---

## 7ï¸âƒ£ ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ]  `argocd-notifications-secret` **SealedSecret**ê°€ `argocd` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì •ìƒ ë³µí˜¸í™”
- [ ]  ConfigMapì˜ **service.webhook.slack_webhook** â†” **SealedSecret í‚¤(slack-webhook)** ì¼ì¹˜
- [ ]  Argo CD **Notifications Controller**ê°€ ì‹¤í–‰ ì¤‘(Argo 2.6+ ê¸°ë³¸ í¬í•¨)
- [ ]  `context.argocdUrl`ì´ ì‹¤ì œ ì ‘ì† URLê³¼ ì¼ì¹˜
- [ ]  (ì˜µì…˜) ì•±ë³„ë¡œ **ë³„ë„ êµ¬ë…**ì„ ë‘ê³  ì‹¶ìœ¼ë©´ `subscriptions`ë¥¼ ë‹¤ì¤‘ í•­ëª©ìœ¼ë¡œ ë¶„ë¦¬

---

## ğŸ§© íŒ

- **Bot Token ëª¨ë“œ**ë¡œ ì „í™˜í•˜ë©´ ë©˜ì…˜/ìŠ¤ë ˆë“œ/ì´ëª¨ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì‰¬ì›Œì§ (`service.slack:` ì‚¬ìš©)
- ì•±ë³„ **ë‹¤ë¥¸ ì±„ë„**: `service.webhook.slack_teamA`, `..._teamB` ì¶”ê°€ í›„ `subscriptions` ë¶„ê¸°
- ë©”ì‹œì§€ì— **ì»¤ë°‹ SHA/ë§í¬** í¬í•¨: `{{.app.status.sync.revision}}` ì‚¬ìš©

---

## ğŸ ì •ë¦¬

> Slack Webhookì„ **SealedSecret**ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê³ ,
> 
> 
> **ConfigMap í•œ ì¥**ì— í…œí”Œë¦¿/íŠ¸ë¦¬ê±°/êµ¬ë…ì„ ì„ ì–¸,
> 
> **ì»¤ë°‹ â†’ Sync â†’ Slack ì•Œë¦¼** ìë™ ë£¨í”„ë¡œ GitOps ê°€ì‹œì„±ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤.
>
