+++
date = '2025-07-26T17:10:21+09:00'
draft = false
title = '[MLOps Ïö¥ÏòÅ Í≥†ÎèÑÌôî - 2Îã®Í≥Ñ: Slack Alert ÌÜµÌï© (FastAPI¬∑Airflow Í≥µÏö©)]'
categories = ['MLOps Pipeline', 'FastAPI', 'Airflow', 'Kubernetes', 'Helm', 'Slack']
+++

## Slack Alert ÌÜµÌï©: FastAPI¬∑Airflow Í≥µÏö© Íµ¨Ï°∞ + ÌÖúÌîåÎ¶ø ÌôïÏû• Í∏∞Î∞ò

---

## üß† ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Î™Ö

> ‚ÄúÏö¥ÏòÅ ÌôòÍ≤ΩÏóêÏÑú Í∞ÄÏû• Î¨¥ÏÑúÏö¥ Í±¥ **Î¨∏Ï†úÍ∞Ä ÏÉùÍ≤ºÎäîÎç∞ ÏïÑÎ¨¥ÎèÑ Î™®Î•¥Í≥† ÏûàÎäî ÏÉÅÌô©**ÏûÖÎãàÎã§.‚Äù
> 
> 
> ‚ÄúÍ∑∏ÎûòÏÑú 2Îã®Í≥ÑÏóêÏÑúÎäî FastAPIÏôÄ AirflowÍ∞Ä Í∞ÅÏûê Ìù©Ïñ¥Ï†∏ Î≥¥ÎÇ¥Îçò ÏïåÎ¶ºÏùÑ
> 
> **ÌïòÎÇòÏùò Slack Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Î°ú ÏôÑÏ†ÑÌûà ÌÜµÌï©**ÌñàÏäµÎãàÎã§.‚Äù
> 
> ‚ÄúÎ™®Îç∏ ÌïôÏäµ¬∑Îì±Î°ù¬∑ÏÑºÏÑú¬∑Ìï´Ïä§Ïôë¬∑Ìó¨Ïä§Ï≤¥ÌÅ¨ÍπåÏßÄ
> 
> Ïñ¥ÎîîÏóêÏÑú Î¨¥Ïä® ÏùºÏù¥ ÏùºÏñ¥ÎÇòÎèÑ **Ï¶âÏãú ÎààÏóê Îì§Ïñ¥Ïò§ÎèÑÎ°ù ÎßåÎìúÎäî Í≤É**,
> 
> Í∑∏Í≤å Ïù¥ Îã®Í≥ÑÏùò ÌïµÏã¨ Î™©Ï†ÅÏù¥ÏóàÏäµÎãàÎã§.‚Äù
> 

---

## üéØ ÌïµÏã¨ ÏöîÏïΩ

- FastAPIÏôÄ AirflowÍ∞Ä Í≥µÌÜµ Ìï®Ïàò `send_slack_alert(text)`Î•º ÏÇ¨Ïö©Ìï¥ ÏïåÎ¶º Ï≤¥Í≥ÑÎ•º ÌÜµÌï©
- AirflowÎäî **Ï†ÑÏó≠ Ïã§Ìå® ÏΩúÎ∞±** `alert_slack(context)`Î°ú DAG/Task Ïã§Ìå® ÏûêÎèô ÌÜµÎ≥¥
- Webhook URLÏùÄ SealedSecret ‚Üí ÌôòÍ≤ΩÎ≥ÄÏàò(`SLACK_WEBHOOK_URL`)Î°ú Ï£ºÏûÖ
- dev(`.local`) / prod(`.prod`) ÌôòÍ≤Ω ÏôÑÏ†Ñ Î∂ÑÎ¶¨: ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§¬∑ÏãúÌÅ¨Î¶ø¬∑ÎèÑÎ©îÏù∏ Í∞ÅÍ∞Å ÎåÄÏùë

---

## 1Ô∏è‚É£ Íµ¨Ï°∞ Í∞úÏöî

| Íµ¨ÏÑ± ÏöîÏÜå | Ïó≠Ìï† |
| --- | --- |
| **Í≥µÏö© Ìï®Ïàò** | `send_slack_alert(text)` ‚Äî FastAPI¬∑Airflow Î™®ÎëêÏóêÏÑú Ìò∏Ï∂ú |
| **Airflow Ï†ÑÏó≠ ÏΩúÎ∞±** | `alert_slack(context)` ‚Äî DAG Ïã§Ìå® Ïãú ÏûêÎèô Ìò∏Ï∂ú |
| **ÌôòÍ≤Ω Ï£ºÏûÖ Î∞©Ïãù** | `slack-webhook-{env}-secret` ‚Üí `SLACK_WEBHOOK_URL` |
| **Î∂ÑÎ¶¨ ÏõêÏπô** | dev/prod ÏôÑÏ†Ñ Î∂ÑÎ¶¨ (ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§¬∑ÏãúÌÅ¨Î¶ø¬∑ÎèÑÎ©îÏù∏) |

---

## 2Ô∏è‚É£ ÏãúÏä§ÌÖú ÌùêÎ¶ÑÎèÑ

![mermaid-02.png](/mlops-journey/images/mermaid-02.png)

---

## 3Ô∏è‚É£ FastAPI ÏïåÎ¶º Î™®Îìà

```python
# charts/fastapi/app/utils/slack_alerts.py
import requests
import os

def send_slack_alert(text: str):
    slack_url = os.environ.get("SLACK_WEBHOOK_URL")
    if not slack_url:
        print("[Slack Alert] SKIP: SLACK_WEBHOOK_URL not set")
        return

    try:
        res = requests.post(slack_url, json={"text": text}, timeout=5)
        res.raise_for_status()
    except Exception as e:
        print(f"[Slack Alert Error] {e}")
```

> ÏÇ¨Ïö© ÏòàÏãú:
> 
> - FastAPI ÏÑúÎ≤Ñ ÏãúÏûë/Ìó¨Ïä§ Ï≤¥ÌÅ¨
> - `/variant/{alias}/reload` Ìï´Ïä§Ïôë ÏÑ±Í≥µ¬∑Ïã§Ìå®
> - ÏòàÏ∏° Ï≤òÎ¶¨ Ï§ë ÏòàÏô∏ Î∞úÏÉù Ïãú

---

## 4Ô∏è‚É£ Airflow ÏïåÎ¶º Î™®Îìà

```python
# dags/utils/slack_alerts.py
import os
import requests

def send_slack_alert(text: str) -> None:
    slack_url = os.environ.get("SLACK_WEBHOOK_URL")
    if not slack_url:
        print("[Slack Alert] SKIP: SLACK_WEBHOOK_URL not set")
        return
    try:
        res = requests.post(slack_url, json={"text": text}, timeout=5)
        res.raise_for_status()
    except Exception as e:
        print(f"[Slack Alert Error] {e}")

def alert_slack(context) -> None:
    dag = context.get("dag")
    ti = context.get("task_instance")
    dag_id = getattr(dag, "dag_id", "unknown")
    task_id = getattr(ti, "task_id", "unknown")
    execution_ts = context.get("ts")
    run_id = context.get("run_id")
    base_url = os.environ.get("AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL", "").rstrip("/")

    log_url = f"{base_url}/dags/{dag_id}/runs/{run_id}/tasks/{task_id}" if base_url else "(base_url unset)"
    text = (
        "*üî• Airflow DAG Ïã§Ìå® ÏïåÎ¶º!*\n"
        f"*DAG*: `{dag_id}`\n"
        f"*Task*: `{task_id}`\n"
        f"*Time*: `{execution_ts}`\n"
        f"*Log*: <{log_url}|Î°úÍ∑∏ Î∞îÎ°úÍ∞ÄÍ∏∞>"
    )
    send_slack_alert(text)

```

> Î™®Îì† DAGÏóê on_failure_callback=alert_slack Ï†ÅÏö©
> 
> 
> ‚Üí Ïã§Ìå® Ïãú Î°úÍ∑∏ ÎßÅÌÅ¨ Ìè¨Ìï® Î©îÏãúÏßÄ ÏûêÎèô Ï†ÑÏÜ°
> 

---

## 5Ô∏è‚É£ Helm Values (dev/prod)

### ‚ñ∂ FastAPI(dev)

```yaml
# charts/fastapi/values/dev.yaml
env:
  MLFLOW_TRACKING_URI: "http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000"
  MODEL_NAME: "best_model"
  DEFAULT_ALIAS: "B"
  ALIAS_SELECTION_MODE: "blue_green"
  CANARY_PERCENT: "20"
  LOG_TO_STDOUT: "true"
  LOG_LEVEL: "info"
envFrom:
  - secretRef: { name: aws-credentials-secret }
  - secretRef: { name: fastapi-token-dev-secret }
  - secretRef: { name: slack-webhook-dev-secret }
```

### ‚ñ∂ FastAPI(prod)

```yaml
# charts/fastapi/values/prod.yaml
env:
  MLFLOW_TRACKING_URI: "http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000"
  MODEL_NAME: "best_model"
  DEFAULT_ALIAS: "B"
  ALIAS_SELECTION_MODE: "blue_green"
  CANARY_PERCENT: "10"
  LOG_TO_STDOUT: "true"
  LOG_LEVEL: "info"
envFrom:
  - secretRef: { name: aws-credentials-secret }
  - secretRef: { name: fastapi-token-prod-secret }
  - secretRef: { name: slack-webhook-prod-secret }
```

### ‚ñ∂ Airflow(dev)

```yaml
# charts/airflow/values/dev.yaml
airflow:
  config:
    AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL:
      value: "http://airflow.local"

  scheduler: &dev_scheduler
    env:
      - name: SLACK_WEBHOOK_URL
        valueFrom:
          secretKeyRef:
            name: slack-webhook-dev-secret
            key: SLACK_WEBHOOK_URL
      - name: FASTAPI_RELOAD_URL
        value: "http://fastapi-dev-service.fastapi-dev.svc.cluster.local"
      - name: MLFLOW_TRACKING_URI
        value: "http://mlflow-dev-service.mlflow-dev.svc.cluster.local:5000"

  workers: *dev_scheduler
  dagProcessor: *dev_scheduler
```

### ‚ñ∂ Airflow(prod)

```yaml
# charts/airflow/values/prod.yaml
airflow:
  config:
    AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL:
      value: "http://airflow.prod"

  scheduler: &prod_scheduler
    env:
      - name: SLACK_WEBHOOK_URL
        valueFrom:
          secretKeyRef:
            name: slack-webhook-prod-secret
            key: SLACK_WEBHOOK_URL
      - name: FASTAPI_RELOAD_URL
        value: "http://fastapi-prod-service.fastapi-prod.svc.cluster.local"
      - name: MLFLOW_TRACKING_URI
        value: "http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000"

  workers: *prod_scheduler
  dagProcessor: *prod_scheduler
```

---

## 6Ô∏è‚É£ SealedSecret ÏòàÏãú

```yaml
# envs/dev/sealed-secrets/airflow/sealed-slack-webhook-dev-secret.yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: slack-webhook-dev-secret
  namespace: airflow-dev
spec:
  encryptedData:
    SLACK_WEBHOOK_URL: <sealed payload>
  template:
    type: Opaque
```

---

## 7Ô∏è‚É£ Slack Î©îÏãúÏßÄ ÏòàÏãú

| ÏÉÅÌô© | ÏòàÏãú Î©îÏãúÏßÄ |
| --- | --- |
| FastAPI Ìï´Ïä§Ïôë ÏÑ±Í≥µ | üîÅ [FastAPI] Î™®Îç∏ @A Ìï´Ïä§Ïôë ÏôÑÎ£å v9 (run_id=...) |
| FastAPI Ìó¨Ïä§ Ï≤¥ÌÅ¨ Í≤ΩÍ≥† | ‚ö†Ô∏è [FastAPI] degraded (loaded=['A'], missing=['B']) |
| Airflow Îì±Î°ù ÏÑ±Í≥µ | ‚úÖ [Airflow] Î™®Îç∏ Îì±Î°ù: my_model v12 ‚Üí @A |
| Airflow ÏÑºÏÑú Ïã§Ìå® | ‚ùå [Airflow] READY Í∞êÏßÄ Ïã§Ìå®: my_model v12 |
| DAG Ï†ÑÏó≠ Ïã§Ìå® | üî• Airflow DAG Ïã§Ìå® ÏïåÎ¶º (Task=check_model_ready) |

---

## 8Ô∏è‚É£ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

- [ ]  `SLACK_WEBHOOK_URL` dev/prod Í∞ÅÍ∞Å Ï£ºÏûÖ ÌôïÏù∏
- [ ]  Airflow DAGÏóê `on_failure_callback=alert_slack` ÏÑ§Ï†ï Ïú†ÏßÄ
- [ ]  FastAPI Ï£ºÏöî Ïù¥Î≤§Ìä∏(Ìï´Ïä§Ïôë¬∑Ìó¨Ïä§¬∑Í∏∞Îèô)Ïóê `send_slack_alert()` Ìò∏Ï∂ú
- [ ]  Airflow Í∞Å Îã®Í≥Ñ(Task)ÏóêÏÑúÎèÑ `send_slack_alert()` Ìò∏Ï∂ú
- [ ]  Secret Ïù¥Î¶Ñ(`slack-webhook-{env}-secret`)Ïù¥ Helm envFromÍ≥º ÏùºÏπò

---

## üß© ÌåÅ

- Slack Ï†ÑÏÜ° Ïã§Ìå® Ïãú **ÏÑúÎπÑÏä§ Î°úÏßÅ Ï∞®Îã® Í∏àÏßÄ** ‚Äî ÎÑ§Ìä∏ÏõåÌÅ¨ Ïû•Ïï†Í∞Ä Î™®Îç∏ ÏÑúÎπôÏùÑ ÎßâÏßÄ ÏïäÍ≤å
- Î∞∞Ìè¨ Ï†Ñ **Webhook Secret Î∂àÏùºÏπò** Ïó¨Î∂ÄÎ•º devÏóêÏÑú Î∞òÎìúÏãú Ï†êÍ≤Ä

---

## üèÅ Ï†ïÎ¶¨

> Ïù¥Ï†ú FastAPIÏôÄ AirflowÍ∞Ä ÌïòÎÇòÏùò Slack Ïù∏ÌÑ∞ÌéòÏù¥Ïä§Î°ú ÌÜµÌï©ÎêòÏóàÏäµÎãàÎã§.
> 
> 
> Îã®Ïùº Ìï®Ïàò(`send_slack_alert`)ÎßåÏúºÎ°ú ÌïôÏäµ¬∑Îì±Î°ù¬∑Ìï´Ïä§Ïôë Ï†Ñ Íµ¨Í∞ÑÏùò Í¥ÄÏ†ú ÏïåÎ¶ºÏùÑ Ïó∞Í≤∞Ìï† Ïàò ÏûàÏúºÎ©∞,
> 
> ÌôòÍ≤Ω Î∂ÑÎ¶¨Î•º Ïú†ÏßÄÌïòÎ©¥ÏÑúÎèÑ Ïã§ÏãúÍ∞Ñ Ïö¥ÏòÅ Î™®ÎãàÌÑ∞ÎßÅÏù¥ Í∞ÄÎä•Ìï¥Ï°åÏäµÎãàÎã§.
>
