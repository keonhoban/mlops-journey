+++
date = '2025-09-15T17:10:21+09:00'
draft = false
title = '[MLOps ìš´ì˜ ê³ ë„í™” - 8ë‹¨ê³„: CI/CD ìš´ì˜ ìë™í™” (GitHub ActionsÂ·Helm Lint)]'
categories = ['MLOps Pipeline', 'Kubernetes', 'Helm', 'Git', 'GitOps(ArgoCD)', 'CI/CD']
+++

## CI/CD & ìš´ì˜ ìë™í™”: GitHub Actions Â· Helm Lint Â· Canary í…ŒìŠ¤íŠ¸

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ê³ ëŠ” ëŒ€ë¶€ë¶„ **ë°°í¬ ì „ì— ì²´í¬ë˜ì§€ ëª»í•œ ë¬¸ì œ**,
> 
> 
> **ìˆ˜ë™ ë°°í¬ì˜ ì‹¤ìˆ˜**, **ë°°í¬ í›„ ê²€ì¦ ë¶€ì¬**ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.â€
> 
> â€œê·¸ë˜ì„œ ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” ì•„ì˜ˆ CI ë‹¨ê³„ì—ì„œ ë¬¸ì œë¥¼ ë§‰ê³ ,
> 
> CDì—ì„œëŠ” GitOpsê°€ ì›í•˜ëŠ” ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ë³´ì¥í•˜ë©°,
> 
> ë°°í¬ ì§í›„ FastAPI aliasë¡œ **ëª¨ë¸ íŠ¸ë˜í”½ê¹Œì§€ ìë™ ê²€ì¦ë˜ëŠ” êµ¬ì¡°**ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.â€
> 
> â€œì´ ë‹¨ê³„ê°€ ì™„ì„±ë˜ë©´ í•˜ë‚˜ì˜ ì»¤ë°‹ì´
> 
> **ê²€ì¦ â†’ ë°°í¬ â†’ ì‹¤í—˜ â†’ ì•Œë¦¼**ê¹Œì§€ ìŠ¤ìŠ¤ë¡œ íë¥´ëŠ”
> 
> ìš´ì˜í˜• MLOpsì˜ í•µì‹¬ ìë™í™” ë£¨í”„ê°€ ì™„ì„±ë©ë‹ˆë‹¤.â€
> 

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

- **Helm Lint(strict) + kubeconform + yamllint**ë¡œ PR ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜/ì˜¤íƒˆì ì°¨ë‹¨
- *GitHub Actions â†’ ArgoCD(ApplicationSet)**ë¡œ **GitOps ë°°í¬ ìë™í™”**
- **A/B Â· Canary Â· Blue-Green**ì„ **FastAPI alias** ê¸°ë°˜ìœ¼ë¡œ **ë°°í¬** (ì½”ë“œ ìˆ˜ì • ì—†ì´ ì‹¤í—˜ ì „í™˜)
- **Slack ì—°ë™**ìœ¼ë¡œ CI â†’ CD â†’ ì‹¤í—˜ ê²°ê³¼ê¹Œì§€ **ì—”ë“œíˆ¬ì—”ë“œ ëª¨ë‹ˆí„°ë§**
- **â€œPR â†’ Merge â†’ Auto Deploy â†’ íŠ¸ë˜í”½ ì‹¤í—˜â€** ì™„ì „ ìë™ ì‚¬ì´í´ ğŸš€

---

## 1ï¸âƒ£ ì „ì²´ êµ¬ì¡° ìš”ì•½

![mermaid-08.png](/mlops-journey/images/mermaid-08.png)

> ì˜ë„: â€œLintë¡œ í’ˆì§ˆ ë³´ì¦ â†’ GitOpsë¡œ ìƒíƒœ ë³´ì¦ â†’ FastAPI aliasë¡œ ì‹¤í—˜ ë³´ì¦â€
> 

---

## 2ï¸âƒ£ GitHub Actions â€“ Helm CI (Advanced Validation)

**ëª©í‘œ**: PRì—ì„œ **í˜•ì‹Â·ìŠ¤í‚¤ë§ˆÂ·ìŠ¤íƒ€ì¼** ë¬¸ì œë¥¼ ì™„ì „íˆ ê±¸ëŸ¬ë‚´ê¸°

- **Helm Lint(strict)**: ê°’/í…œí”Œë¦¿ ì •í•©ì„± ê²€ì¦
- **kubeconform**: ì¿ ë²„ë„¤í‹°ìŠ¤ ìŠ¤í‚¤ë§ˆ ê²€ì¦(ì£¼ìš” ì½”ì–´ ë¦¬ì†ŒìŠ¤; CRDë¥˜ëŠ” ìŠ¤í‚µ)
- **yamllint**: ì„œì‹/ì¸ë´íŠ¸/ë¶ˆí•„ìš” ê³µë°± ê²€ì‚¬
- **envÃ—chart ë§¤íŠ¸ë¦­ìŠ¤**(dev/prod Ã— airflow/fastapi/mlflow) **ë³‘ë ¬ ê²€ì¦**

### ğŸ“ ë ˆí¬ ê¸°ì¤€

```
charts/<chart>/{Chart.yaml, templates/, values/{base.yaml,dev.yaml,prod.yaml}}
envs/{dev,prod}/...
apps/*.yaml  (Application / AppProject / ApplicationSet ë“±)
```

### âš™ï¸ ì›Œí¬í”Œë¡œ

`.github/workflows/ci-helm-validate.yaml`

```yaml
name: Helm CI

on:
  pull_request:
    paths:
      - 'charts/**'
      - 'envs/**'
      - 'apps/**'
      - '.github/workflows/ci-helm-validate.yaml'
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: helm-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Lint & Render & Validate (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, prod]
        chart: [airflow, fastapi, mlflow]

    env:
      KUBE_VERSION: "1.30.0"
      SKIP_KINDS: "Application,ApplicationSet,AppProject,SealedSecret,Certificate,CertificateRequest,Issuer,ClusterIssuer,Order,Challenge"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm (match local)
        uses: azure/setup-helm@v4
        with:
          version: v3.18.3

      - name: Install tools (yamllint, kubeconform)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y yamllint
          curl -sSL -o kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          sudo tar -C /usr/local/bin -xzf kubeconform.tar.gz kubeconform
          kubeconform -v

      - name: YAML style check (repo-wide)
        shell: bash
        run: |
          set -euo pipefail
          git ls-files -z '*.yml' '*.yaml' \
            ':!:charts/**/templates/**' \
            ':!:charts/**/charts/**' \
            ':!:envs/**/sealed-secrets/**' \
            ':!:bootstrap/notifications/secret-sealed.yaml' \
          | xargs -0 -r yamllint -s

      - name: Helm lint (strict)
        working-directory: charts/${{ matrix.chart }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f values/base.yaml && -f values/${{ matrix.env }}.yaml ]]; then
            helm lint . -f values/base.yaml -f values/${{ matrix.env }}.yaml --strict
          elif [[ -f values/${{ matrix.env }}.yaml ]]; then
            helm lint . -f values/${{ matrix.env }}.yaml --strict
          else
            helm lint . --strict
          fi

      - name: Render manifests with helm template
        id: render
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/rendered
          CHART="charts/${{ matrix.chart }}"
          OUT="/tmp/rendered/${{ matrix.chart }}-${{ matrix.env }}.yaml"
          NS="${{ matrix.chart }}-${{ matrix.env }}"

          if [[ -f "$CHART/values/base.yaml" && -f "$CHART/values/${{ matrix.env }}.yaml" ]]; then
            helm template ${{ matrix.chart }} "$CHART" -n "$NS" \
              -f "$CHART/values/base.yaml" -f "$CHART/values/${{ matrix.env }}.yaml" > "$OUT"
          elif [[ -f "$CHART/values/${{ matrix.env }}.yaml" ]]; then
            helm template ${{ matrix.chart }} "$CHART" -n "$NS" \
              -f "$CHART/values/${{ matrix.env }}.yaml" > "$OUT"
          else
            helm template ${{ matrix.chart }} "$CHART" -n "$NS" > "$OUT"
          fi

          echo "out=$OUT" >> "$GITHUB_OUTPUT"
          test -s "$OUT"

      - name: kubeconform (core K8s kinds only)
        shell: bash
        run: |
          set -euo pipefail
          kubeconform \
            -kubernetes-version "${KUBE_VERSION}" \
            -ignore-missing-schemas \
            -skip "${SKIP_KINDS}" \
            -summary \
            "${{ steps.render.outputs.out }}"

      - name: Validate env raw manifests (envs/${{ matrix.env }})
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FILES < <(find "envs/${{ matrix.env }}" -type f -name '*.yaml' ! -path "*/sealed-secrets/*")
          if (( ${#FILES[@]} )); then
            echo "Validating ${#FILES[@]} files under envs/${{ matrix.env }}"
            yamllint -s "${FILES[@]}"
            kubeconform -kubernetes-version "${KUBE_VERSION}" \
              -ignore-missing-schemas -skip "${SKIP_KINDS}" -summary "${FILES[@]}"
          else
            echo "No env files found under envs/${{ matrix.env }}"
          fi

      - name: Validate apps/ (Argo CD objects etc.)
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          FILES=(apps/*.yaml)
          if (( ${#FILES[@]} )); then
            echo "Validating ${#FILES[@]} files under apps/"
            yamllint -s "${FILES[@]}"
            kubeconform -kubernetes-version "${KUBE_VERSION}" \
              -ignore-missing-schemas -skip "${SKIP_KINDS}" -summary "${FILES[@]}"
          else
            echo "No files under apps/"
          fi

      - name: Upload rendered manifests
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: rendered-${{ matrix.chart }}-${{ matrix.env }}
          path: /tmp/rendered/${{ matrix.chart }}-${{ matrix.env }}.yaml
          if-no-files-found: warn

```

> í•µì‹¬ ë³€ê²½ ì‚¬í•­: kubeconform/yamllintê°€ envs/*ì™€ apps/*ë¥¼ ê²€ì‚¬í•˜ë„ë¡ ë¶„ë¦¬.
> 
> 
> í—¬ë¦„ ì°¨íŠ¸ íŒŒì¼ì€ `charts/` ë‚´ë¶€ íŒŒì¼ë¡œ **dev/prod ë³‘ë ¬** ê²€ì¦.
> 

---

## 3ï¸âƒ£ GitOps CD â€“ ArgoCD Auto Sync & SelfHeal

- `apps/appset-env-matrix.yaml`(ë˜ëŠ” ë™ë“±í•œ AppSet) ê¸°ë°˜ìœ¼ë¡œ **dev/prod Ã— ì•±** ìë™ ìƒì„±
- `automated.prune: true` + `selfHeal: true` ìœ ì§€ â†’ **ë“œë¦¬í”„íŠ¸ ìë™ ë³µêµ¬**

```bash
# í•„ìš” ì‹œ ìˆ˜ë™ íŠ¸ë¦¬ê±°/ì ê²€
argocd app sync dev-fastapi --prune --grpc-web
argocd app get  dev-fastapi
argocd app diff dev-fastapi
```

> ì—­í•  ë¶„ë¦¬: CIëŠ” â€œë¬¸ì œ ì°¨ë‹¨â€, ArgoCDëŠ” â€œì›í•˜ëŠ” ìƒíƒœ ë³´ì¥â€.
> 

---

## 4ï¸âƒ£ FastAPI ë¼ìš°íŒ…(ê³µí†µ ì‹¤í—˜ ë¡œì§)

```python
# app/services/alias_selector.py (ìš”ì§€)
if settings.alias_selection_mode == "ab_test":
    return "A" if hashed % 100 < 90 else "B"
elif settings.alias_selection_mode == "canary":
    return "B" if hashed % 100 < settings.canary_percent else "A"
elif settings.alias_selection_mode == "blue_green":
    return settings.default_alias
```

> alias ê¸°ë°˜ì´ë¼ ëª¨ë¸ êµì²´ëŠ” MLflow/alias ë³€ê²½ + /reloadë¡œ ì¼ì›í™”
> 
> 
> ì‹¤í—˜ ì •ì±…ì€ **í™˜ê²½ë³€ìˆ˜**ë¡œë§Œ ì œì–´ â†’ ë°°í¬ ì—†ì´ ì¦‰ì‹œ ì „í™˜ ê°€ëŠ¥
> 

---

## 5ï¸âƒ£ A/BÂ·CanaryÂ·Blue-Green í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

`/ops/rotate/` ë˜ëŠ” `/ops/`ì— ë‘ê³  ì“°ë©´ ì¢‹ìŠµë‹ˆë‹¤.

```bash
#!/bin/bash
# ab_test.sh â€” A/B/Canary/Blue-Green ë¶„í¬ ê²€ì¦
# ì‚¬ìš©: ./ab_test.sh [N]  (ê¸°ë³¸ N=200)
set -euo pipefail

N=${1:-200}
URL=${FASTAPI_URL:-"https://fastapi.local"}
PAYLOAD='{"data": [[5.1, 3.5, 1.4, 0.2]]}'

echo "ğŸ” A/BÂ·CanaryÂ·Blue-Green ë¶„í¬ í™•ì¸ (${N}ê±´)"
: > ab_test_result.log
for i in $(seq 1 $N); do
  id="client_$i"
  variant=$(curl -sk "${URL}/predict" \
    -H "Content-Type: application/json" \
    -H "x-client-id: ${id}" \
    -d "${PAYLOAD}" | jq -r '.variant')
  echo "$id â†’ $variant" | tee -a ab_test_result.log >/dev/null
done

count_B=$(grep -c "â†’ B" ab_test_result.log || true)
count_A=$((N - count_B))
ratio=$((count_B * 100 / N))
echo "ğŸ“Š ê²°ê³¼: A=${count_A}, B=${count_B} (B=${ratio}%)"
```

> ê²€ì¦ í¬ì¸íŠ¸: Canary ë¹„ìœ¨, A/B 90:10, Blue-Green 100% ì „í™˜ì´ ì‹¤ìš”ì²­ ë¶„í¬ë¡œ í™•ì¸ë¼ì•¼ í•©ê²©.
> 

---

## 6ï¸âƒ£ ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ í‘œ

| ìœ í˜• | env ë³€ìˆ˜ | ê¸°ëŒ€ ê²°ê³¼ |
| --- | --- | --- |
| **A/B** | `ALIAS_SELECTION_MODE=ab_test` | A/B â‰ˆ 90:10 |
| **Canary** | `ALIAS_SELECTION_MODE=canary`, `CANARY_PERCENT=30` | B â‰ˆ 30% |
| **Blue-Green** | `ALIAS_SELECTION_MODE=blue_green`, `DEFAULT_ALIAS=B` | B = 100% |

> MLflowì˜ alias ì¬ë°”ì¸ë”© + FastAPI /variant/{alias}/reloadë¡œ ì‹¤ë¬¼ ëª¨ë¸ì´ ì „í™˜ë¨.
> 

---

## 7ï¸âƒ£ Slack í†µí•©(ëë‹¨ê¹Œì§€ ê°€ì‹œí™”)

| êµ¬ê°„ | ë©”ì‹œì§€ ì˜ˆì‹œ | ë¹„ê³  |
| --- | --- | --- |
| **CI** | âœ… Helm Lint Passed / âŒ Lint Failed | GitHub Actions â†’ Webhook |
| **CD** | ğŸ”„ Sync ì‹œì‘ / âœ… Sync ì™„ë£Œ | 7ë‹¨ê³„ì˜ *ArgoCD Notifications* ì¬ì‚¬ìš© |
| **Test** | ğŸ“Š A/B ë¶„í¬ 48:52 (N=200) | ìŠ¤í¬ë¦½íŠ¸/íŒŒì´í”„ë¼ì¸ì—ì„œ ì „ì†¡ |

> Webhookì€ envs/*/sealed-secrets/*ë¡œ í™˜ê²½ë³„ ê´€ë¦¬(dev/prod ì±„ë„ ë¶„ë¦¬).
> 

---

## 8ï¸âƒ£ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ]  CI: **Helm Lint + kubeconform + yamllint** ëª¨ë‘ í†µê³¼
- [ ]  AppSet: **values/dev.yaml Â· prod.yaml** ì •í™•íˆ ì°¸ì¡°
- [ ]  ArgoCD: **SelfHeal + Prune** í™œì„±í™”
- [ ]  FastAPI: `/predict` ë¶„ë°° ê²°ê³¼ê°€ **ì •ì±…ê³¼ ì¼ì¹˜**
- [ ]  Slack: CI/CD/Test ì•Œë¦¼ì´ **ì ì‹œì— ë„ì°©**
- [ ]  Canary ë¹„ìœ¨/Blue-Green ì „í™˜ ì‹œ **ì‹¤ìœ ì € ë¶„í¬**ë„ ì •ìƒ
- [ ]  Secret íšŒì „ í›„ **Auto Sync ë°˜ì˜** í™•ì¸

---

## ğŸ§© íŒ

| ì¦ìƒ | ì›ì¸ | í•´ê²° |
| --- | --- | --- |
| CI í†µê³¼í–ˆëŠ”ë° ë°°í¬ ì‹¤íŒ¨ | CRD ìŠ¤í‚¤ë§ˆ ë¯¸ê²€ì¦ ì˜ì—­ | `-ignore-missing-schemas` ìœ ì§€,  ì‹¤ì œ í´ëŸ¬ìŠ¤í„°ì—ì„œ Health ì²´í¬ |
| OutOfSync ë°˜ë³µ | ì™¸ë¶€ì—ì„œ ìˆ˜ë™ ìˆ˜ì • | Git ë°˜ì˜ í›„ **SelfHeal**ë¡œ ë™ê¸°í™” |
| Slack ëˆ„ë½ | Webhook Secret ëˆ„ë½/ì˜¤íƒ€ | SealedSecret í‚¤/ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¬í™•ì¸ |
| Canary ë¶ˆê· í˜• | í•´ì‹œ ê¸°ì¤€/í—¤ë” ëˆ„ë½ | `x-client-id` ê³ ì •, ìƒ˜í”Œ ìˆ˜ ì¶©ë¶„íˆ í™•ë³´ |
| Blue-Green ë¶ˆì „í™˜ | DEFAULT_ALIAS ë¯¸ì§€ì • | values/envì— ëª…ì‹œ & `/reload` í™•ì¸ |

---

## âœ… ìš”ì•½

| ì˜ì—­ | ìë™í™” ìˆ˜ì¤€ | ìŠ¤íƒ |
| --- | --- | --- |
| **CI** | ì •ì  ê²€ì¦/ì°¨ë‹¨ | GitHub Actions, Helm, kubeconform, yamllint |
| **CD** | GitOps ë™ê¸°í™” | ArgoCD, ApplicationSet |
| **ì‹¤í—˜** | íŠ¸ë˜í”½ ë¶„ë¦¬ | A/B, Canary, Blue-Green(í™˜ê²½ë³€ìˆ˜ ì œì–´) |
| **ê´€ì œ** | ì „êµ¬ê°„ í”¼ë“œë°± | Slack Webhook/Notifications |
| **ë³µêµ¬** | ìë™ ë³µì›/ë¡¤ë°± | SelfHeal, ë¡¤ë°± DAG(3ë‹¨ê³„) |

---

## ğŸ ì •ë¦¬

> ì´ì œ íŒŒì´í”„ë¼ì¸ì€ í•˜ë‚˜ì˜ ì»¤ë°‹ìœ¼ë¡œ
> 
> 
> **ê²€ì¦ â†’ ë°°í¬ â†’ ì‹¤í—˜ â†’ ê´€ì œ**ê¹Œì§€ ììœ¨ ì£¼í–‰í•©ë‹ˆë‹¤.
> 
> ëª¨ë¸ êµì²´ëŠ” **MLflow alias**ë¡œ í†µì¼ë˜ê³ , ëŸ°íƒ€ì„ ë°˜ì˜ì€ **/reload**ê°€ ì±…ì„ì§‘ë‹ˆë‹¤.
>
