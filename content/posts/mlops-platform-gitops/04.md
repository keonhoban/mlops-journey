+++
date = '2025-08-01T12:15:21+09:00'
draft = false
title = '[MLOps ìš´ì˜ ê³ ë„í™” - 3ë‹¨ê³„: ëª¨ë¸ ë¡¤ë°± ìžë™í™” (ë“±ë¡ ì‹¤íŒ¨ ëŒ€ë¹„ ë³µêµ¬)]'
categories = ['MLOps Pipeline', 'FastAPI', 'MLflow', 'Airflow', 'Kubernetes', 'Helm']
+++

## ëª¨ë¸ ë¡¤ë°± ìžë™í™”: ë“±ë¡ ì‹¤íŒ¨ ëŒ€ë¹„ ë³µêµ¬ ë£¨í”„ ì™„ì„±

---

## ðŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œëª¨ë¸ ë°°í¬ëŠ” ì„±ê³µí–ˆì„ ë•Œë³´ë‹¤, **ì‹¤íŒ¨í–ˆì„ ë•Œì˜ íšŒë³µ ì†ë„**ê°€ ìš´ì˜ í’ˆì§ˆì„ ê²°ì •í•©ë‹ˆë‹¤.â€
> 
> 
> â€œê·¸ëž˜ì„œ 3ë‹¨ê³„ì—ì„œëŠ” ë“±ë¡ì´ ì‹¤íŒ¨í•˜ëŠ” ì¦‰ì‹œ,
> 
> ì´ì „ ì•ˆì • ë²„ì „ìœ¼ë¡œ ëŒì•„ê°€ FastAPIì— ìžë™ ë°˜ì˜ë˜ëŠ” **ì™„ì „í•œ ë¡¤ë°± ë£¨í”„**ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.â€
> 
> â€œì´ êµ¬ì¡°ê°€ ìžˆì–´ì•¼ ìž¥ì•  ìƒí™©ì—ì„œë„ ì„œë¹„ìŠ¤ê°€ **ëŠê¸°ì§€ ì•Šê³  ë°”ë¡œ ë³µêµ¬**ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.â€
> 

---

## ðŸŽ¯ í•µì‹¬ ìš”ì•½

- **ë“±ë¡ ì‹¤íŒ¨ â†’ ì¦‰ì‹œ ë¡¤ë°±**: ì‹œë„ ì§ì „ **`before_version`**(aliasê°€ ê°€ë¦¬í‚¤ë˜ ë²„ì „)ìœ¼ë¡œ ë³µê·€
- **READY ê²€ì¦ â†’ alias ìž¬í• ë‹¹ â†’ FastAPI `/reload`** ê¹Œì§€ ìžë™ ìˆ˜í–‰(ì‹¤ì„œë¹„ìŠ¤ ë°˜ì˜ ë³´ìž¥)
- **ìˆ˜ë™ ë¡¤ë°± ì „ìš© DAG** ì œê³µ(ìš´ì˜ìžê°€ ëŒ€ìƒ ë²„ì „ ëª…ì‹œ)
- **Slack/ë¡œê·¸ ì¶”ì **(ì„±ê³µ/ì‹¤íŒ¨/ë³µêµ¬ êµ¬ë¶„), ì‹¤íŒ¨ëŠ” **re-raise**ë¡œ ì›ì¸ ëª…í™•í™”

---

## 1ï¸âƒ£ í”Œë¡œìš° í•œ ìž¥ ìš”ì•½

![mermaid-03.png](/mlops-journey/images/mermaid-03.png)

---

## 2ï¸âƒ£ ìžë™ ë¡¤ë°±(ë“±ë¡ íƒœìŠ¤í¬ ë‚´ë¶€) â€” `/reload`ê¹Œì§€ í¬í•¨

> ì˜ë„: ì„œë¹„ìŠ¤ ê°€ìš©ì„± ìµœìš°ì„ . ë“±ë¡ ì‹¤íŒ¨ ë¶„ê¸°ì—ì„œ ì¦‰ì‹œ ë¡¤ë°± + FastAPI ë°˜ì˜ í›„, ì˜ˆì™¸ëŠ” ìž¬ì „íŒŒí•´ ì›ì¸ ê¸°ë¡.
> 

```python
# dags/dag_ml_train_register_reload.py (ë°œì·Œ: register_model_task)

from mlflow.tracking import MlflowClient
from utils.slack_alerts import send_slack_alert
from ml_code.register_model import register_model
from ml_code.rollback_model import rollback_model
from ml_code.trigger_reload import trigger_reload

def get_version_by_alias(model_name, alias):
    try:
        return MlflowClient().get_model_version_by_alias(model_name, alias).version
    except Exception:
        return None

def register_model_task(ti, **_):
    run_id = ti.xcom_pull(task_ids="train_and_evaluate", key="run_id")
    model_name = ti.xcom_pull(task_ids="train_and_evaluate", key="model_name")
    alias = ti.xcom_pull(task_ids="train_and_evaluate", key="alias")

    prev_version = get_version_by_alias(model_name, alias)  # before_version

    try:
        version = register_model(run_id, model_name, alias)
        ti.xcom_push(key="version", value=version)
        send_slack_alert(f"âœ… ëª¨ë¸ ë“±ë¡ ì™„ë£Œ: {model_name} v{version} â†’ @{alias}")
    except Exception as e:
        msg = f"âŒ ëª¨ë¸ ë“±ë¡ ì‹¤íŒ¨: {e}"
        try:
            if prev_version:
                rollback_model(model_name, prev_version, alias)   # alias ë˜ëŒë¦¬ê¸°
                trigger_reload(alias)                              # FastAPI ë°˜ì˜
                msg += f" â†’ ë¡¤ë°± ì™„ë£Œ ë° /reload ë°˜ì˜: v{prev_version}"
            else:
                msg += " â†’ ë¡¤ë°± ìƒëžµ(ì´ì „ ë²„ì „ ì—†ìŒ)"
        except Exception as rr_e:
            msg += f" â†’ ë¡¤ë°±/ë°˜ì˜ ì¶”ê°€ ì‹¤íŒ¨: {rr_e}"
        finally:
            send_slack_alert(msg)
        raise  # DAG ì‹¤íŒ¨ë¡œ ë‚¨ê²¨ ì›ì¸ ì¶”ì (ì „ì—­ ì‹¤íŒ¨ ì½œë°± ë™ìž‘)

```

---

## 3ï¸âƒ£ ë¡¤ë°± í•¨ìˆ˜(ëª…ì‹œí˜•) â€” READY ê°•ì œ & ë™ì¼ ë²„ì „ ì†ŒìŒ ì œê±°

> ëŒ€ìƒ ë²„ì „ì´ READYì¸ì§€ í™•ì¸ í›„ aliasë¥¼ ìž¬í• ë‹¹í•©ë‹ˆë‹¤.
> 

```python
# ml_code/rollback_model.py

import mlflow
from ml_code.config import get_mlflow_client
from mlflow.exceptions import MlflowException
from airflow.utils.log.logging_mixin import LoggingMixin

logger = LoggingMixin().log

def rollback_model(model_name: str, version: str, alias: str):
    try:
        if not model_name or not version or not alias:
            raise ValueError("âŒ model_name / version / alias ê°’ì´ ë¹„ì–´ìžˆìŒ")

        client = get_mlflow_client()

        current_version = client.get_model_version_by_alias(model_name, alias).version
        if str(current_version) == str(version):
            raise RuntimeError(f"[Rollback] ì´ë¯¸ @{alias} â†’ v{version} ìƒíƒœ")

        # âœ… ëŒ€ìƒ ë²„ì „ READY ìƒíƒœ í™•ì¸
        model_info = client.get_model_version(name=model_name, version=version)
        if model_info.status != "READY":
            raise RuntimeError(f"[Rollback] ëŒ€ìƒ ë²„ì „ READY ì•„ë‹˜ â†’ í˜„ìž¬: {model_info.status}")

        # âœ… ê¸°ì¡´ alias ì‚­ì œ í›„ ëŒ€ìƒ ë²„ì „ì— ìž¬í• ë‹¹
        client.delete_registered_model_alias(model_name, alias)
        client.set_registered_model_alias(model_name, alias, version)

        logger.info(f"[Rollback] ì„±ê³µ: @{alias} â†’ v{version}")

    except MlflowException as e:
        raise RuntimeError(f"[Rollback Error] MLflow ì˜ˆì™¸ ë°œìƒ: {e}") from e
    except Exception as e:
        logger.error(f"[Rollback Error] {e}")
        raise
```

---

## 4ï¸âƒ£ FastAPI ë°˜ì˜ íŠ¸ë¦¬ê±° â€” ê³„ì•½(ì‘ë‹µ ê·œì•½) ì¼ì¹˜

> ë‚´ë¶€ ì„¤ì • í—¬í¼ë¥¼ ì‚¬ìš©í•´ URLÂ·í† í°ì„ ë¶ˆëŸ¬ì˜¤ë©°, ì‘ë‹µì€ status == "success" ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤.
> 
> 
> (íƒ€ìž„ì•„ì›ƒ 5ì´ˆ)
> 

```python
# ml_code/trigger_reload.py

import requests
from ml_code.config import get_fastapi_reload_url, get_reload_token
from airflow.utils.log.logging_mixin import LoggingMixin

logger = LoggingMixin().log

def trigger_reload(variant="A"):
    base_url = get_fastapi_reload_url()
    token = get_reload_token()

    try:
        url = f"{base_url}/variant/{variant}/reload"
        res = requests.post(url, headers={"x-token": token}, timeout=5)

        if res.status_code != 200:
            raise Exception(f"FastAPI reload ì‹¤íŒ¨: {res.status_code} {res.text}")

        json_resp = res.json()
        if json_resp.get("status") != "success":
            raise Exception(f"FastAPI reload ì‹¤íŒ¨ (ì‘ë‹µ ë¬¸ì œ): {json_resp}")

        logger.info(f"[Reload ì„±ê³µ] variant={variant} â†’ {json_resp}")
        return json_resp

    except Exception as e:
        raise RuntimeError(f"ðŸ”¥ ëª¨ë¸ reload ì‹¤íŒ¨: {e}")
```

> FastAPI /variant/{alias}/reloadëŠ” ë°˜ë“œì‹œ {"status":"success", ...} í˜•íƒœë¡œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.
> 

---

## 5ï¸âƒ£ ìˆ˜ë™ ë¡¤ë°± DAG â€” ìš´ì˜ìž ì§€ì •í˜•(+`/reload` í¬í•¨)

```python
# dags/dag_model_rollback.py

from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.models import Variable
from datetime import datetime, timedelta
from pendulum import timezone
from ml_code.rollback_model import rollback_model
from ml_code.trigger_reload import trigger_reload
from utils.slack_alerts import alert_slack, send_slack_alert

kst = timezone("Asia/Seoul")
default_args = {"start_date": datetime(2024, 1, 1, tzinfo=kst), "retries": 1, "retry_delay": timedelta(minutes=1)}

def dag_rollback():
    model_name = Variable.get("rollback_model_name")
    version = Variable.get("rollback_version")
    alias = Variable.get("rollback_alias")
    rollback_model(model_name=model_name, version=version, alias=alias)
    send_slack_alert(f"â†©ï¸ ìˆ˜ë™ ë¡¤ë°± ì™„ë£Œ: {model_name} @{alias} â†’ v{version}")

def dag_reload():
    alias = Variable.get("rollback_alias")
    resp = trigger_reload(alias)
    send_slack_alert(f"ðŸ” ìˆ˜ë™ ë¡¤ë°± ë°˜ì˜(/reload): @{alias} â†’ {resp}")

with DAG(
    dag_id="manual_rollback_model",
    default_args=default_args,
    schedule=None,
    catchup=False,
    tags=["mlops", "rollback"],
    description="MLflow ëª¨ë¸ ë¡¤ë°± DAG (í•«ìŠ¤ì™‘ í¬í•¨)",
    on_failure_callback=alert_slack,
) as dag:
    rollback = PythonOperator(task_id="rollback_model_alias", python_callable=dag_rollback)
    reload = PythonOperator(task_id="reload_fastapi_model", python_callable=dag_reload)
    rollback >> reload
```

### ìš´ì˜ ë³€ìˆ˜ ì˜ˆì‹œ(í˜„ìž¬ ê°’)

- **dev**: `rollback_model_name=best_model`, `rollback_version=2`, `rollback_alias=B`
- **prod**: `rollback_model_name=best_model`, `rollback_version=1`, `rollback_alias=B`

> Airflow Variable ê°’ì€ ìš´ì˜ ìƒí™©ì— ë§žì¶° UIì—ì„œ ìˆ˜ì‹œë¡œ ë³€ê²½í•´ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
> 

---

## 6ï¸âƒ£ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ]  ë“±ë¡ **ì§ì „** `before_version` í™•ë³´ (XCom ì—†ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì¦‰ì‹œ ë³€ìˆ˜í™” ê¶Œìž¥ - ê°€ìž¥ ìµœê·¼ê°’ ë¹„êµ)
- [ ]  `rollback_model(model, version, alias)` í˜¸ì¶œ ì‹œ **ëŒ€ìƒ ë²„ì „ ëª…ì‹œ**
- [ ]  ë¡¤ë°± ëŒ€ìƒ **READY** í™•ì¸ (ë¹„READY ì°¨ë‹¨)
- [ ]  ì‹¤íŒ¨ ë¸Œëžœì¹˜ì—ì„œ **`trigger_reload()`** ì¦‰ì‹œ í˜¸ì¶œ (ì‹¤ì„œë¹„ìŠ¤ ë°˜ì˜ ë³´ìž¥)
- [ ]  Slack ë©”ì‹œì§€ì— **model / alias / version / run_id (ê°€ëŠ¥ ì‹œ)** í¬í•¨

---

## ðŸ§© íŒ

- **ì‹¤íŒ¨ëŠ” ìž¬ì „íŒŒ**í•˜ë˜, **ì„œë¹„ìŠ¤ëŠ” ë¨¼ì € ë³µêµ¬**: â€œê°€ìš©ì„± ìš°ì„ , ì›ì¸ ì¶”ì ì€ ë¡œê·¸/ìŠ¬ëž™/ì‹¤íŒ¨í‘œì‹â€
- **ë™ì¼ ë²„ì „ ìž¬ì§€ì • ì†ŒìŒ ì–µì œ**: í˜„ìž¬ alias ë²„ì „ê³¼ ë™ì¼í•œì§€ ë¨¼ì € ë¹„êµ
- **ìˆ˜ë™ ë¡¤ë°± DAG**ëŠ” ìš´ì˜ìž â€œì¦‰ì‹œë³µì› ìŠ¤ìœ„ì¹˜â€ë¡œ ìƒê°í•˜ê³ , Variablesë¥¼ PR í…œí”Œë¦¿/ëŸ°ë¶ì— ê¸°ë¡

---

## ðŸ ì •ë¦¬

> â€œë°°í¬ì˜ í’ˆì§ˆì€ ë³µêµ¬ ì‹œê°„ìœ¼ë¡œ ì¦ëª…ëœë‹¤.â€
> 
> 
> ìžë™ ë¡¤ë°±(ì‹¤íŒ¨ ë¸Œëžœì¹˜ ë‚´ `/reload` í¬í•¨)ê³¼ ìˆ˜ë™ ë¡¤ë°± DAGë¥¼ í•¨ê»˜ ê°–ì¶”ë©´,
> 
> ìž¥ì•  ìƒí™©ì—ì„œë„ **ëª…í™•í•œ ëŒ€ìƒ ë²„ì „**ìœ¼ë¡œ **ì¦‰ì‹œ ë³µêµ¬**í•˜ê³ ,
> 
> ê³„ì•½ëœ ì‘ë‹µ(`status="success"`)ìœ¼ë¡œ **ì„œë¹„ìŠ¤ ë°˜ì˜**ê¹Œì§€ í™•ì‹¤ížˆ ë³´ìž¥í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
>
