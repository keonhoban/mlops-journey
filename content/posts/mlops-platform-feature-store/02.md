+++
date = '2026-01-15T17:15:38+12:03'
draft = false
title = '[Feature Store & Feast - Feast]'
categories = ['MLOps Pipeline', 'GitOps(ArgoCD)', 'Airflow', 'Kubernetes', 'AWS S3', 'Feast'] 
+++

### GitOpsë¡œ Feast ê³„ì•½ ë°°í¬ + Airflowë¡œ ë²„ì „í™”/Latest ê°±ì‹  + Feast(Registry/S3 Offline/Redis Online)ë¡œ ì˜¨ë¼ì¸ ì¡°íšŒê¹Œì§€

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤

ì´ì „ ê¸€(Feature Store-lite)ì—ì„œ ì €ëŠ” **ê³„ì•½(ìŠ¤í‚¤ë§ˆ/ë©”íƒ€) + ë²„ì „í™” ì €ì¥ + ì¬í˜„ì„±**ê¹Œì§€ ê³ ì •í–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì‹¤ë¬´ì—ì„œëŠ” â€œì €ì¥â€ì—ì„œ ëë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²°êµ­ ì¤‘ìš”í•œ ê±´ **ì¡°íšŒ ê°€ëŠ¥(Serving-ready)** ìƒíƒœì…ë‹ˆë‹¤.

ì´ë²ˆ ê¸€ì€ Feature Store-lite ìœ„ì— Feastë¥¼ ì–¹ì–´ ì•„ë˜ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.

- **Offline Source**: S3ì˜ `latest/features.parquet` (Feastê°€ ì½ëŠ” ê³ ì • í¬ì¸í„°)
- **Registry**: S3ì— `registry.pb` ì €ì¥(í™˜ê²½ë³„ ë¶„ë¦¬)
- **Online Store**: Redis ì ì¬(materialize)ë¡œ ì˜¨ë¼ì¸ ì¡°íšŒ ê°€ëŠ¥
- **Feature Server**: ìƒì‹œ ì„œë¹„ìŠ¤ + startup ì‹œ `feast apply`

ì¦‰, â€œì €ì¥í•˜ëŠ” íŒŒì´í”„ë¼ì¸â€ â†’ â€œì¡°íšŒ ê°€ëŠ¥í•œ í”¼ì²˜ í”Œë«í¼â€ìœ¼ë¡œ í™•ì¥í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.

---

## ğŸ¯ ì™„ë£Œ ê¸°ì¤€

- GitOpsë¡œ Feast ê³„ì•½(repo.py/feature_store.yaml) ë°°í¬
- Airflowë¡œ S3ì— **version ìœ ì§€ + latest overwrite** ì €ì¥
- Feast materialize ì‹¤í–‰ â†’ Redis online ì ì¬
- Feast SDKë¡œ online ì¡°íšŒ ê²°ê³¼ê°€ **Noneì´ ì•„ë‹Œ ì‹¤ì œ ê°’**ìœ¼ë¡œ í™•ì¸

---

## âœ… í•µì‹¬ ìš”ì•½

- **dev/prod í™˜ê²½ ë¶„ë¦¬**
    - `feature-store-dev`, `feature-store-prod` (Feast + Redis)
    - `airflow-dev`, `airflow-prod` (KubernetesExecutor)
- **Feast ë¦¬ì†ŒìŠ¤ GitOps ë°°í¬**
    - `feature_store.yaml` + `repo.py`ë¥¼ ConfigMapìœ¼ë¡œ ë°°í¬
    - ArgoCD Applicationìœ¼ë¡œ ê´€ë¦¬ (`apps/feast-*.yaml`)
- **S3 ì €ì¥ ì •ì±…(ìš´ì˜ í‘œì¤€)**
    - `v_YYYYMMDDTHHMMSS/` : ì¬í˜„ì„±(ë²„ì „) ìœ ì§€
    - `latest/` : ìš´ì˜ í¸ì˜(ê³ ì • í¬ì¸í„°) overwrite
    - **4íŒŒì¼ ì„¸íŠ¸ ê³ ì •**
        - `features.parquet`, `features.csv`, `schema.json`, `metadata.json`
- **Feast êµ¬ì„±**
    - Registry: S3 (`s3://<bucket>/feast/<env>/registry.pb`)
    - Offline Source: S3 `.../latest/features.parquet` (í•„ìˆ˜: `event_timestamp`)
    - Online Store: Redis
    - Feature Server: startup ì‹œ `feast apply` í›„ `feast serve`
- **ì‹¤ì œ ìš´ì˜ ì´ìŠˆ í•´ê²° í¬í•¨**
    - ConfigMap ì „ì²´ mountë¡œ ì¸í•œ ë””ë ‰í† ë¦¬(`..`) ì´ìŠˆ â†’ **subPathë¡œ íŒŒì¼ë§Œ mount**
    - `/bin/sh`ì—ì„œ `pipefail` ê¹¨ì§ â†’ **sh í˜¸í™˜(set -eux)**
    - materialize ì‹œ S3 parquet ì½ê¸° ì‹¤íŒ¨ â†’ **s3fs í¬í•¨ ì´ë¯¸ì§€ë¡œ í•´ê²°**

---

## 1ï¸âƒ£ ì „ì²´ êµ¬ì¡°

![mermaid-feast-01.png](/mlops-journey/images/mermaid-feast-01.png)

---

## 2ï¸âƒ£ ì½”ë“œ/ë¦¬ì†ŒìŠ¤ íŠ¸ë¦¬

### (A) GitOps (mlops-infra-gitops)

```
charts/
  feast/
    templates/
      feast-repo-configmap.yaml
      feast-server-deployment.yaml
      feast-server-service.yaml
      redis-deployment.yaml
      redis-service.yaml
    values/
base.yaml
      dev.yaml
      prod.yaml

apps/
  feast-dev.yaml
  feast-prod.yaml

envs/
  dev/sealed-secrets/feature-store/sealed-aws-credentials-secret.yaml
  prod/sealed-secrets/feature-store/sealed-aws-credentials-secret.yaml

```

### (B) Airflow (airflow-dags-dev)

```
dags/
  dag_data_pipeline_daily_dev_v5.py
  mlops_lib/
    dp/
      build.py
      store.py
  .airflowignore

```

---

## 3ï¸âƒ£ ì„¤ê³„ í¬ì¸íŠ¸ (ìš´ì˜ ê´€ì )

### (1) Feast repo ìì²´ë¥¼ â€œê³„ì•½(Contract)â€ìœ¼ë¡œ ì·¨ê¸‰

Feastì—ì„œ ì‹¤ì§ˆì ì¸ ê³„ì•½ì€ `repo.py + feature_store.yaml`ì…ë‹ˆë‹¤.

ì´ê±¸ ConfigMapìœ¼ë¡œ GitOps ë°°í¬í•˜ë©´:

- dev/prodì—ì„œ **ë™ì¼ ê³„ì•½ ìœ ì§€**
- ì½”ë“œ ìˆ˜ì • ì—†ì´ ë°°í¬/ë¡¤ë°± ê°€ëŠ¥
- â€œìš´ì˜ ë¦¬ì†ŒìŠ¤â€ë¡œ ì¶”ì  ê°€ëŠ¥

### (2) S3 ì €ì¥ ì •ì±…ì€ â€œë²„ì „ + latest í¬ì¸í„°â€ë¡œ ëë‚¸ë‹¤

- `.../<feature_set>/<version>/` : ì¬í˜„ì„±
- `.../<feature_set>/latest/` : ìš´ì˜ í¸ì˜

Feast Offlineì€ **latestë§Œ ì½ìœ¼ë©´ ë˜ê¸° ë•Œë¬¸ì—**, ì‚¬ìš©ìëŠ” ë²„ì „ì„ ëª°ë¼ë„ ë©ë‹ˆë‹¤.

ë²„ì „ì€ â€œì¬í˜„â€ì´ í•„ìš”í•  ë•Œë§Œ êº¼ë‚´ ì“°ëŠ” êµ¬ì¡°ê°€ ê°€ì¥ ë‹¨ë‹¨í•©ë‹ˆë‹¤.

### (3) AirflowëŠ” ìƒì„±/ì €ì¥ê¹Œì§€ë§Œ, Online ì ì¬ëŠ” Feastê°€ ë‹´ë‹¹

Airflow ì´ë¯¸ì§€ì— feast/pyarrow/s3fsê¹Œì§€ ì–¹ê¸° ì‹œì‘í•˜ë©´ ìš´ì˜ ë‚œì´ë„ê°€ ê¸‰ìƒìŠ¹í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ ì—­í• ì„ ë‚˜ëˆ´ìŠµë‹ˆë‹¤.

- Airflow: **feature ìƒì„± + S3 ì €ì¥(ë²„ì „/latest)**
- Feast: **materialize + online(redis) ì ì¬ + ì¡°íšŒ**

(ìë™í™”ëŠ” ì¶”í›„ Job/CronJobë¡œ í™•ì¥)

---

## 4ï¸âƒ£ GitOps: Feast ë°°í¬ (Redis + Feature Server + Repo ConfigMap)

### 4-1) values (base/dev/prod)

```yaml
# charts/feast/values/base.yaml
aws:
  region: ap-northeast-2
  credentialsSecretName: aws-credentials

s3:
  bucket: datapipeline-raw-data-keonho
  featurePrefix: feature-store/user_features
  registryPrefix: feast

feastServer:
  image: hoizz/feast-server:0.40.1-s3fs
  port: 6566

redis:
  image: redis:7.2-alpine
  persistence: true

```

```yaml
# charts/feast/values/dev.yaml
env: dev

```

```yaml
# charts/feast/values/prod.yaml
env: prod

```

### 4-2) Feast repo ConfigMap (parquet + event_timestamp + serialization v2)

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: feast-repo
  namespace: {{ .Release.Namespace }}
data:
  feature_store.yaml: |
    project: feature_store_{{ .Values.env }}

    registry:
      path: s3://{{ .Values.s3.bucket }}/{{ .Values.s3.registryPrefix }}/{{ .Values.env }}/registry.pb

    provider: local

    offline_store:
      type: file

    online_store:
      type: redis
      connection_string: redis.{{ .Release.Namespace }}.svc.cluster.local:6379

    entity_key_serialization_version: 2

  repo.py: |
    from datetime import timedelta
    from feast import Entity, FeatureView, Field
    from feast.infra.offline_stores.file_source import FileSource
    from feast.types import Int64, Float64

    user_features_source = FileSource(
        path="s3://{{ .Values.s3.bucket }}/{{ .Values.s3.featurePrefix }}/latest/features.parquet",
        timestamp_field="event_timestamp",
        created_timestamp_column=None,
    )

    user = Entity(
        name="user",
        join_keys=["user_id"],
    )

    user_features = FeatureView(
        name="user_features",
        entities=[user],
        ttl=timedelta(days=7),
        schema=[
            Field(name="f_total_events_7d", dtype=Int64),
            Field(name="f_avg_session_sec_7d", dtype=Float64),
            Field(name="f_last_event_age_sec", dtype=Int64),
        ],
        source=user_features_source,
        online=True,
    )

```

### 4-3) Feast ì„œë²„ Deployment (subPath + sh í˜¸í™˜ + startup apply)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: feast-server
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: feast-server
  template:
    metadata:
      labels:
        app: feast-server
    spec:
      containers:
        - name: feast-server
          image: {{ .Values.feastServer.image }}
          ports:
            - containerPort: {{ .Values.feastServer.port }}
          env:
            - name: AWS_SHARED_CREDENTIALS_FILE
              value: /root/.aws/credentials
            - name: AWS_REGION
              value: {{ .Values.aws.region }}
            - name: AWS_DEFAULT_REGION
              value: {{ .Values.aws.region }}
          volumeMounts:
            - name: feast-repo
              mountPath: /feast-repo/feature_store.yaml
              subPath: feature_store.yaml
              readOnly: true
            - name: feast-repo
              mountPath: /feast-repo/repo.py
              subPath: repo.py
              readOnly: true
            - name: aws-credentials
              mountPath: /root/.aws
              readOnly: true
          command: ["/bin/sh","-c"]
          args:
            - |
              set -eux
              cd /feast-repo
              feast apply
              feast serve --host 0.0.0.0 --port 6566
      volumes:
        - name: feast-repo
          configMap:
            name: feast-repo
        - name: aws-credentials
          secret:
            secretName: {{ .Values.aws.credentialsSecretName }}

```

---

## 5ï¸âƒ£ (í•„ìˆ˜) s3fs í¬í•¨ Feast ì´ë¯¸ì§€ ì¤€ë¹„

Feast materializeê°€ S3 parquetë¥¼ ì½ìœ¼ë ¤ë©´ `s3fs`ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```docker
FROM feastdev/feature-server:0.40.1
RUN pip install --no-cache-dir s3fs fsspec

```

```bash
docker build -t hoizz/feast-server:0.40.1-s3fs .
docker push hoizz/feast-server:0.40.1-s3fs

```

---

## 6ï¸âƒ£ Airflow: â€œë²„ì „í™” ì €ì¥ + latest overwriteâ€ (parquet ê¸°ì¤€)

ì—¬ê¸°ì„œë¶€í„°ê°€ Feast ê¸€ì˜ í•µì‹¬ì…ë‹ˆë‹¤.

FeastëŠ” Offlineì„ `latest/features.parquet`ë¡œ ê³ ì •í•´ ì½ê¸° ë•Œë¬¸ì—, Airflowê°€ **latestë¥¼ ë§¤ë²ˆ ê°±ì‹ **í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

### (1) DAG: íë¦„ë§Œ ë‹´ë‹¹

```python
# dags/dag_data_pipeline_daily_dev_v5.py (ìš”ì•½)
from datetime import datetime, timedelta
from airflow import DAG
from airflow.operators.python import PythonOperator

from mlops_lib.dp.build import build_features
from mlops_lib.dp.store import store_features

DEFAULT_ARGS = {
    "owner": "airflow",
    "retries": 1,
    "retry_delay": timedelta(minutes=3),
}

with DAG(
    dag_id="data_pipeline_daily_dev_v5",
    default_args=DEFAULT_ARGS,
    start_date=datetime(2026, 1, 1),
    schedule="0 0 * * *",
    catchup=False,
    tags=["dp", "feature-store"],
) as dag:
    t_build = PythonOperator(task_id="build_features", python_callable=build_features)
    t_store = PythonOperator(
        task_id="store_features",
        python_callable=store_features,
        op_kwargs={
            "feature_base": "s3://datapipeline-raw-data-keonho/feature-store",
            "pipeline_name": "data_pipeline_daily_dev_v5",
            "feature_set": "user_features",
            "metadata_tpl_path": "/opt/airflow/dags/mlops_lib/dp/templates/metadata.json.j2",
        },
    )

    t_build >> t_store

```

> í¬ì¸íŠ¸: DAGì—ëŠ” â€œì €ì¥ ì •ì±…(ë²„ì „ + latest)â€ì´ ë“œëŸ¬ë‚˜ì•¼ í•©ë‹ˆë‹¤.
> 
> 
> ì´ê²Œ ê³§ ìš´ì˜ ë¬¸ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤.
> 

### (2) build: parquet/csv + event_timestamp ë³´ì¥

- Feast ê¸°ì¤€: **event_timestamp í•„ìˆ˜**
- build ë‹¨ê³„ì—ì„œ Feast ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±ì‹œí‚¤ë©´ íŒŒì´í”„ë¼ì¸ì´ ì•ˆì •í•´ì§‘ë‹ˆë‹¤.

### (3) store: version + latest ë™ì‹œ ì €ì¥(4íŒŒì¼ ì„¸íŠ¸)

- `.../<feature_set>/<version>/` ì €ì¥ (ì¬í˜„ì„±)
- `.../<feature_set>/latest/` overwrite (ìš´ì˜ í¸ì˜)
- ë™ì¼ prefixì— **parquet/csv/schema/metadata**ë¥¼ ë¬¶ì–´ì„œ ì €ì¥

---

## 7ï¸âƒ£ Feast ìš´ì˜/ê²€ì¦ ë£¨í‹´ (ì„±ê³µ ì²´í¬)

### 7-1) s3fs í¬í•¨ ì—¬ë¶€ í™•ì¸

```bash
POD=$(kubectl -n feature-store-dev get pod -l app=feast-server -o jsonpath='{.items[0].metadata.name}')
kubectl -n feature-store-dev exec -it "$POD" -- sh -lc '
python - << "PY"
import s3fs, fsspec
print("s3fs OK:", s3fs.__version__)
print("fsspec:", fsspec.__version__)
PY
'

```

### 7-2) materialize ì‹¤í–‰ (ì˜ˆ: ìµœê·¼ 2ì¼)

```bash
kubectl -n feature-store-dev exec -it "$POD" -- sh -lc '
cd /feast-repo
feast materialize "$(date -u -d "2 days ago" +%Y-%m-%dT%H:%M:%S)" "$(date -u +%Y-%m-%dT%H:%M:%S)"
'

```

### 7-3) online ì¡°íšŒ í™•ì¸

```bash
kubectl -n feature-store-dev exec -it "$POD" -- sh -lc '
python - << "PY"
from feast import FeatureStore
store = FeatureStore("/feast-repo")

resp = store.get_online_features(
  features=[
    "user_features:f_total_events_7d",
    "user_features:f_avg_session_sec_7d",
    "user_features:f_last_event_age_sec",
  ],
  entity_rows=[{"user_id": 1001}],
)
print(resp.to_df())
PY
'

```

---

## 8ï¸âƒ£ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

- **ConfigMap ì „ì²´ mountë¡œ repoê°€ ê¼¬ì„**
    
    â†’ `subPath`ë¡œ íŒŒì¼ë§Œ ë§ˆìš´íŠ¸
    
- **/bin/shì—ì„œ pipefail ê¹¨ì§**
    
    â†’ `set -eux`ë¡œ ê³ ì •
    
- **materialize ì‹œ â€œInstall s3fsâ€ ì˜¤ë¥˜**
    
    â†’ s3fs í¬í•¨ ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ë¡œ êµì²´
    
- **image repo ì´ë¦„ ì˜¤íƒ€ë¡œ ErrImagePull**
    
    â†’ values/base.yamlì˜ image repo ì •í™•íˆ êµì •
    

---

## ğŸ§© ì‹¤ë¬´ íŒ

- *4íŒŒì¼ ì„¸íŠ¸(parquet/csv/schema/metadata)**ë¥¼ ê°™ì´ ë‚¨ê²¨ì•¼ ìš´ì˜ì—ì„œ í”ë“¤ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
- **latest overwriteëŠ” ìš´ì˜ í¸ì˜ì˜ í•µì‹¬**ì…ë‹ˆë‹¤.
    
    Feast Offlineì€ latestë§Œ ë³´ê²Œ ë§Œë“¤ë©´ ì‚¬ìš©ìëŠ” ë²„ì „ì„ ëª°ë¼ë„ ë©ë‹ˆë‹¤.
    
- materialize ìë™í™”ëŠ” ë‚˜ì¤‘ì— í•´ë„ ë©ë‹ˆë‹¤.
    
    ìš°ì„ ì€ **Feast ì„œë²„ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” êµ¬ì¡°**ê°€ ë” ë‹¨ë‹¨í•©ë‹ˆë‹¤.
    

---

## ğŸ”§ MLOps ì‹¤ì „ ì—°ê²°

- Trainingì´ `v_YYYY...`ë¥¼ ë°›ì•„ í•™ìŠµí•˜ë©´
    
    â€œì´ ëª¨ë¸ì€ ì–´ë–¤ feature versionìœ¼ë¡œ í•™ìŠµí–ˆëŠ”ê°€â€ê°€ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
    
- Online storeê°€ ìƒê¸°ë©´
    
    Serving(FastAPI ë“±)ì´ Redisì—ì„œ ì¦‰ì‹œ ì¡°íšŒí•˜ë©° Offline/Online ê³„ì•½ì´ ì¼ì¹˜í•©ë‹ˆë‹¤.
    
- validate ë‹¨ê³„ í™•ì¥ìœ¼ë¡œ drift/í’ˆì§ˆ ê²€ì¦(Null-rate, schema drift ë“±)ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë¶™ìŠµë‹ˆë‹¤.

---

## ğŸ ì •ë¦¬

FeastëŠ” Feature Store-liteì˜ â€œì¬í˜„ì„± ë¼ˆëŒ€â€ ìœ„ì—,

- `latest/features.parquet` ê³ ì • í¬ì¸í„°
- registry(S3) + online(redis) + feature server
- materialize + online ì¡°íšŒ

ê¹Œì§€ ë¶™ì—¬ì„œ, **â€œì €ì¥í•˜ëŠ” íŒŒì´í”„ë¼ì¸â€ì„ â€œì¡°íšŒ ê°€ëŠ¥í•œ í”¼ì²˜ í”Œë«í¼â€ìœ¼ë¡œ í™•ì¥**í•œ ë‹¨ê³„ì…ë‹ˆë‹¤.
