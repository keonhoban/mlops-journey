+++
date = '2025-11-02T17:10:21+09:00'
draft = false
title = '[MLOps í”Œë«í¼ Observability & Data Pipeline - 5ë‹¨ê³„ : ìš´ì˜ ì¤‘ ë°œìƒí•œ ì‹¤ì œ ì´ìŠˆ & í•´ê²° ê³¼ì •]'
categories = ['Observability', 'GitOps(ArgoCD)', 'Kubernetes', 'Monitoring Stack', 'Trouble Shoot', 'NFS', 'Loki']
+++

## ìš´ì˜ ì¤‘ ë°œìƒí•œ ì‹¤ì œ ì´ìŠˆ & í•´ê²° ê³¼ì •

---

# ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œê´€ì¸¡Â·ì•Œë¦¼Â·ë¡œê·¸ ì‹œìŠ¤í…œì€ ì„¸íŒ…ë³´ë‹¤ ìš´ì˜ ì´í›„ê°€ ì§„ì§œ ì‹œì‘ì…ë‹ˆë‹¤.â€
> 
> 
> â€œì‹¤ìš´ì˜ í™˜ê²½ì—ì„œ ë°˜ë“œì‹œ ë§ˆì£¼ì¹˜ëŠ” ë¬¸ì œë“¤(div/prod í¬ë¡œìŠ¤ ìŠ¤í¬ë©, Alertmanager ì¶©ëŒ, NFS ê¶Œí•œ, TSDB ë³‘ëª© ë“±)ì„ ì •ë¦¬í•˜ê³ 
> 
> **ì™œ ë¬¸ì œê°€ ìƒê²¼ëŠ”ì§€ â†’ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ â†’ ë‹¤ì‹œëŠ” ë°˜ë³µë˜ì§€ ì•Šë„ë¡** êµ¬ì¡° ìì²´ë¥¼ ì¡ì•„ì£¼ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.â€
> 

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

- dev/prod **í¬ë¡œìŠ¤ ìŠ¤í¬ë© ë¬¸ì œ** ì •ë¦¬
- Alertmanager configSecret / generated-secret ì¶©ëŒ
- Instant Query ì˜¤ë¥˜(`log queries are not supported`) ì›ë¦¬
- worker2 ì¢…ë£Œ ì§€ì—°(30~40ì´ˆ)
- tmp-curl CrashLoopBackOff
- NFS Flush / Permission / fsGroup ë¬¸ì œ
- SealedSecret namespace mismatch
- Prometheus TSDB â†’ local-path ì „í™˜ ì‹œ ë°œìƒ ê°€ëŠ¥í•œ ì´ìŠˆ
- **â€œë¬¸ì œ â†’ ì›ì¸ â†’ í•´ê²° â†’ ì¬ë°œ ë°©ì§€â€ êµ¬ì¡°ë¡œ ì •ë¦¬**

---

## 1ï¸âƒ£ dev/prod Cross-Scrape ë¬¸ì œ

### ğŸ§© ì¦ìƒ

`monitoring-dev` Prometheusì—ì„œ `monitoring-prod` ë©”íŠ¸ë¦­ê¹Œì§€ ë³´ì—¬ì„œ

ê·¸ë˜í”„ê°€ dev/prodê°€ ì„ì—¬ë²„ë¦¬ëŠ” í˜„ìƒì´ ë°œìƒ.

### ğŸ§© ê·¼ë³¸ ì›ì¸

### â‘  kube-state-metrics ë¼ë²¨ ê³µìš© ì‚¬ìš©

```yaml
kube-state-metrics.prometheus.monitor.additionalLabels.release

```

â†’ dev/prod ëª¨ë‘ ê°™ì€ `release` ê°’ì„ ì‚¬ìš©

### â‘¡ Prometheus serviceMonitorSelector ê°€ ê³µí†µ ë¼ë²¨ í•„í„°ë§

dev/prodë¥¼ êµ¬ë¶„í•  ê¸°ì¤€ ìì²´ê°€ ì‚¬ë¼ì§.

### ğŸ§© í•´ê²°

í™˜ê²½ë³„ ë¼ë²¨ ë¶„ë¦¬:

```yaml
kube-state-metrics:
  prometheus:
    monitor:
      additionalLabels:
        release: "monitoring-dev"

```

Prometheusì—ë„ ë™ì¼í•œ ê¸°ì¤€:

```yaml
serviceMonitorSelector:
  matchLabels:
    release: "monitoring-dev"

```

### ğŸ§© ì¬ë°œ ë°©ì§€

- â€œdev/prod ë¼ë²¨ì´ í™˜ê²½ëª…ì„ í¬í•¨í•˜ëŠ”ê°€?â€
- â€œselector.matchLabels ê°€ í™˜ê²½ë³„ë¡œ ë‚˜ë‰˜ì–´ ìˆëŠ”ê°€?â€

GitOps ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸ì— ë°˜ë“œì‹œ í¬í•¨.

---

## 2ï¸âƒ£ Alertmanager Secret ë¯¸ì ìš© & `missing name in receiver`

### ğŸ§© ì¦ìƒ

- Ingress ì ‘ê·¼ì€ ì •ìƒ
- Slack ë©”ì‹œì§€ê°€ ì „í˜€ ì˜¤ì§€ ì•ŠìŒ
- `/#/status` í™•ì¸ ì‹œ configê°€ ê¸°ë³¸ í…œí”Œë¦¿

### ğŸ§© ì›ì¸

### â‘  ì˜ëª»ëœ í‚¤ ì‚¬ìš©

âŒ ì˜¤íƒ€:

```
alertmanager.configFromSecret

```

â­• ì •ë‹µ:

```
alertmanager.alertmanagerSpec.configSecret

```

### â‘¡ Operatorê°€ ìë™ ìƒì„±í•˜ëŠ” generated-secret ìš°ì„  ì ìš©

`alertmanager-<name>-generated` ê°€ configSecretë³´ë‹¤ ë¨¼ì € ì ìš©ë¨.

### â‘¢ receivers ë¸”ë¡ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì˜¤ë¥˜

```
missing name in receiver

```

### ğŸ§© í•´ê²°

- `spec.alertmanagerSpec.configSecret` ì‚¬ìš©
- receivers ì´ë¦„ì„ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê°’ìœ¼ë¡œ ì •ë¦¬
- generated-secretì´ ìˆëŠ”ì§€, ë‚´ìš©ì´ ë®ì–´ì“°ì§€ ì•ŠëŠ”ì§€ í™•ì¸

### ğŸ§© ì¬ë°œ ë°©ì§€

- AlertmanagerëŠ” Operatorê°€ ì§€ì†ì ìœ¼ë¡œ Secretì„ ì¬ìƒì„±í•œë‹¤ëŠ” ì‚¬ì‹¤ ê¸°ì–µ
- receivers ì´ë¦„ì´ í…œí”Œë¦¿ ë‚´ë¶€ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í•­ìƒ ì²´í¬

---

## 3ï¸âƒ£ Instant Query ì—ëŸ¬

### `log queries are not supported as an instant query type`

### ğŸ§© ì¦ìƒ

Grafana / Lokiì—ì„œ ë‹¤ìŒ ì˜¤ë¥˜ ë°œìƒ:

```
log queries are not supported as an instant query type

```

### ğŸ§© ì›ì¸

- Instant Query â†’ â€œë‹¨ì¼ ì‹œì  ë©”íŠ¸ë¦­ ì¡°íšŒâ€
- ë¡œê·¸ â†’ **ë°˜ë“œì‹œ ì‹œê°„ êµ¬ê°„**ì´ í•„ìš”í•¨
    
    â†’ Instant Query ê°œë… ìì²´ì™€ ì¶©ëŒ
    

### ğŸ§© í•´ê²°

Range Query ì‚¬ìš©:

```bash
curl -G http://loki-dev:3100/loki/api/v1/query_range \
  --data-urlencode 'query={namespace="fastapi-dev"}' \
  --data-urlencode start=1732440000000000000 \
  --data-urlencode end=1732440600000000000

```

### ğŸ§© ì¬ë°œ ë°©ì§€

- ë©”íŠ¸ë¦­ = ìˆœê°„ ë°ì´í„°
- ë¡œê·¸ = êµ¬ê°„ ë°ì´í„°
    
    ì´ ê°œë…ë§Œ ê¸°ì–µí•˜ë©´ ë.
    

---

## 4ï¸âƒ£ worker2 ì¢…ë£Œ ì§€ì—° (ì•½ 30â€“40ì´ˆ)

### ğŸ§© ì¦ìƒ

worker2ë§Œ ì¢…ë£Œê°€ 30~40ì´ˆ ì§€ì—°ë¨.

### ğŸ§© ì›ì¸

- Promtail DaemonSetì´ NFS ì–¸ë§ˆìš´íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ë©´ì„œ ì§€ì—°
- NFS Flush ì‹œê°„ì´ ê¸¸ë©´ graceful timeout ì¦ê°€

### ğŸ§© í•´ê²°

```yaml
terminationGracePeriodSeconds: 10

```

### ğŸ§© ì¬ë°œ ë°©ì§€

Promtailì´ NFS ê¸°ë°˜ positions.yaml ì„ ì“¸ ê²½ìš°

terminationGracePeriodSeconds ìµœì†Œí™” í•„ìˆ˜.

---

## 5ï¸âƒ£ tmp-curl CrashLoopBackOff

### ğŸ§© ì¦ìƒ

`tmp-curl-*` Podê°€ CrashLoopBackOff ë°˜ë³µ

### ğŸ§© ì›ì¸

- kube-prometheus-stackê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í…ŒìŠ¤íŠ¸ìš© curl Pod
- TLS/Ingress ì™„ì„± ì „ì—ëŠ” readiness ì‹¤íŒ¨ë¡œ crash

### ğŸ§© í•´ê²°

- Ingress/TLS êµ¬ì¶• ì¤‘ ì ì‹œ ë°œìƒí•˜ëŠ” ì •ìƒ í˜„ìƒ
- êµ¬ì¡°ê°€ ì™„ì„±ë˜ë©´ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§

### ğŸ§© ì¬ë°œ ë°©ì§€

- ì´ PodëŠ” ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¼ â€œìŠ¤íƒ ì¤€ë¹„ ì¤‘â€ì„ ì˜ë¯¸
- ë¬¸ì„œí™”ë§Œ í•´ë‘ë©´ ë¬¸ì œ ì—†ìŒ

---

## 6ï¸âƒ£ FastAPI / NFS ê¶Œí•œ ë¬¸ì œ (PermissionError)

### ğŸ§© ì¦ìƒ

FastAPI ë¡œê·¸:

```
PermissionError: [Errno 13] Permission denied: '/app/logs'

```

### ğŸ§© ì›ì¸

- NFSì—ì„œ root_squash ì ìš© â†’ runAsUser ë³€í™˜
- Podì˜ securityContextì™€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ Permission ì˜¤ë¥˜ ë°œìƒ

### ğŸ§© í•´ê²°

FastAPI Deployment:

```yaml
securityContext:
  fsGroup: 1000
  runAsUser: 1000

```

NFS ì„œë²„ ë””ë ‰í† ë¦¬:

```bash
chmod 0777 -R /mnt/nfs_share/mlops/fastapi

```

### ğŸ§© ì¬ë°œ ë°©ì§€

- NFS + ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ êµ¬ì¡° = **ë¬´ì¡°ê±´ fsGroup í•„ìš”**

---

## 7ï¸âƒ£ Prometheus TSDB â†’ local-path ì „í™˜

### ğŸ§© ì¦ìƒ

Prometheus TSDB ì“°ê¸° ì§€ì—° / scrape ì§€ì—° / CPU ë¶€í•˜ ì¦ê°€

â†’ NFS ê¸°ë°˜ TSDBì™€ ë³‘ëª©ì´ ë§ì§€ ì•ŠìŒ

### ğŸ§© ê·¼ë³¸ ì›ì¸

Prometheus TSDBëŠ” ê³  IOPS + ì €ì§€ì—° í•„ìˆ˜

â†’ NFSëŠ” êµ¬ì¡°ì ìœ¼ë¡œ ë¶€ì í•©

### ğŸ§© í•´ê²°

local-path StorageClass ì‚¬ìš©:

```yaml
storageClassName: local-path

```

í•„ìˆ˜ ì¡°ì¹˜:

```bash
kubectl scale sts prometheus --replicas=0
kubectl delete pvc <prometheus-pvc>
kubectl scale sts prometheus --replicas=1

```

### ğŸ§© ì¬ë°œ ë°©ì§€

- Prometheusë§Œ local-path
- Grafana / Loki / AlertmanagerëŠ” NFSë¡œ ìœ ì§€

---

## 8ï¸âƒ£ SealedSecret namespace mismatch

### ğŸ§© ì¦ìƒ

ArgoCDì—ì„œ SealedSecretì´ ì •ìƒ ì ìš©ëë‹¤ê³  ë‚˜ì˜¤ëŠ”ë°

Secret ìì²´ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ.

### ğŸ§© ì›ì¸

SealedSecret.metadata.namespace

â‰ 

Secret.metadata.namespace

â†’ namespace mismatchë¡œ ìƒì„±ë˜ì§€ ì•ŠìŒ.

### ğŸ§© í•´ê²°

êµ¬ì¡° í†µì¼:

```yaml
metadata:
  namespace: monitoring-dev

```

### ğŸ§© ì¬ë°œ ë°©ì§€

SealedSecretì€ ìµœì¢… Secretì´ ì¡´ì¬í•  namespaceì™€ ë°˜ë“œì‹œ ë™ì¼í•´ì•¼ í•¨.

---

## 9ï¸âƒ£ ìš´ì˜ ì¤‘ ìì£¼ í—·ê°ˆë¦° í¬ì¸íŠ¸ ì •ë¦¬

- NFS ìˆ˜ë°± ê°œ ë””ë ‰í„°ë¦¬ ìë™ ìƒì„± ë°©ì§€ â†’ `archiveOnDelete=true`
- Promtail positions.yaml ì˜¤ì—¼ ë°©ì§€ â†’ dev/prod PVC ë¶„ë¦¬
- Alertmanager generated-secret ì‚­ì œ ê¸ˆì§€ â†’ Operatorê°€ ì¬ìƒì„±
- Loki ì¿¼ë¦¬ ëŠë¦´ ë•Œ â†’ ì‹œê°„ ë²”ìœ„ / ë¼ë²¨ ì¡°í•©ì´ ê³¼ë„í•œ ê²½ìš°ê°€ ëŒ€ë¶€ë¶„

---

## ğŸ”§ MLOps ì‹¤ì „ ì—°ê²°

- ë¡œê·¸/ì•ŒëŒ ê¸°ë°˜ìœ¼ë¡œ **ë°°í¬ ì‹¤íŒ¨ â†’ ì¦‰ì‹œ Slack ì•Œë¦¼ â†’ ìë™ A/B ë¡¤ë°±** ì‹œë‚˜ë¦¬ì˜¤ê¹Œì§€ í™•ì¥ ê°€ëŠ¥
- FastAPI ì˜¤ë¥˜ ë¡œê·¸ ê¸°ë°˜ Canary ê²€ì¦ ë¡œì§ êµ¬í˜„ ê°€ëŠ¥
- Airflow â†’ MLflow â†’ FastAPI â†’ Loki â†’ Alertmanager â†’ Slack
    
    ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ìš´ì˜/ê´€ì¸¡ ì‹œê°ì—ì„œ ê¹Šì´ ì´í•´í•œ ë‹¨ê³„
    

---

## ğŸ ì •ë¦¬

| í•­ëª© | ìƒíƒœ |
| --- | --- |
| dev/prod í¬ë¡œìŠ¤ ìŠ¤í¬ë© | í•´ê²° |
| Alertmanager configSecret ë¬¸ì œ | í•´ê²° |
| Loki Instant Query ì˜¤ë¥˜ | ì›ë¦¬ê¹Œì§€ ì´í•´ |
| Worker ì¢…ë£Œ ì§€ì—° | í•´ê²° |
| tmp-curl CrashLoopBackOff | ì •ìƒ í˜„ìƒ |
| FastAPI NFS ê¶Œí•œ ë¬¸ì œ | í•´ê²° |
| Prometheus TSDB local-path ì „í™˜ | ì™„ë£Œ |
| SealedSecret namespace mismatch | í•´ê²° |
