+++
date = '2025-10-27T17:10:21+09:00'
draft = false
title = '[MLOps í”Œë«í¼ Observability & Data Pipeline - 4ë‹¨ê³„ : Loki/Promtail ë¡œê·¸ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•]'
categories = ['Observability', 'Loki', 'Kubernetes', 'Monitoring Stack', 'Logging', 'NFS', 'GitOps(ArgoCD)', 'MLOps Pipeline']
+++

## Loki/Promtail ë¡œê·¸ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> â€œìš´ì˜í˜• MLOpsì—ì„œ ê°€ì¥ ìœ„í—˜í•œ ì¥ì• ëŠ” ëª¨ë¸ì´ ì•„ë‹Œ ë¡œê·¸ê°€ ì•ˆ ë³´ì´ëŠ” ìˆœê°„ì…ë‹ˆë‹¤.â€
> 
> 
> â€œFastAPIÂ·MLflowÂ·Airflowê°€ ëª¨ë‘ ëŒì•„ê°€ë„, ë¡œê·¸ê°€ í•œ ë²ˆ ì„ì´ê±°ë‚˜ ëˆ„ë½ë˜ë©´
> 
> ì¥ì•  ì›ì¸ì„ ì°¾ì§€ ëª»í•´ ìš´ì˜ ìì²´ê°€ ë©ˆì¶°ë²„ë¦½ë‹ˆë‹¤.â€
> 
> â€œê·¸ë˜ì„œ ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” dev/prodë¥¼ ì™„ì „íˆ ë¶„ë¦¬í•œ
> 
> **Loki + Promtail ë¡œê·¸ íŒŒì´í”„ë¼ì¸**ì„ êµ¬ì¶•í•´,
> 
> ëª¨ë¸ í•«ìŠ¤ì™‘Â·ì—ëŸ¬ íŒ¨í„´Â·API ì´ìƒ ì§•í›„ê¹Œì§€ í•œëˆˆì— ë³´ì´ë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.â€
> 

---

### ğŸ¯ í•µì‹¬ ìš”ì•½

- **ë¡œê·¸ íŒŒì´í”„ë¼ì¸ ì „ì²´ êµ¬ì„±**
    - Promtail â†’ Loki â†’ Grafana(LogQL)
    - dev/prod ëª¨ë‘ ì™„ì „ ë¶„ë¦¬
- **Ingress + TLS + GitOps ìë™ ì ìš©**
- **fastapi-dev / fastapi-prod / airflow-dev / airflow-prod ë¡œê·¸**
    
    ì „ë¶€ ì •ìƒ ìˆ˜ì§‘ í™•ì¸
    
- **Query-Range ê¸°ë°˜ ë¡œê·¸ ì¡°íšŒ** (Instant Query ë¶ˆê°€ ì›ë¦¬ í¬í•¨)
- **LogQL í•µì‹¬ íŒ¨í„´ í¬í•¨**

---

## 1ï¸âƒ£ ì „ì²´ êµ¬ì¡° ê°œìš”

### ğŸ§© ì „ì²´ íŒŒì´í”„ë¼ì¸

```
[Pod Log] â†’ Promtail â†’ Loki Distributor â†’ Ingester â†’ TSDB â†’ Querier â†’ Grafana

```

### ğŸŒ± í™˜ê²½ë³„ ì™„ì „ ë¶„ë¦¬

- `loki-dev` / `loki-prod`
- `promtail-dev` / `promtail-prod`
- `grafana-dev.local` / `grafana-prod.local`

---

## 2ï¸âƒ£ Loki Helm êµ¬ì„± (single-binary + NFS PVC)

### 2-1. ì™œ single-binary?

í™˜ê²½ íŠ¹ì„±:

- dev/prod ê°ê° 1ê°œì˜ Loki ì¸ìŠ¤í„´ìŠ¤ â†’ **single-binary ëª¨ë“œê°€ ìµœì **
- í•„ìš” ì‹œ distributed ëª¨ë“œë¡œ í™•ì¥ ê°€ëŠ¥
    
    (`distributor`, `ingester`, `querier`, `compactor` ë¶„ë¦¬)
    

### 2-2. ë„ì…í•œ ì£¼ìš” ì˜µì…˜

```yaml
loki:
  commonConfig:
    replication_factor: 1

  storage:
    type: filesystem
    filesystem:
      chunks_directory: /var/loki/chunks
      rules_directory: /var/loki/rules

  persistence:
    enabled: true
    storageClassName: nfs-observability
    size: 20Gi

```

- TSDBëŠ” **ì“°ê¸° ë¹ˆë„ê°€ Prometheusë³´ë‹¤ ë‚®ì•„ NFSë¡œë„ ì¶©ë¶„**
- Prometheusì™€ëŠ” ë°˜ëŒ€ë¡œ, LokiëŠ” NFS ê¸°ë°˜ìœ¼ë¡œ ì˜¤ë˜ ë³´ê´€í•˜ëŠ” êµ¬ì¡°ê°€ ì•ˆì •ì 

---

## 3ï¸âƒ£ Promtail Helm êµ¬ì„± (ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ + ë¼ë²¨ ê¸°ë°˜)

### 3-1. í•µì‹¬: dev/prod ë¼ë²¨ êµ¬ë¶„

```yaml
config:
  clients:
    - url: http://loki-dev:3100/loki/api/v1/push

  snippets:
    pipelineStages:
      - docker: {}
      - labeldrop:
          - filename
      - match:
          selector: '{namespace="fastapi-dev"}'
          stages:
            - regex:
                expression: '.*'

```

- `clients.url` ë¡œ **í™˜ê²½ë³„ Loki ì—”ë“œí¬ì¸íŠ¸ ë¶„ë¦¬**
- `match.selector` ë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê¸°ì¤€ í•„í„°ë§

### 3-2. worker2 ì¢…ë£Œ ì§€ì—° ë¬¸ì œ í•´ê²°

- ì›ì¸: Promtail DaemonSet + NFS Unmount ì§€ì—°ìœ¼ë¡œ ì¢…ë£Œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
- í•´ê²°:

```yaml
terminationGracePeriodSeconds: 10

```

â†’ ì¢…ë£Œ ëŒ€ê¸° ì‹œê°„ì„ ì§§ê²Œ ì¡ì•„, ë…¸ë“œ ì¢…ë£Œ ì§€ì—°ì„ ì™„í™”.

---

## 4ï¸âƒ£ Grafana / Loki API ì¿¼ë¦¬ (LogQL + Instant Query ì´ìŠˆ)

### 4-1. Instant Query ì˜¤ë¥˜

**ì¦ìƒ**

```
log queries are not supported as an instant query type

```

**ì›ì¸**

- `/loki/api/v1/query` = â€œíŠ¹ì • ì‹œì ì˜ ë©”íŠ¸ë¦­â€ ì¡°íšŒìš© ì—”ë“œí¬ì¸íŠ¸
- ë¡œê·¸ëŠ” â€œì‹œê°„ ë²”ìœ„ë¥¼ ì§€ì •í•˜ëŠ” ìŠ¤íŠ¸ë¦¼ ë°ì´í„°â€ â†’ **Instant Query ê°œë…ê³¼ ë§ì§€ ì•ŠìŒ**

### 4-2. Query Range ì‚¬ìš©

```bash
curl -G http://loki-dev:3100/loki/api/v1/query_range \
  --data-urlencode 'query={namespace="fastapi-dev"}' \
  --data-urlencode 'start=1732440000000000000' \
  --data-urlencode 'end=1732440600000000000'

```

- `start`, `end` ëŠ” **ë‚˜ë…¸ì´ˆ ë‹¨ìœ„ Unix íƒ€ì„ìŠ¤íƒ¬í”„**
- ë²”ìœ„ë¥¼ ì§€ì •í•´ì•¼ë§Œ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ì´ ì˜¬ë°”ë¥´ê²Œ ì¡°íšŒë¨

---

## 5ï¸âƒ£ Grafana Log Dashboard êµ¬ì„±

### 5-1. FastAPI ì „ìš© ê´€ì¸¡íŒ

íŒ¨ë„ êµ¬ì„± ì˜ˆì‹œ:

- ìµœê·¼ 1ì‹œê°„ FastAPI ë¡œê·¸ ìŠ¤íŠ¸ë¦¼
- `level="ERROR"` í•„í„° íŒ¨ë„
- `/variant/{alias}` API ë¡œê·¸ ìƒíƒœ ëª¨ë‹ˆí„°ë§ íŒ¨ë„
- ëª¨ë¸ reload ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸ íŒ¨ë„
- Slack ì•Œë¦¼ì´ ìˆëŠ” ë¼ì¸ë§Œ í•„í„°ë§í•œ íŒ¨ë„

### 5-2. ëŒ€í‘œ LogQL ì˜ˆì‹œ

### â‘  fastapi-dev ì „ì²´ ë¡œê·¸

```
{namespace="fastapi-dev", container="fastapi"}

```

### â‘¡ ERRORë§Œ

```
{namespace="fastapi-dev"} |= "ERROR"

```

### â‘¢ ëª¨ë¸ Reload ì„±ê³µ/ì‹¤íŒ¨ í•„í„°

```
{namespace="fastapi-dev"} |= "Reload"

```

### â‘£ ì´ìƒ ìš”ì²­ íƒì§€ (5xx ì‘ë‹µ)

```
{namespace="fastapi-prod"} |= "predict" |~ "5\d{2}"

```

---

## 6ï¸âƒ£ GitOps ê¸°ë°˜ ì „ì²´ êµ¬ì¡°

### 6-1. ArgoCD Application (loki-dev ì˜ˆì‹œ)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-dev
spec:
  project: dev
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: loki
    targetRevision: 5.41.3
    helm:
      values: |
        loki:
          commonConfig:
            replication_factor: 1
        persistence:
          enabled: true
          storageClassName: nfs-observability
  destination:
    namespace: loki-dev
    server: https://kubernetes.default.svc

```

- prodëŠ” `project: prod`, `namespace: loki-prod`, `name: loki-prod` ë“±ìœ¼ë¡œ ë™ì¼ êµ¬ì¡°.

### 6-2. Promtail Application (values ì˜ˆì‹œ)

```yaml
promtail:
  config:
    clients:
      - url: http://loki-dev:3100/loki/api/v1/push
    positions:
      filename: /var/log/positions.yaml
  persistence:
    enabled: true
    storageClassName: nfs-observability

```

- dev/prod ê°ê° **ë³„ë„ namespace + ë³„ë„ PVC** ë¡œ êµ¬ì„±
- `positions.yaml` ì´ í™˜ê²½ ê°„ ì„ì´ì§€ ì•Šë„ë¡ ë¶„ë¦¬

---

## 7ï¸âƒ£ Ingress + TLS + ì¸ì¦

Grafana/Alertmanagerì™€ ë™ì¼í•œ íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

- `grafana-dev.local`
- `loki-dev.local` (ì˜µì…˜)

### 7-1. Loki Ingress ì„¤ì • ì˜ˆì‹œ

```yaml
ingress:
  enabled: true
  className: nginx
  hosts:
    - loki-dev.local
  tls:
    - secretName: loki-tls
      hosts:
        - loki-dev.local

```

- prod: `loki-prod.local`, `loki-prod-tls` ë“±ìœ¼ë¡œ ë¶„ë¦¬
- TLS Secretì€ SealedSecret ê¸°ë°˜ìœ¼ë¡œ Gitì— ì €ì¥ ê°€ëŠ¥

---

## 8ï¸âƒ£ ëŒ€í‘œ ê²€ì¦ ëª…ë ¹

### 8-1. fastapi-dev ë¡œê·¸ í™•ì¸ (Loki API)

```bash
curl -G http://loki-dev:3100/loki/api/v1/query_range \
  --data-urlencode 'query={namespace="fastapi-dev"}' \
  --data-urlencode 'limit=50'

```

### 8-2. Promtail â†’ Loki Path í™•ì¸

```bash
kubectl -n promtail-dev logs daemonset/promtail | grep "loki-dev"

```

- Loki ì—”ë“œí¬ì¸íŠ¸ë¡œ ì •ìƒ ì „ì†¡ ì¤‘ì¸ì§€ í™•ì¸

### 8-3. Loki ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ í™•ì¸

```bash
kubectl -n loki-dev exec -it deploy/loki-dev -- df -h | grep loki

```

- NFS(`nfs-observability`) ê¸°ë°˜ PVCê°€ ì œëŒ€ë¡œ ë§ˆìš´íŠ¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

---

## ğŸ§© íŒ

- ë¡œê·¸ í•„í„°ë§ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì¶•ì€ **namespace + container**
- FastAPI ë¡œê·¸ í¬ë§·ì´ ì¼ê´€ë˜ë©´, Promtailì—ì„œ **ì „ìš© íŒŒì„œ(ì˜ˆ: logfmt/json/datetime regex)** ë¥¼ ë¶™ì—¬ ë©”íŠ¸ë¦­/ë¼ë²¨ë¡œ ë½‘ì„ ìˆ˜ ìˆìŒ
- Promtail `positions.yaml` ì´ NFS ì „ì—­ì—ì„œ ê³µìœ ë˜ë©´ ì˜¤ì—¼ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ,
    
    **dev/prod ê°ê° PVCë¥¼ ë¶„ë¦¬**í•˜ëŠ” ê²ƒì´ ì•ˆì „
    
- LogQLì€ ì²˜ìŒë¶€í„° ë³µì¡í•œ ì§‘ê³„ë¥¼ ì“°ê¸°ë³´ë‹¤:
    - `|=` (substring)
    - `|~` (regex)
    - `!~` (negative regex)
        
        â†’ ì´ 3ê°œë§Œìœ¼ë¡œë„ ì‹¤ì œ ìš´ì˜ì—ì„œ 80~90%ëŠ” í•´ê²° ê°€ëŠ¥
        

---

## ğŸ”§ MLOps ì‹¤ì „ ì—°ê²°

- ëª¨ë¸ í•«ìŠ¤ì™‘, ë°°í¬ ì‹¤íŒ¨, ì˜ˆì¸¡ ì˜¤ë¥˜ ë“± **AI Platform ê¸°ë°˜ ë¡œê·¸ íë¦„**ì´
    
    Loki íŒŒì´í”„ë¼ì¸ì„ í†µí•´ **ì •ì‹ ê´€ì¸¡ ë¼ì¸**ì— í¸ì…
    
- dev/prod ê°ê°ì˜ FastAPI / MLflow / Airflow ë¡œê·¸ ì§‘ê³„ê°€ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´
    
    â€œdev ì‹¤í—˜ ë¡œê·¸ê°€ prod ëŒ€ì‹œë³´ë“œì— ì„ì´ëŠ” ì‚¬ê³ â€ë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ ì°¨ë‹¨
    
- ë¡œê·¸ ê¸°ë°˜ Alertmanager ì—°ë™ê¹Œì§€ í™•ì¥í•˜ë©´,
    - ì˜ˆì¸¡ ì˜¤ë¥˜ íŒ¨í„´ ê°ì§€
    - íŠ¹ì • endpoint ì—ëŸ¬ìœ¨ ê¸‰ì¦ ê°ì§€
    - A/B íŠ¸ë˜í”½ ë¶„ê¸° ìƒíƒœ ê²€ì¦
        
        ë“±ì„ í†µí•´ **â€œì˜ˆì¸¡ ì˜¤ë¥˜ ìë™ ê°ì§€ â†’ Slack ì•Œë¦¼ â†’ A/B ê°„ ì „í™˜/ë¡¤ë°±â€** ì‹œë‚˜ë¦¬ì˜¤ê¹Œì§€ í™•ì¥ ê°€ëŠ¥
        

---

## ğŸ ì •ë¦¬

| êµ¬ì„± | ìƒíƒœ |
| --- | --- |
| Loki single-binary dev/prod êµ¬ì¶• | âœ… ì™„ë£Œ |
| Promtail dev/prod ë¡œê·¸ ìˆ˜ì§‘ | âœ… ì •ìƒ ë™ì‘ |
| FastAPI/Airflow ë¡œê·¸ ìˆ˜ì§‘ | âœ… dev/prod ëª¨ë‘ ê²€ì¦ |
| LogQL ì¿¼ë¦¬ & Instant Query ì›ë¦¬ ì´í•´ | âœ… Query vs QueryRange êµ¬ë¶„ ì •ë¦¬ |
| GitOps(ArgoCD) ê¸°ë°˜ Loki/Promtail ê´€ë¦¬ | âœ… í™˜ê²½ë³„ Application êµ¬ì„± |
| TLS + Ingress ì ìš© | âœ… `loki-dev.local` / `loki-prod.local` ì ‘ê·¼ ê°€ëŠ¥ |
