+++
date = '2025-12-26T10:08:22+09:00'
draft = false
title = 'Triton êµ¬ì¶•'
categories = ['Triton', 'GitOps(ArgoCD)', 'Helm', 'Kubernetes', 'Grafana', 'ONNX', 'NFS']
+++

## Triton (CPU-only) GitOps í†µí•©: ONNX 1ê°œ ì„œë¹™ + Prometheus/Grafana ê´€ì¸¡

---

## ðŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> ì‹¤ë¬´ì—ì„œ ì„œë¹™ ê³„ì¸µì€ ê³§ë°”ë¡œ íŠ¸ëž˜í”½ê³¼ SLAë¥¼ ë§žëŠ” ìµœì „ì„ ìž…ë‹ˆë‹¤.
> 
> 
> ëª¨ë¸ì´ ì•„ë¬´ë¦¬ ì¢‹ì•„ë„, **ì„œë¹™ì´ ë¶ˆì•ˆì •í•˜ë©´** ìš´ì˜ì‹œ ë°”ë¡œ ë¬´ë„ˆì§‘ë‹ˆë‹¤.
> 
> ê·¸ëž˜ì„œ ì´ë²ˆì—ëŠ” Triton ì²« êµ¬ì¶•ìœ¼ë¡œ GPU/íŒŒì´í”„ë¼ì¸ ì—°ë™ì„ ì¼ë¶€ëŸ¬ ë¹¼ê³ ,
> 
> Triton ìžì²´ë¥¼ GitOpsë¡œ ì•ˆì •ì ìœ¼ë¡œ ë„ìš°ê³ , ëª¨ë¸ loadâ†’inferâ†’metrics ê´€ì¸¡ê¹Œì§€ â€˜ì„œë¹™ í”Œëž«í¼ ë¼ˆëŒ€ êµ¬ì¶•â€™ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.
> 

---

### ðŸŽ¯ í•µì‹¬ ìš”ì•½

- **dev/prod ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤ ë¶„ë¦¬**
    - `triton-dev`, `triton-prod`
- **Triton ëª¨ë¸ ì œì–´ ëª¨ë“œ**
    - `-model-control-mode=explicit`
    - í•„ìš” ì‹œì—ë§Œ load/unloadë¡œ ìš´ì˜ ì œì–´ ê°€ëŠ¥
- **Model Repository**
    - NFS(RWX) ê¸°ë°˜ PVCë¡œ `/models` ë§ˆìš´íŠ¸
- **ëª¨ë¸ ê²€ì¦**
    - ONNX 1ê°œ `simple_model`ë¡œ `load â†’ infer` ì„±ê³µ
- **ê´€ì¸¡**
    - Tritonì€ `/metrics`ë¥¼ **Prometheus í¬ë§·ìœ¼ë¡œ ìžì²´ ë…¸ì¶œ**
    - ServiceMonitorë¡œ dev/prod Prometheusì— ìžë™ ìŠ¤í¬ëž©
    - Grafanaì—ì„œ íŒ¨ë„ë¡œ ì¦ëª… ê°€ëŠ¥
- **GPU í™•ìž¥ í¬ì¸íŠ¸**
    - valuesì— `gpu.enabled` ë¶„ê¸° ì„¤ê³„ (í˜„ìž¬ false â†’ CPU ì‚¬ìš©)

> ì™„ë£Œ ê¸°ì¤€ì€ â€œTriton + GitOps + Observabilityâ€ êµ¬ì¶•ìž…ë‹ˆë‹¤.
> 

---

## 1ï¸âƒ£ ì „ì²´ êµ¬ì¡° ìš”ì•½

![mermaid-triton-00.png](/mlops-journey/images/mermaid-triton-00.png)

---

## 2ï¸âƒ£ ì½”ë“œ íŠ¸ë¦¬

```
charts/triton/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ serviceMonitor.yaml
â””â”€â”€ values/
    â”œâ”€â”€ base.yaml
    â”œâ”€â”€ dev.yaml
    â””â”€â”€ prod.yaml

```

---

## 3ï¸âƒ£ ì„¤ê³„ í¬ì¸íŠ¸

### (1) ì„œë¹™ ê³„ì¸µ ë¶„ë¦¬

- FastAPIëŠ” API Gateway/ë¹„ì¦ˆë‹ˆìŠ¤ ë¼ìš°íŒ… ê³„ì¸µ
- Tritonì€ **Inference ì „ìš© ì„œë¹™ ê³„ì¸µ**
- ìš´ì˜/ìŠ¤ì¼€ì¼ë§/ë¦¬ì†ŒìŠ¤ ì„±ê²©ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.

### (2) explicit ëª¨ë“œ ì„ íƒ

- ìžë™ ë¡œë”©ì´ ì•„ë‹ˆë¼ **í•„ìš”í•  ë•Œë§Œ ëª¨ë¸ load**
- ìš´ì˜ì—ì„œ â€œëª¨ë¸ ë°°í¬/êµì²´â€ëŠ” í•­ìƒ ìœ„í—˜ êµ¬ê°„ì´ë¼
    
    ì´ë²ˆ êµ¬ì¶•ì€ í†µì œ ê°€ëŠ¥í•œ ë°©ì‹(Explicit)ìœ¼ë¡œ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.
    

### (3) GitOpsì—ì„œ dev/prod ê´€ì¸¡ ë¼ë²¨ ì •í•©ì„±

- PrometheusëŠ” â€˜ì—°ê²°â€™ì´ ì•„ë‹ˆë¼ ë¼ë²¨ë¡œ â€˜ë°œê²¬â€™í•©ë‹ˆë‹¤. (= exporter ì—°ê²°ì´ ì•„ë‹Œ label íƒìƒ‰)
- dev PrometheusëŠ” `release=monitoring-dev` ë¼ë²¨ì˜ ServiceMonitorë§Œ ìŠ¤í¬ëž©
- prodëŠ” `release=monitoring-prod`ë§Œ ìŠ¤í¬ëž©
    
    â†’ ê·¸ëž˜ì„œ ì„œë¹„ìŠ¤/ì„œë¹„ìŠ¤ëª¨ë‹ˆí„°ì— release ë¼ë²¨ì´ í•µì‹¬ì´ì—ˆìŠµë‹ˆë‹¤.
    

---

## 4ï¸âƒ£ Helm values í•µì‹¬

### values/base.yaml

- ì´ë¯¸ì§€: `nvcr.io/nvidia/tritonserver:24.08-py3`
- í¬íŠ¸
    - HTTP: 8000 / gRPC: 8001 / Metrics: 8002
- ë¦¬ì†ŒìŠ¤ (CPU-only)
- NFS PVCë¥¼ `/models`ë¡œ ë§ˆìš´íŠ¸
- GPU í™•ìž¥ í¬ì¸íŠ¸ëŠ” flagë§Œ ë‘ê³  ì´ë²ˆì—ëŠ” falseë¡œ CPU ì‚¬ìš© 
(* ì‹¤ìŠµ í™˜ê²½ í˜¸ìŠ¤íŠ¸ PC ë‚´ìž¥ GPU ì‚¬ìš© ì œí•œ)

### values/dev.yaml / values/prod.yaml

- `global.env`ë¥¼ `dev/prod`ë¡œ ë¶„ë¦¬
- `monitoring.releaseLabel`ì„ ê° í™˜ê²½ë³„ë¡œ ì§€ì •
    - dev â†’ `monitoring-dev`
    - prod â†’ `monitoring-prod`

---

## 5ï¸âƒ£ Kubernetes ë¦¬ì†ŒìŠ¤ í•µì‹¬ (Service / ServiceMonitor)

### 5-1) Service.yaml í•µì‹¬

- Serviceì— `app`, `env`, `release` ë¼ë²¨ì„ ë¶€ì—¬
- ServiceMonitorê°€ ì´ ë¼ë²¨ì„ ê¸°ì¤€ìœ¼ë¡œ ëŒ€ìƒ ë°œê²¬

> Serviceê°€ metrics í¬íŠ¸ë¥¼ ë…¸ì¶œí•´ì•¼ ServiceMonitorê°€ ë¶™ìŠµë‹ˆë‹¤.
> 

### 5-2) ServiceMonitor.yaml í•µì‹¬

- Prometheusì˜ `serviceMonitorSelector.matchLabels.release`ì™€ ë§žì¶°ì•¼ í•¨
- `namespaceSelector.matchNames: [ Release.Namespace ]`ë¡œ
    
    dev/prometheusê°€ dev namespace ì•ˆì˜ ì„œë¹„ìŠ¤ë§Œ ê¸ê²Œ ê³ ì •
    

---

## 6ï¸âƒ£ Model Repository (NFS, RWX)

### NFS ìµœì¢… êµ¬ì¡°

```
/mnt/nfs_share/mlops/triton/model-repo/
â”œâ”€â”€ dev/
â”‚â””â”€â”€ simple_model/
â”‚â”œâ”€â”€ config.pbtxt
â”‚â””â”€â”€1/
â”‚â””â”€â”€ model.onnx
â””â”€â”€ prod/
â””â”€â”€ simple_model/
â”œâ”€â”€ config.pbtxt
â””â”€â”€1/
â””â”€â”€ model.onnx

```

- PV/PVCëŠ” dev/prod ê°ê° ë‹¤ë¥¸ pathë¡œ ë¶„ë¦¬
- PVCëŠ” namespace ì•ˆì—ì„œ ë™ì¼ ì´ë¦„(`triton-model-repo-pvc`)ì„ ì‚¬ìš©í•´ë„ ë˜ê²Œ ì„¤ê³„ (namespaceê°€ ê²©ë¦¬)

---

## 7ï¸âƒ£ ëª¨ë¸ ì¤€ë¹„ (ONNX)

### STEP 1) ONNX export (k8s-master)

- ì²˜ìŒì—” `onnxscript`ê°€ ì—†ì–´ export ì‹¤íŒ¨ â†’ ì„¤ì¹˜ í›„ í•´ê²°
- opset downgrade ê²½ê³ /ì‹¤íŒ¨ê°€ ìžˆì—ˆì§€ë§Œ ê²°ê³¼ë¬¼ ìƒì„±ì€ ë¨
- ìµœì¢…ì ìœ¼ë¡œ **opset 18**ë¡œ ê³ ì •í•˜ëŠ” íŽ¸ì´ ì•ˆì „í–ˆìŒ

### STEP 2) íŒŒì¼ ì „ë‹¬

- ëž© íŽ¸ì˜ìƒ: k8s-master â†’ Windows(MobaXterm) â†’ NFS ì„œë²„ ì—…ë¡œë“œ
- (ëŒ€ì•ˆ: NFS mount / initContainerë¡œ ìžë™ ë™ê¸°í™” ê°€ëŠ¥)

### STEP 3) config.pbtxtì—ì„œ shape mismatch ì´ìŠˆ

- ì‹¤ì œ ONNX input shape: `[1,4]`
- config.pbtxtì— `[4]`ë¡œ ì ìœ¼ë©´ load ì‹¤íŒ¨
    
    â†’ Tritonì´ ì•„ì£¼ ì—„ê²©í•˜ê²Œ ê²€ì‚¬
    

---

## 8ï¸âƒ£ ëª¨ë¸ ë¡œë“œ/ìƒíƒœ/ì¶”ë¡  ê²€ì¦

### 8-1) Load + Status + Ready í™•ì¸

- `POST /v2/repository/models/simple_model/load`
- `GET /v2/models/simple_model`
- `GET /v2/health/ready`

ì„±ê³µ ì‹œ:

- statusì—ì„œ inputs/outputs shape í™•ì¸ ê°€ëŠ¥
- ready 200 OK

### 8-2) Infer ìš”ì²­

- `POST /v2/models/simple_model/infer`
- JSON ìž…ë ¥ shape `[1,4]`ë¡œ ìš”ì²­ â†’ ì •ìƒ ì‘ë‹µ

> ì´ ì‹œì ì—ì„œ â€œì„œë¹™ ìžì²´ëŠ” ì™„ì„±â€ìž…ë‹ˆë‹¤.
> 

---

## 9ï¸âƒ£ /metrics í™•ì¸ (í•µì‹¬ ì¦ëª…)

ì²˜ìŒ `/metrics`ì—ëŠ” CPU ê´€ë ¨ ìµœì†Œ ì§€í‘œë§Œ ë³´ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

**inferë¥¼ 1~2ë²ˆì´ë¼ë„ ìˆ˜í–‰í•˜ë©´** ì•„ëž˜ê°€ ë“±ìž¥í•©ë‹ˆë‹¤:

- `nv_inference_request_success`
- `nv_inference_request_duration_us`
- `nv_inference_queue_duration_us`
- `nv_inference_count`

ì¦‰,

> ì‹¤ì œë¡œ inferë¥¼ ìˆê³ , Tritonì´ ê·¸ ì‚¬ì‹¤ì„ ë©”íŠ¸ë¦­ìœ¼ë¡œ ë‚¨ê¹ë‹ˆë‹¤.
> 

---

## ðŸ”Ÿ Grafana ëŒ€ì‹œë³´ë“œ (JSON Import)

Grafanaì—ì„œ Dashboard â†’ Import â†’ JSON ë¶™ì—¬ë„£ê¸°

- ë³€ìˆ˜: datasource / namespace / model
- í•µì‹¬ 5íŒ¨ë„: RPS / Avg Latency / Avg Queue / CPU / Total Count

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸ (êµ¬ì¶• ì™„ë£Œ ê¸°ì¤€)

- [ ]  `triton-dev`, `triton-prod` Pod Running
- [ ]  `/v2/health/ready` â†’ 200 OK
- [ ]  `simple_model` load ì„±ê³µ
- [ ]  infer ê²°ê³¼ ë°˜í™˜
- [ ]  `/metrics`ì—ì„œ `nv_inference_*` í™•ì¸
- [ ]  Prometheus targetsì—ì„œ triton ìŠ¤í¬ëž© í™•ì¸
- [ ]  Grafana íŒ¨ë„ í™•ì¸

---

# ðŸ§© íŒ

- **ì´ˆê¸°ì—” inference ë©”íŠ¸ë¦­ì´ ì•ˆ ë³´ì´ëŠ” ê²Œ ì •ìƒ**ìž…ë‹ˆë‹¤. (inferë¥¼ í•œ ë²ˆì´ë¼ë„ ì´ì•¼ ìƒê¹€)
- `ServiceMonitorSelector`ëŠ” ê²°êµ­ **release ë¼ë²¨ ë§¤ì¹­** ìž…ë‹ˆë‹¤.
    
    Prometheus ìª½ selectorì™€ ServiceMonitor labelsê°€ 1:1ë¡œ ë§žì•„ì•¼ í•©ë‹ˆë‹¤.
    
- Tritonì€ config.pbtxtì˜ shape/dimsë¥¼ ì•„ì£¼ ì—„ê²©í•˜ê²Œ ë´…ë‹ˆë‹¤.
    
    **ONNX input shape â†” config dims ë¶ˆì¼ì¹˜**ëŠ” ê°€ìž¥ í”í•œ í•¨ì •ìž…ë‹ˆë‹¤.
    

---

## ðŸ ì •ë¦¬

> Triton Inference Serverë¥¼ dev/prodë¡œ ë¶„ë¦¬í•œ GitOps êµ¬ì¡°ë¡œ ë°°í¬í–ˆê³ ,
> 
> 
> ONNX ëª¨ë¸ 1ê°œë¥¼ **explicit load â†’ infer**ê¹Œì§€ ì„±ê³µì‹œí‚¨ ë’¤,
> 
> `/metrics`ì˜ **nv_inference_*** ì§€í‘œê°€ ì‹¤ì œ ìš”ì²­ì— ë°˜ì‘í•´ ì¦ê°€í•˜ëŠ” ê²ƒê¹Œì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
> 
> ì¦‰, ì„œë¹™ í”Œëž«í¼ì— ëŒ€í•´ ë°°í¬/ìš´ì˜/ê´€ì¸¡ ê´€ì ì—ì„œ ì •ìƒ ë™ìž‘ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
>
