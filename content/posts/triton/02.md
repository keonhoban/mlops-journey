+++
date = '2025-12-29T12:02:22+09:00'
draft = false
title = '[Triton ìš´ì˜í˜• ì„œë¹™ í”Œë«í¼ (GitOps Â· ê²€ì¦ Â· Alerting) - MLflow â†’ Triton ìë™ ë°°í¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•]'
categories = ['Triton', 'GitOps(ArgoCD)', 'Helm', 'Kubernetes', 'Grafana', 'ONNX', 'NFS', 'MLflow', 'Prometheus', 'Monitoring Stack']
+++

### Airflow ê¸°ë°˜ Â· ê²€ì¦ ì²´ì¸ Â· ìµœì†Œ ë¡¤ë°±

---

## ğŸ§  ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…

> ì‹¤ë¬´ í™˜ê²½ì—ì„œ ëª¨ë¸ ë°°í¬ëŠ”
> 
> 
> â€œìƒˆ ëª¨ë¸ì„ ì˜¬ë¦¬ëŠ” ì‘ì—…â€ì´ ì•„ë‹ˆë¼
> 
> â€œí˜„ì¬ ìš´ì˜ ìƒíƒœë¥¼ ì•ˆì „í•˜ê²Œ ê°±ì‹ í•˜ëŠ” ìƒíƒœ ì „ì´(State Transition)â€ì— ê°€ê¹ìŠµë‹ˆë‹¤.
> 
> ì´ë²ˆ ë‹¨ê³„ì—ì„œëŠ” MLflow Registryë¥¼ ë‹¨ì¼ ì†ŒìŠ¤ë¡œ ì‚¼ì•„
> 
> Triton Inference Serverì— ëª¨ë¸ì„ **ìë™ ë°°í¬**í•˜ê³ ,
> 
> - ë¡œë”©
> - í—¬ìŠ¤ ì²´í¬
> - ì‹¤ì œ ì¶”ë¡  ê²€ì¦
> 
> ì„ ëª¨ë‘ í†µê³¼í•œ ê²½ìš°ì—ë§Œ ìš´ì˜ ëª¨ë¸ì„ í™•ì •(commit)í•˜ë©°,
> 
> ì¤‘ê°„ ë‹¨ê³„ì—ì„œ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´
> 
> **ì´ì „ ìš´ì˜ ìƒíƒœë¡œ ìë™ ë³µêµ¬ë˜ëŠ” ìµœì†Œ ë¡¤ë°± êµ¬ì¡°**ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
> 
> ì´ ëª¨ë“  íë¦„ì€ Airflow DAGë¥¼ í†µí•´
> 
> **ë°°í¬ â†’ ê²€ì¦ â†’ í™•ì •** ë‹¨ê³„ê°€ ëª…ì‹œì ìœ¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
> 

---

## ğŸ¯ í•µì‹¬ ëª©í‘œ ìš”ì•½

- MLflow Registryì— ë“±ë¡ëœ ëª¨ë¸ì„ **alias ê¸°ì¤€**ìœ¼ë¡œ ì„ íƒ
- Airflow DAGë¡œ **ë°°í¬ â†’ ê²€ì¦ â†’ í™•ì •(commit)** íë¦„ ê°•ì œ
- ê²€ì¦ ì‹¤íŒ¨ ì‹œ **ì´ì „ ìš´ì˜ ìƒíƒœë¡œ ìë™ ë³µêµ¬**
- Triton inference latencyë¥¼ Prometheus/Grafanaë¡œ ê´€ì¸¡

---

## 1ï¸âƒ£ ì „ì²´ ì•„í‚¤í…ì²˜ ìš”ì•½ (íŒŒì¼ Â· ì±…ì„ ë‹¨ìœ„)

### 1) Airflow DAG ë ˆí¬ êµ¬ì¡°

```
airflow-dags-dev/
â””â”€ dags/
   â”œâ”€ dag_mlflow_to_triton_deploy_dev.py
   â”‚   â””â”€ ë°°í¬ íë¦„ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜/ ë¡¤ë°± íŠ¸ë¦¬ê±°
   â””â”€ ml_code/
      â”œâ”€ train_model.py
      â”‚   â””â”€ (ì´ì „ ë‹¨ê³„) í•™ìŠµ+ MLflow logging+ ONNX artifact ìƒì„±
      â””â”€ triton_deploy.py
          â””â”€ ë°°í¬/ ê²€ì¦/commit/rollback ë¡œì§ ì§‘ì•½

```

---

### 2) Triton Model Repository êµ¬ì¡° (NFS, RWX)

```
/model-repo/dev/
â””â”€ best_model/
   â”œâ”€ config.pbtxt
   â”œâ”€ current.json
   â”œâ”€12/
   â”‚  â””â”€ model.onnx
   â”œâ”€13/
   â”‚  â””â”€ model.onnx
   â””â”€13.failed_20251231T...

```

**ì„¤ê³„ ì˜ë„**

- `current.json`
    - í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ëª¨ë¸ ë²„ì „ì„ ì •ì˜í•˜ëŠ” **ë‹¨ì¼ ì§„ì‹¤(Single Source of Truth)**
    - FastAPI, ìš´ì˜ íŒë‹¨, ë¡¤ë°± ê¸°ì¤€ì´ ëª¨ë‘ ì´ íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘
- ì‹¤íŒ¨í•œ ë²„ì „ì€ **ì‚­ì œí•˜ì§€ ì•Šê³  ê²©ë¦¬**
    - ì›ì¸ ë¶„ì„ ë° ì¬í˜„ ê°€ëŠ¥ì„± ìœ ì§€

---

## 2ï¸âƒ£ ì „ì²´ ì‹¤í–‰ íë¦„ (ìƒíƒœ ì „ì´ ê¸°ì¤€)

Tritonì„ ì„ íƒí•œ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- ëª¨ë¸ ë¡œë”©ì„ **ëª…ì‹œì ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥**
- ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ **ê¸°ì¡´ ëª¨ë¸ ìœ ì§€**
- ë°°í¬ ì‹¤íŒ¨ê°€ ê³§ë°”ë¡œ ì„œë¹„ìŠ¤ ì¥ì• ë¡œ ì´ì–´ì§€ì§€ ì•ŠìŒ

### ì‹¤í–‰ íë¦„

```
[Trigger]
Airflow UIì—ì„œ DAG ìˆ˜ë™ ì‹¤í–‰ (params.alias = "A")

DAG: dag_mlflow_to_triton_deploy_dev.py
  1) snapshot_current()        - ê¸°ì¡´ current.json ìŠ¤ëƒ…ìƒ·
  2) materialize()             - MLflow â†’ ONNX â†’ model-repo ë°°ì¹˜
  3) triton_load()             - Triton explicit load
  4) triton_ready()            - ready endpoint ê²€ì¦
  5) triton_infer_smoke()      - ìƒ˜í”Œ ì¶”ë¡  smoke test
  6) commit_current()          - ì„±ê³µ ì‹œ ìš´ì˜ ê¸°ì¤€ í™•ì •
  
  X) rollback_minimal()        - ì¤‘ê°„ ì‹¤íŒ¨ ì‹œ ìë™ ë³µêµ¬

```

---

## 3ï¸âƒ£ DAG ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í•µì‹¬

```python
with DAG(
    dag_id="mlflow_to_triton_min_dev",
    schedule=None,
    params={"alias":"A"},
)as dag:

    t0 = PythonOperator(
        task_id="snapshot_current",
        python_callable=snapshot_current,
    )

    t1 = PythonOperator(
        task_id="materialize_repo",
        python_callable=materialize,
        op_kwargs={"alias":"{{ params.alias }}"},
    )

    t2 = PythonOperator(
        task_id="triton_load",
        python_callable=triton_load,
    )

    t_ready = PythonOperator(
        task_id="triton_ready",
        python_callable=triton_ready,
    )

    t_smoke = PythonOperator(
        task_id="triton_infer_smoke",
        python_callable=triton_infer_smoke,
    )

    t3 = PythonOperator(
        task_id="commit_current",
        python_callable=commit_current,
    )

    t_rb = PythonOperator(
        task_id="rollback_minimal",
        python_callable=rollback_minimal,
        trigger_rule=TriggerRule.ONE_FAILED,
    )

    t0 >> t1 >> t2 >> t_ready >> t_smoke >> t3
    [t1, t2, t_ready, t_smoke] >> t_rb

```

**ì„¤ê³„ í¬ì¸íŠ¸**

- rollback taskëŠ” **ê²€ì¦ ì²´ì¸ ì–´ë””ì„œë“  ì‹¤íŒ¨ ì‹œ ì‹¤í–‰**
- commitì€ **ëª¨ë“  ê²€ì¦ ì„±ê³µ ì´í›„ì—ë§Œ í—ˆìš©**
- rollbackì˜ ëª©ì ì€ ì›ì¸ ë¶„ì„ì´ ì•„ë‹ˆë¼ **ìš´ì˜ ìƒíƒœ ë³´í˜¸**

---

## 4ï¸âƒ£ MLflow â†’ Triton Materialize ë‹¨ê³„

```python
def materialize(ti, alias: str ="A", **_):
    v, run_id = select_by_alias(model, alias)

    ver_dir = os.path.join(model_dir,str(v))
    os.makedirs(ver_dir, exist_ok=True)

    local = mlflow.artifacts.download_artifacts(
        artifact_uri=f"runs:/{run_id}/onnx/model.onnx"
    )
    shutil.copyfile(local, os.path.join(ver_dir,"model.onnx"))

with open(os.path.join(model_dir,"config.pbtxt"),"w")as f:
    f.write(CONFIG_TEMPLATE.format(model=model))

```

**ì´ë ‡ê²Œ ì„¤ê³„í•œ ì´ìœ **

- `config.pbtxt`ë¥¼ ë²„ì „ë³„ë¡œ ë‘ë©´
    - ë²„ì „ ì „í™˜ ì‹œ ì„¤ì • ë¶ˆì¼ì¹˜ ìœ„í—˜ ì¦ê°€
- model root ë‹¨ì¼ configë¡œ
    - **ìš´ì˜ ì•ˆì •ì„±**ê³¼ **ì˜ˆì¸¡ ê°€ëŠ¥ì„±** í™•ë³´

---

## 5ï¸âƒ£ ë°°í¬ ê²€ì¦ ë‹¨ê³„

### 1) Ready Check

```
GET /v2/models/{model}/ready

```

- Triton ë‚´ë¶€ ë¡œë”© ìƒíƒœ ê²€ì¦

---

### 2) Smoke Inference

```
POST /v2/models/{model}/infer

```

- ì‹¤ì œ ì…ë ¥ìœ¼ë¡œ **ì¶”ë¡  ê°€ëŠ¥ ì—¬ë¶€ê¹Œì§€ ê²€ì¦**
- â€œë¡œë“œ ì„±ê³µ but ì¶”ë¡  ì‹¤íŒ¨â€ ì¼€ì´ìŠ¤ ì°¨ë‹¨

---

### 3) Commit (ìš´ì˜ í™•ì •)

```json
{
"active_version":13,
"run_id":"...",
"alias":"A",
"updated_at_utc":"20251231T025902"
}

```

- ì´ íŒŒì¼ì´ **í˜„ì¬ ìš´ì˜ ëª¨ë¸ì˜ ë‹¨ì¼ ê¸°ì¤€**
- ì‚¬ëŒì´ ì•„ë‹ˆë¼ **ì‹œìŠ¤í…œì´ í•´ì„ ê°€ëŠ¥í•œ ìš´ì˜ ìƒíƒœ**

---

## 6ï¸âƒ£ ìµœì†Œ ë¡¤ë°±(minimal rollback) ì „ëµ

```python
defrollback_minimal(ti, **_):
# 1) current.json ë³µêµ¬
# 2) ì‹¤íŒ¨í•œ ë²„ì „ ë””ë ‰í„°ë¦¬ ê²©ë¦¬
# 3) Triton unload â†’ load (best-effort)

```

**ì™œ ìµœì†Œ ë¡¤ë°±ì¸ê°€**

- Tritonì€ load ì‹¤íŒ¨ ì‹œ **ê¸°ì¡´ ëª¨ë¸ ìë™ ìœ ì§€**
- í•µì‹¬ì€:
    - ìš´ì˜ ê¸°ì¤€ ë³µêµ¬
    - ì‹¤íŒ¨ ê²°ê³¼ë¥¼ ë‹¤ìŒ ì‹œë„ì— **ì˜í–¥ ì£¼ì§€ ì•Šê²Œ ì •ë¦¬**

ë¶ˆí•„ìš”í•œ ë³µì¡ë„ ì—†ì´ **ì•ˆì •ì„±ì„ í™•ë³´í•˜ëŠ” êµ¬ì¡°**ì…ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ONNX ì¶œë ¥ shape ë³€ê²½ìœ¼ë¡œ smoke inferenceê°€ ì‹¤íŒ¨í•  ê²½ìš°,

í•´ë‹¹ ë²„ì „ì€ `.failed_*` ë¡œ ê²©ë¦¬ë˜ê³  ìš´ì˜ ê¸°ì¤€ì€ ì´ì „ ìƒíƒœë¡œ ìë™ ë³µêµ¬ë©ë‹ˆë‹¤.

---

## 7ï¸âƒ£ Observability: Inference Latency

### Triton Metrics ì˜ˆì‹œ

```
nv_inference_request_duration_us
nv_inference_compute_infer_duration_us
nv_inference_queue_duration_us

```

- Prometheusê°€ `/metrics` ìˆ˜ì§‘
- Grafanaì—ì„œ:
    - p95 latency
    - request count
    - ì‹¤íŒ¨ìœ¨ ì¶”ì´ ê´€ì¸¡

ì´ ë‹¨ê³„ì—ì„œëŠ” ì •í™•ë„ë³´ë‹¤

**ìš´ì˜ ì´ìƒì„ ê°€ì¥ ë¨¼ì € ê°ì§€í•  ìˆ˜ ìˆëŠ” ì§€í‘œ**ë¡œ

latencyë¥¼ í•µì‹¬ ê´€ì¸¡ ëŒ€ìƒìœ¼ë¡œ ì‚¼ì•˜ìŠµë‹ˆë‹¤.

---

## ğŸ§  ì´ë²ˆ ë‹¨ê³„ì—ì„œ í™•ë³´ëœ ê°œë…

- **Trigger**
    
    Airflow DAG ìˆ˜ë™ ì‹¤í–‰ (alias ê¸°ë°˜)
    
- **Source of Truth**
    
    MLflow Registry â†’ ë°°í¬ í™•ì •ì€ `current.json`
    
- **Sync ë°©ì‹**
    
    MLflow artifact â†’ íŒŒì¼ ë°°ì¹˜ â†’ Triton explicit load
    
- **Rollback ì¡°ê±´**
    
    load / ready / infer ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨
    
- **Observability**
    
    Triton inference latency (p95) + ì‹¤íŒ¨ìœ¨
    

---

## ğŸ ì •ë¦¬

ì´ë²ˆ ë‹¨ê³„ì˜ í•µì‹¬ì€

â€œëª¨ë¸ì„ ìë™ìœ¼ë¡œ ì˜¬ë ¸ë‹¤â€ê°€ ì•„ë‹ˆë¼,

- ìš´ì˜ ê¸°ì¤€ì´ ëª…í™•í•˜ê³ 
- ì‹¤íŒ¨í•´ë„ ìë™ ë³µêµ¬ë˜ë©°
- ì§€í‘œë¡œ ìƒíƒœë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆëŠ”

**ì‹¤ì œ ìš´ì˜ ê°€ëŠ¥í•œ ML ì„œë¹™ ë°°í¬ íŒŒì´í”„ë¼ì¸**ì„

ì™„ì„±í–ˆë‹¤ëŠ” ì ì…ë‹ˆë‹¤.
